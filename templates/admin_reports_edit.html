{% extends "base.html" %}
{% block title %}å ±å‘Šæ›¸ç·¨é›† | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">âœ å ±å‘Šæ›¸ç·¨é›†</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<form method="POST" action="/admin/reports/{{ report.id }}/edit" style="max-width: 1400px;">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div style="margin-bottom: 24px; padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ç¾å ´åï¼ˆå¿…é ˆï¼‰</label>
        <input type="text" name="field_name" value="{{ report.field_name }}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ—¥ä»˜ï¼ˆå¿…é ˆï¼‰</label>
        <input type="date" name="report_date" value="{{ report.report_date }}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">å ´æ‰€</label>
        <input type="text" name="place" value="{{ report.place or '' }}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">é–‹å§‹æ™‚é–“</label>
          <input type="time" name="start_time" value="{{ report.start_time or '07:00' }}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">çµ‚äº†æ™‚é–“</label>
          <input type="time" name="end_time" value="{{ report.end_time or '22:00' }}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        </div>
      </div>
    </div>
    
    <div style="margin-bottom: 16px;">
      <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">å¯¾å¿œã‚¹ã‚¿ãƒƒãƒ•ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div style="display: flex; flex-wrap: wrap; gap: 12px;">
        {% for staff in staff_list %}
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="staff_names" value="{{ staff.name }}" {% if report.staff_names and staff.name in report.staff_names %}checked{% endif %}>
          <span>{{ staff.name }}</span>
        </label>
        {% endfor %}
      </div>
    </div>
    
    <div style="padding: 12px; background: #f0f7ff; border-radius: 8px; border: 1px solid #b3d9ff; margin-bottom: 16px;">
      <p style="margin: 0; font-size: 0.9rem; color: #1E3A5F;">
        <strong>åˆ—æ•°ã«ã¤ã„ã¦ï¼š</strong><br>
        å¯¾å¿œã‚¹ã‚¿ãƒƒãƒ•ã®äººæ•°ã«å¿œã˜ã¦è‡ªå‹•çš„ã«åˆ—æ•°ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚<br>
        1åã®å ´åˆã¯2åˆ—ï¼ˆã‚¹ã‚¿ãƒƒãƒ•åãƒ»æ–½è¡“å†…å®¹ï¼‰ã€2åä»¥ä¸Šã®å ´åˆã¯ã‚¹ã‚¿ãƒƒãƒ•åã®åˆ—ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
      </p>
    </div>
  </div>
  
  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
    <!-- å·¦å´ï¼šæ™‚é–“è»¸è¡¨ -->
    <div style="padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
      <h3 style="margin: 0 0 16px 0; font-size: 1.1rem; font-weight: 600; color: #1E3A5F; text-align: center; padding: 12px; background: #1E3A5F; color: #fff; border-radius: 8px;">
        <span style="display: inline-block; width: 50%;">Time</span>
        <span style="display: inline-block; width: 50%;">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span>
      </h3>
      
      <div style="overflow: visible;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f5f7fb;">
              <th style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: 600; color: #1E3A5F; width: 80px;">æ™‚é–“</th>
              {% if report.staff_names|length == 1 %}
                <th style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: 600; color: #1E3A5F; border-left: 2px solid #1E3A5F;">{{ report.staff_names[0] }}</th>
                <th style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: 600; color: #1E3A5F;">æ–½è¡“å†…å®¹</th>
              {% else %}
                {% for staff_name in (report.staff_names or []) %}
                <th style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: 600; color: #1E3A5F; {% if loop.index == 1 %}border-left: 2px solid #1E3A5F;{% endif %}">{{ staff_name }}</th>
                {% endfor %}
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% if report.staff_names|length == 1 %}
              {% set actual_column_count = 2 %}
            {% else %}
              {% set actual_column_count = report.staff_names|length %}
            {% endif %}
            {% set current_hour = None %}
            {% for time_range in time_ranges %}
              {% if time_range.minute == 0 %}
                {% if current_hour != time_range.hour %}
                  {% set current_hour = time_range.hour %}
                  {% if not loop.first %}
            </tr>
                  {% endif %}
            <tr>
              <td rowspan="2" style="padding: 8px; text-align: center; border: 1px solid #ddd; background: #f5f7fb; font-weight: 600; color: #1E3A5F; vertical-align: middle; width: 80px;">{{ time_range.hour }}</td>
                {% endif %}
              {% endif %}
              {% for col_idx in range(actual_column_count) %}
                {% set slot_key = f"{time_range.hour}_{time_range.minute:02d}_{col_idx}" %}
                {% set slot_content = time_slots_map.get(slot_key, '') %}
                {% if time_range.minute == 0 %}
              <td style="padding: 4px; border: 1px solid #ddd; border-bottom: 2px dashed #999; background: #e3f2fd; height: 40px; {% if col_idx == 0 %}border-left: 2px solid #1E3A5F;{% endif %}">
                <textarea name="time_slot_{{ time_range.hour }}_{{ time_range.minute:02d }}_{{ col_idx }}" rows="2" style="width: 100%; border: none; background: transparent; resize: none; font-size: 0.85rem; padding: 4px; box-sizing: border-box; height: 100%;">{{ slot_content }}</textarea>
              </td>
                {% else %}
                  {% if loop.first %}
            <tr>
                  {% endif %}
              <td style="padding: 4px; border: 1px solid #ddd; border-top: 2px dashed #999; background: #e3f2fd; height: 40px; {% if col_idx == 0 %}border-left: 2px solid #1E3A5F;{% endif %}">
                <textarea name="time_slot_{{ time_range.hour }}_{{ time_range.minute:02d }}_{{ col_idx }}" rows="2" style="width: 100%; border: none; background: transparent; resize: none; font-size: 0.85rem; padding: 4px; box-sizing: border-box; height: 100%;">{{ slot_content }}</textarea>
              </td>
                {% endif %}
              {% endfor %}
              {% if time_range.minute == 30 %}
            </tr>
              {% endif %}
            {% endfor %}
            {% if time_ranges and time_ranges[-1].minute == 0 %}
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- å³å´ï¼šå¯¾å¿œè€…æƒ…å ±ï¼ˆæ‚£è€…æƒ…å ±ï¼‰ -->
    <div style="padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
      <h3 style="margin: 0 0 16px 0; font-size: 1.1rem; font-weight: 600; color: #1E3A5F;">å¯¾å¿œè€…æƒ…å ±</h3>
      <div style="display: flex; flex-direction: column; gap: 16px; max-height: 600px; overflow-y: auto;">
        {% for staff_name in (report.staff_names or []) %}
        {% set staff_detail = None %}
        {% for detail in staff_details %}
          {% if detail.staff_name == staff_name %}
            {% set staff_detail = detail %}
          {% endif %}
        {% endfor %}
        <div style="padding: 16px; background: #f5f7fb; border-radius: 12px; border-left: 4px solid #1E3A5F;">
          <h4 style="margin: 0 0 12px 0; font-size: 1rem; font-weight: 600; color: #1E3A5F;">{{ staff_detail.patient_name if staff_detail and staff_detail.patient_name else 'ï¼ˆæ‚£è€…åæœªå–å¾—ï¼‰' }}</h4>
          <div style="padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; color: #333; white-space: pre-wrap; min-height: 60px;">
            {% if staff_detail and staff_detail.status %}
            {{ staff_detail.status }}
            {% if staff_detail.treatment_content %}

            {{ staff_detail.treatment_content }}
            {% endif %}
            {% elif staff_detail and staff_detail.treatment_content %}
            {{ staff_detail.treatment_content }}
            {% else %}
            ï¼ˆå†…å®¹ãªã—ï¼‰
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  
  <!-- ç‰¹è¨˜äº‹é … -->
  <div style="margin-bottom: 24px; padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #1E3A5F; font-size: 1.1rem;">ç‰¹è¨˜äº‹é …</label>
    <textarea name="special_notes" rows="6" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; resize: vertical;">{{ report.special_notes or '' }}</textarea>
  </div>
  
  <div style="display: flex; gap: 12px; margin-top: 30px;">
    <button type="submit" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer;">ğŸ’¾ ä¿å­˜</button>
    <a href="/admin/reports" class="admin-karte-detail-btn-back" style="text-decoration: none; display: inline-block; text-align: center;">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
  </div>
</form>

{% endblock %}

