{% extends "base.html" %}
{% block title %}æ—¥å ±ä¸€è¦§ | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">ğŸ“ KARiN.æ—¥å ±</h2>

<!-- Flashãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<!-- æ—¥ä»˜é¸æŠ -->
<div style="margin-bottom: 20px; padding: 16px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
  {% if year and month %}
  <div style="margin-bottom: 12px;">
    <h3 style="margin: 0 0 12px 0; font-size: 1.1rem; font-weight: 600; color: #1E3A5F;">{{ year }}å¹´{{ month_name }} - æ—¥ä»˜é¸æŠ</h3>
    {% if month_dates %}
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
      {% for date in month_dates %}
      <a href="/admin/daily-reports?year={{ year }}&month={{ month }}&date={{ date }}" 
         style="padding: 8px 16px; background: {% if date == selected_date %}#1E3A5F{% else %}#f5f7fb{% endif %}; color: {% if date == selected_date %}#fff{% else %}#1E3A5F{% endif %}; border: 1px solid {% if date == selected_date %}#1E3A5F{% else %}#ddd{% endif %}; border-radius: 8px; text-decoration: none; font-weight: {% if date == selected_date %}600{% else %}500{% endif %}; font-size: 0.9rem; transition: all 0.2s;">
        {{ date[8:10] }}æ—¥
      </a>
      {% endfor %}
    </div>
    {% else %}
    <p style="color: #999; font-size: 0.9rem;">ã“ã®æœˆã®æ—¥å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>
    {% endif %}
  </div>
  {% endif %}
  <form method="GET" action="/admin/daily-reports" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
    <label style="display: flex; align-items: center; gap: 8px;">
      <span style="font-weight: 500; color: #1E3A5F;">æ—¥ä»˜ï¼š</span>
      <input type="date" name="date" value="{{ selected_date }}" required style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem;">
      {% if year and month %}
      <input type="hidden" name="year" value="{{ year }}">
      <input type="hidden" name="month" value="{{ month }}">
      {% endif %}
    </label>
    <button type="submit" style="padding: 8px 16px; background: #1E3A5F; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">è¡¨ç¤º</button>
    <a href="/admin/daily-reports?date={{ selected_date }}" style="padding: 8px 16px; background: #999; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 500;">ä»Šæ—¥</a>
    {% if year %}
    <a href="/admin/daily-reports/years/{{ year }}" style="padding: 8px 16px; background: #666; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 500;">â† {{ year }}å¹´ã«æˆ»ã‚‹</a>
    {% endif %}
  </form>
</div>

<!-- æ—¥å ±è¡¨ç¤º -->
<div style="display: flex; flex-direction: column; gap: 24px; max-width: 1200px; margin: 0 auto;">
  
  <!-- ğŸ¥ é™¢å†…ã‚«ãƒ¼ãƒ‰ -->
  {% if in_house_items %}
  <div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
    <h3 style="margin: 0 0 20px 0; font-size: 1.3rem; font-weight: 600; color: #1E3A5F; display: flex; align-items: center; gap: 8px;">
      ğŸ¥ é™¢å†…
    </h3>
    
    <div style="display: flex; flex-direction: column; gap: 16px;">
      {% for item in in_house_items %}
      <div class="work-item-card" data-item-id="{{ item.id }}" style="padding: 16px; background: #f5f7fb; border-radius: 12px; border-left: 4px solid #1E3A5F;" 
           data-work-type="{{ item.work_type or 'in_house' }}"
           data-start-time="{{ item.start_time or '' }}" 
           data-end-time="{{ item.end_time or '' }}" 
           data-break-minutes="{{ item.break_minutes or 0 }}" 
           data-session-count="{{ item.session_count or '' }}" 
           data-nomination-type="{{ item.nomination_type or '' }}" 
           data-memo="{{ item.memo or '' }}"
           data-patients="{{ item.patients | tojson | safe }}">
        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 16px; align-items: start;">
          <!-- é–‹å§‹æ™‚é–“ -->
          <div style="font-size: 1rem; font-weight: 600; color: #1E3A5F; min-width: 80px;">
            {{ item.start_time_display or 'æ™‚é–“æœªè¨­å®š' }}
          </div>
          
          <!-- ãƒ¡ã‚¤ãƒ³æƒ…å ± -->
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <!-- æ‚£è€…åï¼ˆVIPãƒ•ãƒ©ã‚°ä»˜ãï¼‰ -->
            {% if item.patients %}
              {% for patient in item.patients %}
              <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <span style="font-weight: 500; color: #1E3A5F;">
                  {% if patient.patient_id %}
                  <a href="/admin/karte/{{ patient.patient_id }}" style="color: #1E3A5F; text-decoration: none;">
                    {{ patient.patient_name or 'æ‚£è€…ä¸æ˜' }}
                  </a>
                  {% else %}
                  {{ patient.patient_name or 'æ‚£è€…ä¸æ˜' }}
                  {% endif %}
                  {% if patient.vip_level == 'star' %} â­ï¸{% elif patient.vip_level == 'clover' %} ğŸ€{% endif %}
                </span>
                <!-- ã‚³ãƒ¼ã‚¹å -->
                {% if patient.course_name %}
                <span style="color: #666; font-size: 0.9rem;">{{ patient.course_name }}</span>
                {% endif %}
                <!-- æŒ‡åç¨®åˆ¥ -->
                {% if item.nomination_type %}
                  {% set nom_type = item.nomination_type %}
                  {% if nom_type == 'main' %}{% set nom_type = 'æœ¬æŒ‡å' %}{% endif %}
                  {% if nom_type == 'frame' %}{% set nom_type = 'æ æŒ‡å' %}{% endif %}
                  {% if nom_type == 'hope' %}{% set nom_type = 'å¸Œæœ›' %}{% endif %}
                  {% if nom_type == 'free' %}{% set nom_type = 'ãƒ•ãƒªãƒ¼' %}{% endif %}
                <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; background: #e0e0e0; color: #666;">{{ nom_type }}</span>
                {% endif %}
              </div>
              {% endfor %}
            {% else %}
              <span style="color: #999;">æ‚£è€…æƒ…å ±ãªã—</span>
            {% endif %}
            
            <!-- å¯¾å¿œã‚¹ã‚¿ãƒƒãƒ•å -->
            <div style="font-size: 0.9rem; color: #666;">
              å¯¾å¿œã‚¹ã‚¿ãƒƒãƒ•ï¼š{{ item.staff_name }}
            </div>
            
            <!-- é‡‘é¡ -->
            {% if item.total_amount and item.total_amount > 0 %}
              <div style="font-size: 0.9rem; color: #4CAF50; font-weight: 500;">
                Â¥{{ "{:,}".format(item.total_amount) }}
              </div>
            {% endif %}
            
            <!-- ãƒ¡ãƒ¢ -->
            {% if item.memo %}
            <div style="font-size: 0.85rem; color: #666; padding: 8px; background: #fff; border-radius: 6px; margin-top: 4px;">
              {{ item.memo }}
            </div>
            {% endif %}
          </div>
          
          <!-- ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆæ¨©é™ãƒã‚§ãƒƒã‚¯ï¼‰ -->
          {% if item.can_edit %}
          <div>
            <button type="button" class="edit-item-btn" data-item-id="{{ item.id }}" style="padding: 6px 12px; background: #1E3A5F; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">ç·¨é›†</button>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    
    <!-- å½“æ—¥å°è¨ˆãƒ»å½“æœˆç´¯è¨ˆ -->
    <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid #1E3A5F; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <div style="font-size: 0.9rem; color: #666;">å½“æ—¥å°è¨ˆ</div>
        <div style="font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">Â¥{{ "{:,}".format(in_house_day_total) }}</div>
      </div>
      <div>
        <div style="font-size: 0.9rem; color: #666;">å½“æœˆç´¯è¨ˆ</div>
        <div style="font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">Â¥{{ "{:,}".format(in_house_month_total) }}</div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- ğŸš— å¾€è¨ºã‚«ãƒ¼ãƒ‰ -->
  {% if visit_items %}
  <div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
    <h3 style="margin: 0 0 20px 0; font-size: 1.3rem; font-weight: 600; color: #4CAF50; display: flex; align-items: center; gap: 8px;">
      ğŸš— å¾€è¨º
    </h3>
    
    <div style="display: flex; flex-direction: column; gap: 16px;">
      {% for item in visit_items %}
      <div class="work-item-card" data-item-id="{{ item.id }}" style="padding: 16px; background: #f5f7fb; border-radius: 12px; border-left: 4px solid #4CAF50;" 
           data-work-type="{{ item.work_type or 'visit' }}"
           data-start-time="{{ item.start_time or '' }}" 
           data-end-time="{{ item.end_time or '' }}" 
           data-break-minutes="{{ item.break_minutes or 0 }}" 
           data-session-count="{{ item.session_count or '' }}" 
           data-nomination-type="{{ item.nomination_type or '' }}" 
           data-memo="{{ item.memo or '' }}"
           data-patients="{{ item.patients | tojson | safe }}">
        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 16px; align-items: start;">
          <!-- é–‹å§‹æ™‚é–“ -->
          <div style="font-size: 1rem; font-weight: 600; color: #4CAF50; min-width: 80px;">
            {{ item.start_time_display or 'æ™‚é–“æœªè¨­å®š' }}
          </div>
          
          <!-- ãƒ¡ã‚¤ãƒ³æƒ…å ± -->
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <!-- æ‚£è€…åï¼ˆVIPãƒ•ãƒ©ã‚°ä»˜ãï¼‰ -->
            {% if item.patients %}
              {% for patient in item.patients %}
              <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <span style="font-weight: 500; color: #1E3A5F;">
                  {% if patient.patient_id %}
                  <a href="/admin/karte/{{ patient.patient_id }}" style="color: #1E3A5F; text-decoration: none;">
                    {{ patient.patient_name or 'æ‚£è€…ä¸æ˜' }}
                  </a>
                  {% else %}
                  {{ patient.patient_name or 'æ‚£è€…ä¸æ˜' }}
                  {% endif %}
                  {% if patient.vip_level == 'star' %} â­ï¸{% elif patient.vip_level == 'clover' %} ğŸ€{% endif %}
                </span>
                <!-- ã‚³ãƒ¼ã‚¹å -->
                {% if patient.course_name %}
                <span style="color: #666; font-size: 0.9rem;">{{ patient.course_name }}</span>
                {% endif %}
                <!-- æŒ‡åç¨®åˆ¥ -->
                {% if item.nomination_type %}
                  {% set nom_type = item.nomination_type %}
                  {% if nom_type == 'main' %}{% set nom_type = 'æœ¬æŒ‡å' %}{% endif %}
                  {% if nom_type == 'frame' %}{% set nom_type = 'æ æŒ‡å' %}{% endif %}
                  {% if nom_type == 'hope' %}{% set nom_type = 'å¸Œæœ›' %}{% endif %}
                  {% if nom_type == 'free' %}{% set nom_type = 'ãƒ•ãƒªãƒ¼' %}{% endif %}
                <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; background: #e0e0e0; color: #666;">{{ nom_type }}</span>
                {% endif %}
              </div>
              {% endfor %}
            {% else %}
              <span style="color: #999;">æ‚£è€…æƒ…å ±ãªã—</span>
            {% endif %}
            
            <!-- å¯¾å¿œã‚¹ã‚¿ãƒƒãƒ•å -->
            <div style="font-size: 0.9rem; color: #666;">
              å¯¾å¿œã‚¹ã‚¿ãƒƒãƒ•ï¼š{{ item.staff_name }}
            </div>
            
            <!-- é‡‘é¡ -->
            {% if item.total_amount and item.total_amount > 0 %}
              <div style="font-size: 0.9rem; color: #4CAF50; font-weight: 500;">
                Â¥{{ "{:,}".format(item.total_amount) }}
              </div>
            {% endif %}
            
            <!-- ãƒ¡ãƒ¢ -->
            {% if item.memo %}
            <div style="font-size: 0.85rem; color: #666; padding: 8px; background: #fff; border-radius: 6px; margin-top: 4px;">
              {{ item.memo }}
            </div>
            {% endif %}
          </div>
          
          <!-- ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆæ¨©é™ãƒã‚§ãƒƒã‚¯ï¼‰ -->
          {% if item.can_edit %}
          <div>
            <button type="button" class="edit-item-btn" data-item-id="{{ item.id }}" style="padding: 6px 12px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">ç·¨é›†</button>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    
    <!-- å½“æ—¥å°è¨ˆãƒ»å½“æœˆç´¯è¨ˆ -->
    <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid #4CAF50; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <div style="font-size: 0.9rem; color: #666;">å½“æ—¥å°è¨ˆ</div>
        <div style="font-size: 1.2rem; font-weight: 600; color: #4CAF50;">Â¥{{ "{:,}".format(visit_day_total) }}</div>
      </div>
      <div>
        <div style="font-size: 0.9rem; color: #666;">å½“æœˆç´¯è¨ˆ</div>
        <div style="font-size: 1.2rem; font-weight: 600; color: #4CAF50;">Â¥{{ "{:,}".format(visit_month_total) }}</div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- ğŸ’ å¸¯åŒã‚«ãƒ¼ãƒ‰ï¼ˆadminã®ã¿é–²è¦§å¯èƒ½ï¼‰ -->
  {% if field_items and is_admin %}
  <div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
    <h3 style="margin: 0 0 20px 0; font-size: 1.3rem; font-weight: 600; color: #FFB6C1; display: flex; align-items: center; gap: 8px;">
      ğŸ’ å¸¯åŒ
    </h3>
    
    <div style="display: flex; flex-direction: column; gap: 16px;">
      {% for item in field_items %}
      <div class="work-item-card" data-item-id="{{ item.id }}" style="padding: 16px; background: #f5f7fb; border-radius: 12px; border-left: 4px solid #FFB6C1;" 
           data-work-type="{{ item.work_type or 'field' }}"
           data-start-time="{{ item.start_time or '' }}" 
           data-end-time="{{ item.end_time or '' }}" 
           data-break-minutes="{{ item.break_minutes or 0 }}" 
           data-session-count="{{ item.session_count or '' }}" 
           data-nomination-type="{{ item.nomination_type or '' }}" 
           data-memo="{{ item.memo or '' }}"
           data-patients="{{ item.patients | tojson | safe }}">
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: start;">
          <!-- ãƒ¡ã‚¤ãƒ³æƒ…å ±ï¼ˆå¸¯åŒã¯é †ç•ªãŒç•°ãªã‚‹ï¼‰ -->
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <!-- ç¾å ´å -->
            {% if item.patient_name %}
            <div style="font-weight: 500; color: #1E3A5F;">
              ç¾å ´åï¼š{{ item.patient_name }}
            </div>
            {% endif %}
            
            <!-- æŒ‡åç¨®åˆ¥ -->
            {% if item.nomination_type %}
              {% set nom_type = item.nomination_type %}
              {% if nom_type == 'main' %}{% set nom_type = 'æœ¬æŒ‡å' %}{% endif %}
              {% if nom_type == 'frame' %}{% set nom_type = 'æ æŒ‡å' %}{% endif %}
              {% if nom_type == 'hope' %}{% set nom_type = 'å¸Œæœ›' %}{% endif %}
              {% if nom_type == 'free' %}{% set nom_type = 'ãƒ•ãƒªãƒ¼' %}{% endif %}
            <div style="font-size: 0.9rem; color: #666;">
              æŒ‡åç¨®åˆ¥ï¼š<span style="padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; background: #e0e0e0; color: #666;">{{ nom_type }}</span>
            </div>
            {% endif %}
            
            <!-- å¸¯åŒã‚¹ã‚¿ãƒƒãƒ• -->
            <div style="font-size: 0.9rem; color: #666;">
              å¸¯åŒã‚¹ã‚¿ãƒƒãƒ•ï¼š{{ item.staff_name }}
            </div>
            
            <!-- é‡‘é¡ -->
            {% if item.total_amount and item.total_amount > 0 %}
              <div style="font-size: 0.9rem; color: #4CAF50; font-weight: 500;">
                Â¥{{ "{:,}".format(item.total_amount) }}
              </div>
            {% endif %}
            
            <!-- ãƒ¡ãƒ¢ -->
            {% if item.memo %}
            <div style="font-size: 0.85rem; color: #666; padding: 8px; background: #fff; border-radius: 6px; margin-top: 4px;">
              {{ item.memo }}
            </div>
            {% endif %}
          </div>
          
          <!-- ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆæ¨©é™ãƒã‚§ãƒƒã‚¯ï¼‰ -->
          {% if item.can_edit %}
          <div>
            <button type="button" class="edit-item-btn" data-item-id="{{ item.id }}" style="padding: 6px 12px; background: #FFB6C1; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">ç·¨é›†</button>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    
    <!-- å½“æ—¥å°è¨ˆãƒ»å½“æœˆç´¯è¨ˆ -->
    <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid #FFB6C1; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <div style="font-size: 0.9rem; color: #666;">å½“æ—¥å°è¨ˆ</div>
        <div style="font-size: 1.2rem; font-weight: 600; color: #FFB6C1;">Â¥{{ "{:,}".format(field_day_total) }}</div>
      </div>
      <div>
        <div style="font-size: 0.9rem; color: #666;">å½“æœˆç´¯è¨ˆ</div>
        <div style="font-size: 1.2rem; font-weight: 600; color: #FFB6C1;">Â¥{{ "{:,}".format(field_month_total) }}</div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ -->
  {% if not in_house_items and not visit_items and not (field_items and is_admin) %}
  <div style="padding: 40px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); text-align: center;">
    <p style="color: #999; font-size: 1.1rem;">{{ selected_date }}ã®æ—¥å ±ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
  </div>
  {% endif %}
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="max-width: 800px; margin: 40px auto; background: #fff; border-radius: 18px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h3 style="margin: 0; font-size: 1.3rem; font-weight: 600; color: #1E3A5F;">æ—¥å ±ç·¨é›†</h3>
      <button type="button" id="close-modal-btn" style="background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">Ã—</button>
    </div>
    
    <form id="edit-form" method="POST" action="">
      <input type="hidden" id="edit-item-id" name="item_id" value="">
      
      <!-- åŸºæœ¬æƒ…å ± -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">é–‹å§‹æ™‚é–“</label>
        <input type="time" id="edit-start-time" name="start_time" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">çµ‚äº†æ™‚é–“</label>
        <input type="time" id="edit-end-time" name="end_time" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
        <input type="number" id="edit-break-minutes" name="break_minutes" min="0" value="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</label>
        <input type="number" id="edit-session-count" name="session_count" min="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æŒ‡åç¨®åˆ¥</label>
        <select id="edit-nomination-type" name="nomination_type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="main">æœ¬æŒ‡å</option>
          <option value="frame">æ æŒ‡å</option>
          <option value="hope">å¸Œæœ›</option>
          <option value="free">ãƒ•ãƒªãƒ¼</option>
        </select>
      </div>
      
      <!-- æ‚£è€…æƒ…å ±ï¼ˆå‹•çš„ã«è¿½åŠ ï¼‰ -->
      <div id="edit-patients-container" style="margin-bottom: 20px;">
        <!-- æ‚£è€…æƒ…å ±ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ãƒ¡ãƒ¢</label>
        <textarea id="edit-memo" name="memo" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; font-family: inherit;"></textarea>
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 30px;">
        <button type="submit" style="flex: 1; padding: 12px; background: #1E3A5F; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500;">ğŸ’¾ ä¿å­˜</button>
        <button type="button" id="cancel-edit-btn" style="flex: 1; padding: 12px; background: #999; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </form>
  </div>
</div>

<script>
// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
let editModalData = {};
const isAdmin = {% if is_admin %}true{% else %}false{% endif %};

// ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.addEventListener('DOMContentLoaded', function() {
  const editButtons = document.querySelectorAll('.edit-item-btn');
  const modal = document.getElementById('edit-modal');
  const closeBtn = document.getElementById('close-modal-btn');
  const cancelBtn = document.getElementById('cancel-edit-btn');
  const editForm = document.getElementById('edit-form');
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
  function closeModal() {
    modal.style.display = 'none';
    editModalData = {};
  }
  
  // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
  closeBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });
  
      // ç·¨é›†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
      editButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const itemId = btn.dataset.itemId;
          
          // ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ã‚’å–å¾—
          const itemCard = document.querySelector('.work-item-card[data-item-id="' + itemId + '"]');
          if (!itemCard) {
            alert('ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
          }
          
          // ãƒ‡ãƒ¼ã‚¿å±æ€§ã‹ã‚‰å€¤ã‚’å–å¾—
          const workType = itemCard.dataset.workType || '';
          const startTime = itemCard.dataset.startTime || '';
          const endTime = itemCard.dataset.endTime || '';
          const breakMinutes = itemCard.dataset.breakMinutes || '0';
          const sessionCount = itemCard.dataset.sessionCount || '';
          const nominationType = itemCard.dataset.nominationType || '';
          const memo = itemCard.dataset.memo || '';
          const patientsJson = itemCard.dataset.patients || '[]';
          
          // æ‚£è€…æƒ…å ±ã‚’ãƒ‘ãƒ¼ã‚¹
          let patients = [];
          try {
            patients = JSON.parse(patientsJson);
          } catch (e) {
            console.error('æ‚£è€…æƒ…å ±ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
            patients = [];
          }
          
          // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
          document.getElementById('edit-item-id').value = itemId;
          document.getElementById('edit-start-time').value = startTime;
          document.getElementById('edit-end-time').value = endTime;
          document.getElementById('edit-break-minutes').value = breakMinutes;
          document.getElementById('edit-session-count').value = sessionCount;
          document.getElementById('edit-nomination-type').value = nominationType;
          document.getElementById('edit-memo').value = memo;
          
          // ãƒ•ã‚©ãƒ¼ãƒ ã®actionã‚’è¨­å®š
          editForm.action = '/admin/daily-reports/item/' + itemId + '/update';
          
          // æ‚£è€…æƒ…å ±ã‚’è¡¨ç¤º
          const patientsContainer = document.getElementById('edit-patients-container');
          const isField = workType === 'field';
          if (patients && patients.length > 0) {
            let patientsHtml = '<div style="margin-bottom: 16px;"><strong style="color: #1E3A5F; font-size: 1rem;">' + (isField ? 'ç¾å ´æƒ…å ±' : 'æ‚£è€…æƒ…å ±') + '</strong></div>';
            patients.forEach(function(patient, index) {
              const patientId = patient.patient_id || '';
              const patientReportId = patient.id || '';
              const patientName = patient.patient_name || (isField ? 'ç¾å ´åä¸æ˜' : 'æ‚£è€…ä¸æ˜');
              const courseName = patient.course_name || '';
              const amount = patient.amount || 0;
              
              patientsHtml += '<div style="padding: 12px; background: #f5f7fb; border-radius: 8px; margin-bottom: 12px;">';
              patientsHtml += '<input type="hidden" name="patient_id[]" value="' + patientId + '">';
              patientsHtml += '<input type="hidden" name="patient_report_id[]" value="' + patientReportId + '">';
              patientsHtml += '<div style="margin-bottom: 8px;"><strong style="color: #1E3A5F;">' + patientName;
              if (!isField && patient.vip_level === 'star') {
                patientsHtml += ' â­ï¸';
              } else if (!isField && patient.vip_level === 'clover') {
                patientsHtml += ' ğŸ€';
              }
              patientsHtml += '</strong></div>';
              // é™¢å†…ãƒ»å¾€è¨ºã®å ´åˆã®ã¿ã‚³ãƒ¼ã‚¹åã‚’è¡¨ç¤º
              if (!isField) {
                patientsHtml += '<div style="margin-bottom: 8px;">';
                patientsHtml += '<label style="display: block; margin-bottom: 4px; font-size: 0.9rem; color: #666;">ã‚³ãƒ¼ã‚¹å</label>';
                patientsHtml += '<input type="text" name="patient_course_name[]" value="' + (courseName.replace(/"/g, '&quot;')) + '" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box;">';
                patientsHtml += '</div>';
              }
              // é‡‘é¡ç·¨é›†
              if (isField) {
                // å¸¯åŒã®å ´åˆã¯adminã®ã¿é‡‘é¡ç·¨é›†ã‚’è¡¨ç¤º
                if (isAdmin) {
                  patientsHtml += '<div style="margin-bottom: 8px;">';
                  patientsHtml += '<label style="display: block; margin-bottom: 4px; font-size: 0.9rem; color: #666;">é‡‘é¡ï¼ˆç®¡ç†è€…ã®ã¿ç·¨é›†å¯èƒ½ï¼‰</label>';
                  patientsHtml += '<input type="number" name="patient_amount[]" value="' + amount + '" min="0" step="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box;">';
                  patientsHtml += '</div>';
                }
              } else {
                // é™¢å†…ãƒ»å¾€è¨ºã¯å¸¸ã«é‡‘é¡ç·¨é›†ã‚’è¡¨ç¤º
                patientsHtml += '<div style="margin-bottom: 8px;">';
                patientsHtml += '<label style="display: block; margin-bottom: 4px; font-size: 0.9rem; color: #666;">é‡‘é¡</label>';
                patientsHtml += '<input type="number" name="patient_amount[]" value="' + amount + '" min="0" step="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box;">';
                patientsHtml += '</div>';
              }
              patientsHtml += '</div>';
            });
            patientsContainer.innerHTML = patientsHtml;
          } else {
            patientsContainer.innerHTML = '<p style="color: #666; font-size: 0.9rem;">' + (isField ? 'ç¾å ´æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“' : 'æ‚£è€…æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“') + '</p>';
          }
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          modal.style.display = 'block';
        });
      });
});
</script>
{% endblock %}
