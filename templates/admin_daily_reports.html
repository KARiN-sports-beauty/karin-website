{% extends "base.html" %}
{% block title %}æ—¥å ±ä¸€è¦§ | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">ğŸ“ ã‚¹ã‚¿ãƒƒãƒ•æ—¥å ±ä¸€è¦§</h2>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
<div style="margin-bottom: 20px; padding: 16px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
  <form method="GET" action="/admin/daily-reports" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
    <label style="display: flex; align-items: center; gap: 8px;">
      <span style="font-weight: 500; color: #1E3A5F;">åŒºåˆ†ï¼š</span>
      <select name="work_type" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem;">
        <option value="all" {% if work_type_filter == 'all' %}selected{% endif %}>ã™ã¹ã¦</option>
        <option value="in_house" {% if work_type_filter == 'in_house' %}selected{% endif %}>é™¢å†…</option>
        <option value="visit" {% if work_type_filter == 'visit' %}selected{% endif %}>å¾€è¨º</option>
        <option value="field" {% if work_type_filter == 'field' %}selected{% endif %}>å¸¯åŒ</option>
      </select>
    </label>
    
    <label style="display: flex; align-items: center; gap: 8px;">
      <span style="font-weight: 500; color: #1E3A5F;">é–‹å§‹æ—¥ï¼š</span>
      <input type="date" name="date_from" value="{{ date_from }}" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem;">
    </label>
    
    <label style="display: flex; align-items: center; gap: 8px;">
      <span style="font-weight: 500; color: #1E3A5F;">çµ‚äº†æ—¥ï¼š</span>
      <input type="date" name="date_to" value="{{ date_to }}" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem;">
    </label>
    
    <button type="submit" style="padding: 8px 16px; background: #1E3A5F; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">é©ç”¨</button>
    <a href="/admin/daily-reports" style="padding: 8px 16px; background: #999; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 500;">ãƒªã‚»ãƒƒãƒˆ</a>
  </form>
</div>

<!-- æ—¥å ±ä¸€è¦§ -->
{% if reports %}
<div style="display: flex; flex-direction: column; gap: 20px;">
  {% for report in reports %}
  {% if report.get("items") %}
  <div style="padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
    <!-- æ—¥å ±ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e0e0e0;">
      <div>
        <div style="font-size: 1.2rem; font-weight: 600; color: #1E3A5F; margin-bottom: 4px;">{{ report.report_date }}</div>
        <div style="font-size: 1rem; font-weight: 500; color: #1E3A5F;">{{ report.staff_name }}</div>
      </div>
      <div style="font-size: 0.85rem; color: #999;">
        ç™»éŒ²æ—¥æ™‚ï¼š{{ report.created_at[:16] if report.created_at else '' }}
      </div>
    </div>
    
    {% if report.memo %}
    <div style="margin-bottom: 16px; padding: 12px; background: #f5f7fb; border-radius: 8px; font-size: 0.9rem; color: #666;">
      <strong style="color: #1E3A5F;">æ—¥å ±ãƒ¡ãƒ¢ï¼š</strong>{{ report.memo }}
    </div>
    {% endif %}
    
    <!-- å‹¤å‹™ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
    <div style="display: flex; flex-direction: column; gap: 12px;">
      {% for item in report.get("items") %}
      <div class="admin-resv-card {% if item.work_type == 'in_house' %}place-inhouse{% elif item.work_type == 'visit' %}place-visit{% elif item.work_type == 'field' %}place-field{% endif %}">
        <!-- å‹¤å‹™åŒºåˆ†ãƒãƒƒã‚¸ï¼ˆå¿…ãšè¡¨ç¤ºï¼‰ -->
        <div style="margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
            {% if item.work_type == 'in_house' %}
            <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: #1E3A5F; color: #fff;">é™¢å†…</span>
            {% elif item.work_type == 'visit' %}
            <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: #4CAF50; color: #fff;">å¾€è¨º</span>
            {% elif item.work_type == 'field' %}
            <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: #FFB6C1; color: #fff;">å¸¯åŒ</span>
            {% endif %}
            {% if item.start_time_display and item.end_time_display %}
            <span style="color: #666; font-size: 0.9rem;">{{ item.start_time_display }} ï½ {{ item.end_time_display }}</span>
            {% elif item.start_time_display %}
            <span style="color: #666; font-size: 0.9rem;">é–‹å§‹ï¼š{{ item.start_time_display }}</span>
            {% elif item.end_time_display %}
            <span style="color: #666; font-size: 0.9rem;">çµ‚äº†ï¼š{{ item.end_time_display }}</span>
            {% endif %}
            {% if item.break_minutes and item.break_minutes > 0 %}
            <span style="color: #666; font-size: 0.9rem;">ä¼‘æ†©ï¼š{{ item.break_minutes }}åˆ†</span>
            {% endif %}
          </div>
        </div>
        
        {% if item.memo %}
        <div style="margin-bottom: 12px; padding: 8px; background: #fff; border-radius: 6px; font-size: 0.9rem; color: #666;">
          {{ item.memo }}
        </div>
        {% endif %}
        
        <!-- æ‚£è€…ãƒ»å£²ä¸Šæ˜ç´°ï¼ˆé‡‘é¡0å††ã§ã‚‚å¿…ãšè¡¨ç¤ºï¼‰ -->
        {% if item.patients %}
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
          <div style="font-size: 0.85rem; font-weight: 600; color: #1E3A5F; margin-bottom: 8px;">æ‚£è€…ãƒ»å£²ä¸Šæ˜ç´°</div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            {% for patient in item.patients %}
            <div style="padding: 8px; background: #f5f7fb; border-radius: 6px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
              <div style="flex: 1;">
                {% if patient.patient_id %}
                <a href="/admin/karte/{{ patient.patient_id }}" style="color: #1E3A5F; text-decoration: none; font-weight: 500;">
                  {% if patient.patient_name %}
                    {{ patient.patient_name }}
                  {% else %}
                    æ‚£è€…ID: {{ patient.patient_id[:8] }}...
                  {% endif %}
                </a>
                {% else %}
                <span style="color: #999;">æ‚£è€…æƒ…å ±ãªã—</span>
                {% endif %}
                {% if patient.course_name %}
                <span style="color: #666; font-weight: 500;">ï½œ{{ patient.course_name }}</span>
                {% else %}
                <span style="color: #999; font-size: 0.8rem;">ï½œã‚³ãƒ¼ã‚¹åãªã—</span>
                {% endif %}
                {% if patient.amount is not none %}
                <span style="color: {% if patient.amount == 0 %}#999{% else %}#4CAF50{% endif %}; font-weight: {% if patient.amount == 0 %}400{% else %}500{% endif %};">
                  ï½œÂ¥{{ "{:,}".format(patient.amount) }}
                </span>
                {% else %}
                <span style="color: #999; font-size: 0.8rem;">ï½œé‡‘é¡æœªè¨­å®š</span>
                {% endif %}
              </div>
              <form method="POST" action="/admin/daily-reports/patient/{{ patient.id }}/amount" style="display: flex; align-items: center; gap: 4px;" onsubmit="return confirm('é‡‘é¡ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿäºˆç´„ãƒ‡ãƒ¼ã‚¿ã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚');">
                <input type="number" name="amount" value="{{ patient.amount if patient.amount is not none else 0 }}" min="0" step="100" style="width: 100px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;">
                <button type="submit" style="padding: 4px 12px; background: #1E3A5F; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">æ›´æ–°</button>
              </form>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  {% endfor %}
</div>
{% else %}
<p style="color: #999; text-align: center; padding: 40px 0;">æ—¥å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>
{% endif %}
{% endblock %}
