{% extends "base.html" %}
{% block title %}ã‚«ãƒ«ãƒ†è©³ç´° | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">ğŸ“‹ ã‚«ãƒ«ãƒ†è©³ç´°</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<!-- åŸºæœ¬æƒ…å ±ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆè¡¨ç´™ï¼‰ -->
<div class="admin-karte-detail-card">
  <h3 class="admin-karte-detail-section-title">åŸºæœ¬æƒ…å ±</h3>
  
  <div class="admin-karte-detail-info-grid">
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">1. åå‰</span>
      <span class="admin-karte-detail-value">
        {% if patient.last_name or patient.first_name %}
          {{ patient.last_name or '' }} {{ patient.first_name or '' }}
          <span class="admin-karte-detail-kana">
            ï¼ˆ{{ patient.last_kana or '' }} {{ patient.first_kana or '' }}ï¼‰
          </span>
        {% else %}
          æœªå…¥åŠ›
        {% endif %}
      </span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">2. ãƒ•ãƒªã‚¬ãƒŠ</span>
      <span class="admin-karte-detail-value">
        {% if patient.last_kana or patient.first_kana %}
          {{ patient.last_kana or '' }} {{ patient.first_kana or '' }}
        {% else %}
          æœªå…¥åŠ›
        {% endif %}
      </span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">3. ç”Ÿå¹´æœˆæ—¥</span>
      <span class="admin-karte-detail-value">
        {{ patient.birthday if patient.birthday else 'æœªå…¥åŠ›' }}
        {% if patient.birthday %}
          <span class="admin-karte-detail-age">ï¼ˆ{{ patient.birthday | age_from_birthday }}æ­³ï¼‰</span>
        {% endif %}
      </span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">4. æ€§åˆ¥</span>
      <span class="admin-karte-detail-value">{{ patient.gender or 'æœªå…¥åŠ›' }}</span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">5. åŒºåˆ†</span>
      <span class="admin-karte-detail-value">{{ patient.category or 'æœªå…¥åŠ›' }}</span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">6. é›»è©±ç•ªå·</span>
      <span class="admin-karte-detail-value">{{ patient.phone or 'æœªå…¥åŠ›' }}</span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">7. ãƒ¡ãƒ¼ãƒ«</span>
      <span class="admin-karte-detail-value">{{ patient.email or 'æœªå…¥åŠ›' }}</span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">8. éƒµä¾¿ç•ªå·</span>
      <span class="admin-karte-detail-value">{{ patient.postal_code or 'æœªå…¥åŠ›' }}</span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">9. ä½æ‰€</span>
      <span class="admin-karte-detail-value">{{ patient.address or 'æœªå…¥åŠ›' }}</span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">10. ç´¹ä»‹è€…</span>
      <span class="admin-karte-detail-value">
        {% if patient.introducer_info %}
          <a
            href="/admin/karte/{{ patient.introducer_info.id }}"
            class="admin-karte-detail-introducer-link"
          >
            {{ patient.introducer_info.last_name or '' }} {{ patient.introducer_info.first_name or '' }}
            ï¼ˆ{{ patient.introducer_info.last_kana or '' }} {{ patient.introducer_info.first_kana or '' }}ï¼‰
          </a>
          {% if patient.introducer_info.introduced_count and patient.introducer_info.introduced_count > 0 %}
            <span class="admin-introducer-badge">{{ patient.introducer_info.introduced_count }}</span>
          {% endif %}
        {% else %}
          <span style="color:#999;">ãªã—</span>
        {% endif %}
      </span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">11. ä¸»è¨´</span>
      <span class="admin-karte-detail-value">{{ patient.chief_complaint or 'æœªå…¥åŠ›' }}</span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">12. æ—¢å¾€æ­´ãƒ»æ³¨æ„äº‹é …</span>
      <span class="admin-karte-detail-value">
        {% set has_content = false %}
        {% if patient.heart is not none and patient.heart != '' %}
          {% set has_content = true %}
          å¿ƒç–¾æ‚£ï¼š{{ patient.heart }}ã€€
        {% endif %}
        {% if patient.pregnant is not none and patient.pregnant != '' %}
          {% set has_content = true %}
          å¦Šå¨ ï¼š{{ patient.pregnant }}ã€€
        {% endif %}
        {% if patient.chronic is not none and patient.chronic != '' %}
          {% set has_content = true %}
          æ…¢æ€§ç–¾æ‚£ï¼š{{ patient.chronic }}ã€€
        {% endif %}
        {% if patient.surgery is not none and patient.surgery != '' %}
          {% set has_content = true %}
          æ‰‹è¡“æ­´ï¼š{{ patient.surgery }}ã€€
        {% endif %}
        {% if patient.under_medical is not none and patient.under_medical != '' %}
          {% set has_content = true %}
          åŒ»ç™‚æ©Ÿé–¢å—è¨ºä¸­ï¼š{{ patient.under_medical }}ã€€
        {% endif %}
        {% if not has_content %}
          ãªã—
        {% endif %}
      </span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">13. åˆºæ¿€ã®å¥½ã¿</span>
      <span class="admin-karte-detail-value">
        {% if patient.shinkyu_pref or patient.electric_pref or patient.pressure_pref %}
          é¼ç¸ï¼š{{ patient.shinkyu_pref or 'æŒ‡å®šãªã—' }} / 
          é›»æ°—ï¼š{{ patient.electric_pref or 'æŒ‡å®šãªã—' }} / 
          åœ§åŠ›ï¼š{{ patient.pressure_pref or 'æŒ‡å®šãªã—' }}
        {% else %}
          æœªå…¥åŠ›
        {% endif %}
      </span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">14. åˆå›ç½²å</span>
      <span class="admin-karte-detail-value">
        {% if patient.signature %}â—¯{% else %}âŒ{% endif %}
      </span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">15. åˆå›åŒæ„æ—¥</span>
      <span class="admin-karte-detail-value">
        {% if patient.agreed_at %}{{ patient.agreed_at }}{% else %}âŒï¼ˆnullï¼‰{% endif %}
      </span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">16. åˆè¨ºæ—¥</span>
      <span class="admin-karte-detail-value">
        {% if patient.created_at %}{{ patient.created_at[:10] }}{% else %}æœªå…¥åŠ›{% endif %}
      </span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">17. æœ€çµ‚æ¥é™¢æ—¥</span>
      <span class="admin-karte-detail-value">
        {{ patient.last_visit_date if patient.last_visit_date else 'æœªè¨˜éŒ²' }}
      </span>
    </div>
    
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">18. å‚™è€ƒ</span>
      <span class="admin-karte-detail-value">{{ patient.note or 'æœªå…¥åŠ›' }}</span>
    </div>
    
    {% if patient.introduced_count and patient.introduced_count > 0 %}
    <div class="admin-karte-detail-field">
      <span class="admin-karte-detail-label">19. ç´¹ä»‹æ‚£è€…</span>
      <span class="admin-karte-detail-value">
        <button type="button" id="introduced-patients-toggle" class="admin-introduced-badge">
          ç´¹ä»‹ {{ patient.introduced_count }}äºº
        </button>
      </span>
    </div>
    {% endif %}
  </div>
</div>

<!-- ç´¹ä»‹æ‚£è€…ä¸€è¦§ï¼ˆé–‹é–‰è¡¨ç¤ºï¼‰ -->
{% if patient.introduced_count and patient.introduced_count > 0 %}
<div id="introduced-patients-list" class="admin-introduced-list" style="display: none;">
  <div class="admin-karte-detail-card">
    <h3 class="admin-karte-detail-section-title">ç´¹ä»‹æ‚£è€…ä¸€è¦§ï¼ˆ{{ patient.introduced_count }}äººï¼‰</h3>
    <div class="admin-introduced-grid">
      {% for introduced_patient in patient.introduced_patients %}
      <a href="/admin/karte/{{ introduced_patient.id }}" class="admin-introduced-card">
        <div class="admin-introduced-head">
          <strong class="admin-introduced-name">
            {{ introduced_patient.last_name or '' }} {{ introduced_patient.first_name or '' }}
          </strong>
        </div>
        <div class="admin-introduced-info">
          <p class="admin-introduced-field">
            <span class="admin-introduced-label">ãƒ•ãƒªã‚¬ãƒŠï¼š</span>
            <span>{{ introduced_patient.last_kana or '' }} {{ introduced_patient.first_kana or '' }}</span>
          </p>
          {% if introduced_patient.birthday %}
          <p class="admin-introduced-field">
            <span class="admin-introduced-label">ç”Ÿå¹´æœˆæ—¥ï¼š</span>
            <span>{{ introduced_patient.birthday }}</span>
          </p>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- æ–½è¡“ãƒ­ã‚°ä¸€è¦§ -->
<div class="admin-karte-detail-logs-section">
  <h3 class="admin-karte-detail-section-title">æ–½è¡“ãƒ­ã‚°</h3>
  
  {% if logs %}
  <div class="admin-karte-detail-logs-container">
    {% for log in logs[:5] %}
    <div class="admin-karte-log-card">
      <div class="admin-karte-log-header">
        <div class="admin-karte-log-date">{{ log.date }}</div>
        <div class="admin-karte-log-actions">
          <a href="/admin/karte/log/{{ log.id }}/edit" class="admin-karte-log-edit-btn">âœ ç·¨é›†</a>
          {% if is_admin %}
          <form action="/admin/karte/log/{{ log.id }}/delete" method="POST" style="display: inline;" onsubmit="return confirm('ã“ã®æ–½è¡“ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå…ƒã«ã¯æˆ»ã›ã¾ã›ã‚“ï¼‰');">
            <button type="submit" class="admin-karte-log-delete-btn">ğŸ—‘ å‰Šé™¤</button>
          </form>
          {% endif %}
        </div>
      </div>
      
      <div class="admin-karte-log-content">
        <div class="admin-karte-log-field">
          <span class="admin-karte-log-label">ç¾å ´åŒºåˆ†ï¼š</span>
          <span>
            {% set place_map = {'in_house':'é™¢å†…','visit':'å¾€è¨º','field':'å¸¯åŒ'} %}
            {{ place_map.get(log.place_type, log.place_type or 'æœªå…¥åŠ›') }}
          </span>
        </div>
        
        <div class="admin-karte-log-field">
          <span class="admin-karte-log-label">ä¸»è¨´ï¼š</span>
          <span>{{ log.chief_complaint or 'æœªå…¥åŠ›' }}</span>
        </div>
        
        <div class="admin-karte-log-field">
          <span class="admin-karte-log-label">ä»Šæ—¥ã®çŠ¶æ…‹ï¼š</span>
          <span>{{ log.body_state or 'æœªå…¥åŠ›' }}</span>
        </div>
        
        <div class="admin-karte-log-field">
          <span class="admin-karte-log-label">æ–½è¡“å†…å®¹ï¼š</span>
          <span>{{ log.treatment or 'æœªå…¥åŠ›' }}</span>
        </div>
        
        <div class="admin-karte-log-field">
          <span class="admin-karte-log-label">ãƒ¡ãƒ¢ï¼š</span>
          <span>{{ log.memo or 'æœªå…¥åŠ›' }}</span>
        </div>
        
        <div class="admin-karte-log-field">
          <span class="admin-karte-log-label">ã‚¹ã‚¿ãƒƒãƒ•ï¼š</span>
          <span>{{ log.staff_name or 'ä¸æ˜' }}</span>
        </div>
        
        {% if log.images %}
        <div class="admin-karte-log-images">
          <span class="admin-karte-log-label">æ·»ä»˜ç”»åƒï¼š</span>
          <div class="admin-karte-log-images-grid">
            {% for image in log.images %}
            <div class="admin-karte-log-image-item">
              <a href="{{ image.image_url }}" target="_blank" class="admin-karte-log-image-link" onclick="event.preventDefault(); showImageModal('{{ image.image_url }}');">
                <img src="{{ image.image_url }}" alt="ç”»åƒ" class="admin-karte-log-image-thumb">
              </a>
              {% if is_admin %}
              <form action="/admin/karte/image/{{ image.id }}/delete" method="POST" style="display: inline;" onsubmit="return confirm('ã“ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                <button type="submit" class="admin-karte-log-image-delete">Ã—</button>
              </form>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
    
    {% if logs|length > 5 %}
    <div class="admin-karte-log-scroll-container" id="older-logs">
      {% for log in logs[5:] %}
      <div class="admin-karte-log-card">
        <div class="admin-karte-log-header">
          <div class="admin-karte-log-date">{{ log.date }}</div>
          <div class="admin-karte-log-actions">
            <a href="/admin/karte/log/{{ log.id }}/edit" class="admin-karte-log-edit-btn">âœ ç·¨é›†</a>
            {% if is_admin %}
            <form action="/admin/karte/log/{{ log.id }}/delete" method="POST" style="display: inline;" onsubmit="return confirm('ã“ã®æ–½è¡“ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå…ƒã«ã¯æˆ»ã›ã¾ã›ã‚“ï¼‰');">
              <button type="submit" class="admin-karte-log-delete-btn">ğŸ—‘ å‰Šé™¤</button>
            </form>
            {% endif %}
          </div>
        </div>
        
        <div class="admin-karte-log-content">
          <div class="admin-karte-log-field">
            <span class="admin-karte-log-label">ç¾å ´åŒºåˆ†ï¼š</span>
            <span>{{ log.location_type or 'æœªå…¥åŠ›' }}</span>
          </div>
          
          <div class="admin-karte-log-field">
            <span class="admin-karte-log-label">ä¸»è¨´ï¼š</span>
            <span>{{ log.chief_complaint or 'æœªå…¥åŠ›' }}</span>
          </div>
          
          <div class="admin-karte-log-field">
            <span class="admin-karte-log-label">ä»Šæ—¥ã®çŠ¶æ…‹ï¼š</span>
            <span>{{ log.today_condition or 'æœªå…¥åŠ›' }}</span>
          </div>
          
          <div class="admin-karte-log-field">
            <span class="admin-karte-log-label">æ–½è¡“å†…å®¹ï¼š</span>
            <span>{{ log.treatment or 'æœªå…¥åŠ›' }}</span>
          </div>
          
          <div class="admin-karte-log-field">
            <span class="admin-karte-log-label">ãƒ¡ãƒ¢ï¼š</span>
            <span>{{ log.memo or 'æœªå…¥åŠ›' }}</span>
          </div>
          
          <div class="admin-karte-log-field">
            <span class="admin-karte-log-label">ã‚¹ã‚¿ãƒƒãƒ•ï¼š</span>
            <span>{{ log.staff_name or 'ä¸æ˜' }}</span>
          </div>
          
          {% if log.images %}
          <div class="admin-karte-log-images">
            <span class="admin-karte-log-label">æ·»ä»˜ç”»åƒï¼š</span>
            <div class="admin-karte-log-images-grid">
              {% for image in log.images %}
              <div class="admin-karte-log-image-item">
                <a href="{{ image.image_url }}" target="_blank" class="admin-karte-log-image-link" onclick="event.preventDefault(); showImageModal('{{ image.image_url }}');">
                  <img src="{{ image.image_url }}" alt="ç”»åƒ" class="admin-karte-log-image-thumb">
                </a>
                {% if is_admin %}
                <form action="/admin/karte/image/{{ image.id }}/delete" method="POST" style="display: inline;" onsubmit="return confirm('ã“ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                  <button type="submit" class="admin-karte-log-image-delete">Ã—</button>
                </form>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  {% else %}
  <p>æ–½è¡“ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}
</div>

<!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
<div class="admin-karte-detail-actions">
  <a href="/admin/karte/{{ patient.id }}/log/new" class="admin-karte-detail-btn-primary">â• æ–°è¦æ–½è¡“ãƒ­ã‚°è¿½åŠ </a>
  <a href="/admin/karte/{{ patient.id }}/edit" class="admin-karte-detail-btn-secondary">âœ åŸºæœ¬æƒ…å ±ç·¨é›†</a>
  {% if is_admin %}
  <form action="/admin/karte/{{ patient.id }}/delete" method="POST" style="display: inline;" onsubmit="return confirm('ã“ã®ã‚«ãƒ«ãƒ†ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå…ƒã«ã¯æˆ»ã›ã¾ã›ã‚“ï¼‰');">
    <button type="submit" class="admin-karte-detail-btn-danger">ğŸ—‘ ã‚«ãƒ«ãƒ†å‰Šé™¤</button>
  </form>
  {% endif %}
  <a href="/admin/karte" class="admin-karte-detail-btn-back">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
</div>

<!-- ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="image-modal" class="admin-karte-image-modal" onclick="closeImageModal()">
  <div class="admin-karte-image-modal-content" onclick="event.stopPropagation();">
    <span class="admin-karte-image-modal-close" onclick="closeImageModal()">&times;</span>
    <img id="modal-image" src="" alt="æ‹¡å¤§ç”»åƒ" class="admin-karte-image-modal-img">
  </div>
</div>

<script>
function showImageModal(imageUrl) {
  const modal = document.getElementById('image-modal');
  const img = document.getElementById('modal-image');
  img.src = imageUrl;
  modal.style.display = 'flex';
}

function closeImageModal() {
  const modal = document.getElementById('image-modal');
  modal.style.display = 'none';
}

// ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeImageModal();
  }
});

// ç´¹ä»‹æ‚£è€…ä¸€è¦§ã®é–‹é–‰
const introducedToggle = document.getElementById('introduced-patients-toggle');
const introducedList = document.getElementById('introduced-patients-list');

if (introducedToggle && introducedList) {
  introducedToggle.addEventListener('click', function() {
    if (introducedList.style.display === 'none') {
      introducedList.style.display = 'block';
    } else {
      introducedList.style.display = 'none';
    }
  });
}
</script>

{% endblock %}
