{% extends "base.html" %}
{% block title %}æ–°è¦ã‚«ãƒ«ãƒ†ä½œæˆ | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">â• æ–°è¦ã‚«ãƒ«ãƒ†ä½œæˆ</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 12px; padding: 10px; border-radius: 6px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %}; font-size: 0.9rem;">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<form method="POST" action="/admin/karte/new" class="admin-karte-form">
  <!-- å…¥åŠ›é †ï¼š1. å§“ -->
  <div class="admin-form-field">
    <label class="admin-form-label">å§“</label>
    <input type="text" name="last_name" id="last_name" class="admin-form-input" placeholder="å§“">
  </div>
  
  <!-- å…¥åŠ›é †ï¼š2. å -->
  <div class="admin-form-field">
    <label class="admin-form-label">å</label>
    <input type="text" name="first_name" id="first_name" class="admin-form-input" placeholder="å">
  </div>

    <!-- å…¥åŠ›é †ï¼š3. ã‚»ã‚¤ -->
    <div class="admin-form-field">
      <label class="admin-form-label">ã‚»ã‚¤</label>
      <input type="text" name="last_kana" id="last_kana" class="admin-form-input" placeholder="ã‚»ã‚¤">
    </div>
    
    <!-- å…¥åŠ›é †ï¼š4. ãƒ¡ã‚¤ -->
    <div class="admin-form-field">
      <label class="admin-form-label">ãƒ¡ã‚¤</label>
      <input type="text" name="first_kana" id="first_kana" class="admin-form-input" placeholder="ãƒ¡ã‚¤">
    </div>
  
  <!-- å…¥åŠ›é †ï¼š5. ç”Ÿå¹´æœˆæ—¥ -->
  <div class="admin-form-field">
    <label class="admin-form-label">ç”Ÿå¹´æœˆæ—¥</label>
    <input type="date" name="birthday" class="admin-form-input">
  </div>
  
  <!-- å…¥åŠ›é †ï¼š6. æ€§åˆ¥ -->
  <div class="admin-form-field">
    <label class="admin-form-label">æ€§åˆ¥</label>
    <select name="gender" class="admin-form-select">
      <option value="">é¸æŠ</option>
      <option value="ç”·æ€§">ç”·æ€§</option>
      <option value="å¥³æ€§">å¥³æ€§</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>
  </div>
  
  <!-- å…¥åŠ›é †ï¼š7. åŒºåˆ† -->
  <div class="admin-form-field">
    <label class="admin-form-label">åŒºåˆ†</label>
    <select name="category" class="admin-form-select">
      <option value="">é¸æŠ</option>
      <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
      <option value="ã‚¹ãƒãƒ¼ãƒ„é¸æ‰‹">ã‚¹ãƒãƒ¼ãƒ„é¸æ‰‹</option>
      <option value="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ»ã‚¿ãƒ¬ãƒ³ãƒˆ">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ»ã‚¿ãƒ¬ãƒ³ãƒˆ</option>
    </select>
  </div>
  
  <!-- å…¥åŠ›é †ï¼š8. ç´¹ä»‹è€…ï¼ˆè‡ªç”±è¨˜å…¥ï¼‰ -->
  <div class="admin-form-field">
    <label class="admin-form-label">ç´¹ä»‹è€…ï¼ˆè‡ªç”±è¨˜å…¥ï¼‰</label>
    <input type="text" name="introducer" class="admin-form-input" placeholder="ç´¹ä»‹è€…å">
  </div>
  
  <!-- å…¥åŠ›é †ï¼š9. ç´¹ä»‹è€…ï¼ˆæ¤œç´¢ã—ã¦é¸æŠï¼‰ -->
  <div class="admin-form-field">
    <label class="admin-form-label">ç´¹ä»‹è€…ï¼ˆæ¤œç´¢ã—ã¦é¸æŠï¼‰</label>
    
    <!-- è¡¨ç¤ºç”¨ input -->
    <input
      type="text"
      id="introducer_search"
      class="admin-form-input"
      placeholder="åå‰ãƒ»ãƒ•ãƒªã‚¬ãƒŠã§æ¤œç´¢"
      autocomplete="off"
    >
    
    <!-- é¸æŠçµæœè¡¨ç¤º -->
    <div id="introducer_results" class="admin-autocomplete-list"></div>
    
    <!-- é¸æŠè§£é™¤ãƒœã‚¿ãƒ³ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
    <button
      type="button"
      id="introducer_clear"
      class="admin-introducer-clear"
      style="display: none;"
    >
      âœ• é¸æŠè§£é™¤
    </button>
    
    <!-- å®Ÿéš›ã«é€ä¿¡ã™ã‚‹ID -->
    <input type="hidden" name="introduced_by_patient_id" id="introduced_by_patient_id">
  </div>
  
  {% if session.staff and session.staff.is_admin %}
  <!-- VIPãƒ•ãƒ©ã‚°ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ -->
  <div class="admin-form-field">
    <label class="admin-form-label">VIPãƒ•ãƒ©ã‚°</label>
    <select name="vip_level" class="admin-form-select">
      <option value="none">ãªã—</option>
      <option value="star">â­ï¸</option>
      <option value="clover">ğŸ€</option>
    </select>
  </div>
  {% endif %}
  
  <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
  <div class="admin-form-actions">
    <button type="submit" class="admin-karte-detail-btn-primary">ğŸ’¾ ä¿å­˜</button>
    <a href="/admin/karte" class="admin-karte-detail-btn-back">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
  </div>
</form>

<script>
// all_patients ã‚’ JSON ã§åŸ‹ã‚è¾¼ã‚€
const allPatients = {{ all_patients | tojson }};

// ã²ã‚‰ãŒãªã‚’ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ›ã™ã‚‹é–¢æ•°
function hiraganaToKatakana(str) {
  return str.replace(/[ã-ã‚–]/g, function(match) {
    return String.fromCharCode(match.charCodeAt(0) + 0x60);
  });
}

// ãƒ•ãƒªã‚¬ãƒŠè‡ªå‹•è£œå®Œï¼ˆIMEå…¥åŠ›ä¸­ã®èª­ã¿ä»®åã‚’ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ›ï¼‰
function autoFillKana(sourceId, targetId) {
  const source = document.getElementById(sourceId);
  const target = document.getElementById(targetId);
  
  if (!source || !target) return;
  
  let compositionText = "";
  
  // IMEå…¥åŠ›é–‹å§‹æ™‚
  source.addEventListener("compositionstart", function() {
    compositionText = "";
  });
  
  // IMEå…¥åŠ›ä¸­ï¼ˆèª­ã¿ä»®åã‚’å–å¾—ï¼‰
  source.addEventListener("compositionupdate", function(e) {
    // e.dataã«èª­ã¿ä»®åãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜ï¼‰
    if (e.data) {
      compositionText = e.data;
      // èª­ã¿ä»®åã‚’ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ›ã—ã¦åæ˜ 
      if (!target.value || target.value === hiraganaToKatakana(compositionText)) {
        target.value = hiraganaToKatakana(compositionText);
      }
    }
  });
  
  // IMEç¢ºå®šæ™‚
  source.addEventListener("compositionend", function(e) {
    // ç¢ºå®šå¾Œã®æ–‡å­—åˆ—ã‚’å–å¾—
    const finalValue = e.data || source.value;
    
    // ã²ã‚‰ãŒãªã¾ãŸã¯ã‚«ã‚¿ã‚«ãƒŠã®ã¿ã®å ´åˆã€ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ›
    if (/^[ã-ã‚–ã‚¡-ãƒ¶ãƒ¼\s]*$/.test(finalValue)) {
      const katakanaValue = hiraganaToKatakana(finalValue);
      if (!target.value || target.value === katakanaValue) {
        target.value = katakanaValue;
      }
    }
    compositionText = "";
  });
  
  // bluræ™‚ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ï¼‰ã‚‚æœ€çµ‚ç¢ºèª
  source.addEventListener("blur", function() {
    if (!target.value && source.value) {
      const sourceValue = source.value;
      // ã²ã‚‰ãŒãªã¾ãŸã¯ã‚«ã‚¿ã‚«ãƒŠã®ã¿ã®å ´åˆã€ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ›
      if (/^[ã-ã‚–ã‚¡-ãƒ¶ãƒ¼\s]*$/.test(sourceValue)) {
        target.value = hiraganaToKatakana(sourceValue);
      }
    }
  });
}

// è‡ªå‹•è£œå®Œæ©Ÿèƒ½ã¯ç„¡åŠ¹åŒ–ï¼ˆå§“ãƒ»åã‹ã‚‰ã‚»ã‚¤ãƒ»ãƒ¡ã‚¤ã¸ã®è‡ªå‹•åæ˜ ã‚’åœæ­¢ï¼‰
// autoFillKana("last_name", "last_kana");
// autoFillKana("first_name", "first_kana");

// autocomplete ãƒ­ã‚¸ãƒƒã‚¯
const searchInput = document.getElementById("introducer_search");
const resultsBox = document.getElementById("introducer_results");
const hiddenInput = document.getElementById("introduced_by_patient_id");
const clearBtn = document.getElementById("introducer_clear");

if (searchInput && resultsBox && hiddenInput && clearBtn) {
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.trim().toLowerCase();
    resultsBox.innerHTML = "";

    if (!q) {
      resultsBox.style.display = "none";
      hiddenInput.value = "";
      clearBtn.style.display = "none";
      return;
    }

    const matched = allPatients.filter(p => {
      const searchText = `${p.last_name || ''}${p.first_name || ''}${p.last_kana || ''}${p.first_kana || ''}`.toLowerCase();
      return searchText.includes(q);
    });

    matched.forEach(p => {
      const item = document.createElement("div");
      item.className = "admin-autocomplete-item";

      const text = document.createElement("span");
      const lastName = p.last_name || '';
      const firstName = p.first_name || '';
      const lastKana = p.last_kana || '';
      const firstKana = p.first_kana || '';
      const birthday = p.birthday || "ç”Ÿå¹´æœˆæ—¥ä¸æ˜";
      
      // ç´¹ä»‹è€…è¡¨ç¤ºï¼šintroduced_by_patient_idãŒã‚ã‚Œã°ç´¹ä»‹è€…ã®å§“åã€ãªã‘ã‚Œã°æ‰‹æ›¸ãã®introducer
      let introducerDisplay = "ç´¹ä»‹è€…ãªã—";
      if (p.introducer_info) {
        const introLastName = p.introducer_info.last_name || '';
        const introFirstName = p.introducer_info.first_name || '';
        introducerDisplay = `${introLastName} ${introFirstName}`.trim() || "ç´¹ä»‹è€…ä¸æ˜";
      } else if (p.introducer) {
        introducerDisplay = p.introducer; // æ‰‹æ›¸ãã®ç´¹ä»‹è€…
      }
      
      text.textContent = `${lastName} ${firstName}ï¼ˆ${lastKana} ${firstKana}ï¼‰ï½œ${birthday}ï½œ${introducerDisplay}`;
      item.appendChild(text);

      // ç´¹ä»‹è€…æ•°ãƒãƒƒã‚¸ï¼ˆã‚ã‚Œã°è¡¨ç¤ºï¼‰
      if (p.introduced_count && p.introduced_count > 0) {
        const badge = document.createElement("span");
        badge.className = "admin-introducer-badge";
        badge.textContent = `${p.introduced_count}`;
        item.appendChild(badge);
      }

      item.onclick = () => {
        searchInput.value = `${lastName} ${firstName}`;
        hiddenInput.value = p.id;
        resultsBox.style.display = "none";
        clearBtn.style.display = "inline-block";
      };

      resultsBox.appendChild(item);
    });

    resultsBox.style.display = matched.length ? "block" : "none";
  });

  // é¸æŠè§£é™¤
  clearBtn.addEventListener("click", () => {
    searchInput.value = "";
    hiddenInput.value = "";
    clearBtn.style.display = "none";
    resultsBox.style.display = "none";
  });

  // ã‚¯ãƒªãƒƒã‚¯å¤–ã§å€™è£œãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
  document.addEventListener("click", (e) => {
    if (!searchInput.contains(e.target) && !resultsBox.contains(e.target) && !clearBtn.contains(e.target)) {
      resultsBox.style.display = "none";
    }
  });
}
</script>

{% endblock %}
