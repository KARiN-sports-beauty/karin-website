<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>{{ blog.title }} | KARiN. ãƒ–ãƒ­ã‚°</title>

  <meta name="description" content="{{ blog.excerpt }}">
  <link rel="canonical" href="{{ request.url }}">

  <meta property="og:type" content="article">
  <meta property="og:title" content="{{ blog.title }} | KARiN. ãƒ–ãƒ­ã‚°">
  <meta property="og:description" content="{{ blog.excerpt }}">
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:site_name" content="KARiN. ~Sports & Beauty~">

  {% if blog.image %}
    <meta property="og:image" content="https://karin-website.onrender.com/static/images/blogs/{{ blog.image }}">
  {% else %}
    <meta property="og:image" content="https://karin-website.onrender.com/static/images/common/ogp_default.jpg">
  {% endif %}

  <meta name="twitter:card" content="summary_large_image">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": {{ blog.title | tojson }},
    {% if blog.image %}
      "image": "https://karin-website.onrender.com/static/images/blogs/{{ blog.image }}",
    {% endif %}
    "author": {
      "@type": "Person",
      "name": "è—¤ç”° å¹¸å£«ï¼ˆKARiN.ä»£è¡¨ï¼‰"
    },
    "publisher": {
      "@type": "Organization",
      "name": "KARiN. ~Sports & Beauty~",
      "logo": {
        "@type": "ImageObject",
        "url": "https://karin-website.onrender.com/static/images/relogo.png"
      }
    },
    "datePublished": "{{ blog.date }}",
    "description": {{ (blog.excerpt or '') | tojson }},
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "{{ request.url }}"
    }
  }
  </script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/blog_style.css') }}">
</head>

<body>
  <section class="blog-detail">
    <h1 class="blog-title">{{ blog.title }}</h1>
    <p class="blog-date">{{ blog.date }}</p>

    {% if blog.image %}
    <figure class="blog-thumb">
      <img src="{{ url_for('static', filename='images/blogs/' + blog.image) }}" alt="{{ blog.title }}">
    </figure>
    {% endif %}

    <div class="blog-body">
      {{ blog.body|safe }}
    </div>

    <!-- â¤ï¸ ã„ã„ã­ -->
    <div class="like-section">
      <button id="like-btn" data-id="{{ blog.id }}" class="action-btn {% if liked %}liked{% endif %}">
        â¤ï¸ ã„ã„ã­ (<span id="like-count">{{ like_count }}</span>)
      </button>
    </div>

    <!-- ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ -->
    <div class="comment-section">
      <h3 class="comment-title">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ{{ comments|length }}ï¼‰</h3>

      <div class="comment-input-area">
        <input id="comment-name" type="text" placeholder="ãŠåå‰ï¼ˆä»»æ„ï¼‰">
        <textarea id="comment-body" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."></textarea>
        <button id="comment-submit" class="submit-btn">é€ä¿¡</button>
      </div>

      <!-- ä¸€è¦§ï¼ˆå¹ãå‡ºã—è¡¨ç¤ºï¼‰ -->
      <div class="comment-list">
        {% for c in comments %}
        <div class="comment-item">
          <div class="comment-bubble">
            <div class="bubble-header">
              <span class="comment-author">{{ c.name }}</span>
              <span class="comment-date">{{ c.created_at }}</span>
            </div>
            <p class="comment-text">{{ c.body }}</p>
          </div>

          {% if c.reply %}
          <div class="comment-reply">
            <div class="reply-header">
              <span class="reply-author">è—¤ç”° å¹¸å£«ï¼ˆKARiN.ï¼‰ã‹ã‚‰ã®è¿”ä¿¡</span>
              <span class="reply-date">{{ c.reply_date }}</span>
            </div>
            <p class="reply-text">{{ c.reply }}</p>
          </div>
          {% endif %}


        </div>
        {% endfor %}
      </div>
    </div>
        <!-- ğŸ‘¤ è‘—è€…ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
    <div class="author-profile">
      <img src="{{ url_for('static', filename='images/koji_profile.png') }}" alt="è—¤ç”° å¹¸å£«" class="author-img">
      <div class="author-info">
        <h3>ã“ã®è¨˜äº‹ã‚’æ›¸ã„ãŸäºº</h3>
        <p><strong>è—¤ç”° å¹¸å£«ï¼ˆKARiN.ä»£è¡¨ï¼‰</strong><br>
          é¼ç¸å¸«ãƒ»ã‚¹ãƒãƒ¼ãƒ„ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã¨ã—ã¦15å¹´ä»¥ä¸Šã®çµŒé¨“ã‚’æŒã¡ã€<br>
          æ±äº¬ï¼ˆä»£ã€…æœ¨ä¸ŠåŸï¼‰ãƒ»ç¦å²¡ï¼ˆè–¬é™¢ï¼‰ã‚’ä¸­å¿ƒã«ã€å‡ºå¼µæ²»ç™‚ã‚„ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼æ´»å‹•ã‚’è¡Œã„ãªãŒã‚‰ã€<br>
          ã‚»ãƒ«ãƒ•ã‚±ã‚¢ç­‰ã®æƒ…å ±ã‚‚ç™ºä¿¡ã—ã¦ã„ã¾ã™ã€‚
        </p>
        <div class="author-links">
          <a href="https://lin.ee/5vv91n2" target="_blank" class="mini-btn line">LINE</a>
          <a href="https://www.instagram.com/karin._shinkyu" target="_blank" class="mini-btn insta">Instagram</a>
        </div>
      </div>
    </div>

    <div class="blog-footer">
      <a href="{{ url_for('blog') }}" class="btn">ğŸ“š ä¸€è¦§ã«æˆ»ã‚‹</a>
      <a href="{{ url_for('index') }}" class="btn">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
    </div>
  </section>

  <script src="{{ url_for('static', filename='js/main.js') }}"></script>

  <!-- Like -->
  <script>
    const likeBtn = document.getElementById("like-btn");
    const countEl = document.getElementById("like-count");
    const blogId = "{{ blog.id }}";
    let processing = false;

    likeBtn.addEventListener("click", async () => {
      if (processing) return;
      processing = true;

      const res = await fetch(`/api/like/${blogId}`, { method: "POST" });
      const data = await res.json();

      if (data.status === "ok") {
        countEl.textContent = data.count;
        likeBtn.classList.toggle("liked", data.liked);
      }

      processing = false;
    });
  </script>

  <!-- ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡ -->
  <script>
    const submitBtn = document.getElementById("comment-submit");
    const nameInput = document.getElementById("comment-name");
    const bodyInput = document.getElementById("comment-body");

    submitBtn.addEventListener("click", async () => {
      const name = nameInput.value;
      const body = bodyInput.value.trim();

      if (!body) {
        alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      submitBtn.disabled = true;

      try {
        const res = await fetch(`/api/comment/${blogId}`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `name=${encodeURIComponent(name)}&body=${encodeURIComponent(body)}`
        });

        const data = await res.json();

        if (data.success) {
          nameInput.value = "";
          bodyInput.value = "";
          location.reload();
        }
      } catch (e) {
        alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        console.error(e);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>

</body>
</html>
