{% extends "base.html" %}
{% block title %}äºˆç´„ç·¨é›† | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">âœ äºˆç´„ç·¨é›†</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<form method="POST" action="/admin/reservations/{{ reservation.id }}/edit" style="max-width: 800px;">
  <!-- æ‚£è€…æƒ…å ±ï¼ˆç·¨é›†ä¸å¯ï¼‰ -->
  <div style="margin-bottom: 20px; padding: 16px; background: #f5f7fb; border-radius: 8px;">
    <strong style="color: #1E3A5F;">æ‚£è€…ï¼š</strong>
    <a href="/admin/karte/{{ reservation.patient_id }}" style="color: #1E3A5F; text-decoration: none; font-weight: 500;">
      {{ reservation.patient_name or 'æ‚£è€…ä¸æ˜' }}
    </a>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">äºˆç´„æ—¥æ™‚</label>
    <input type="datetime-local" name="reserved_at" value="{{ reservation.reserved_at_display_local }}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ–½è¡“æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
    <select name="duration_minutes" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      <option value="60" {% if reservation.duration_minutes == 60 %}selected{% endif %}>60åˆ†</option>
      <option value="90" {% if reservation.duration_minutes == 90 %}selected{% endif %}>90åˆ†</option>
      <option value="120" {% if reservation.duration_minutes == 120 %}selected{% endif %}>120åˆ†</option>
    </select>
    <input type="number" name="duration_minutes_custom" placeholder="ã¾ãŸã¯æ‰‹å…¥åŠ›ï¼ˆåˆ†ï¼‰" min="15" max="300" step="15" value="{% if reservation.duration_minutes not in [60, 90, 120] %}{{ reservation.duration_minutes }}{% endif %}" style="width: 100%; margin-top: 8px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
    <small style="color: #666; font-size: 0.85rem;">æ‰‹å…¥åŠ›ã‚’é¸æŠã—ãŸå ´åˆã¯ã€ä¸Šè¨˜ã®é¸æŠã¯ç„¡è¦–ã•ã‚Œã¾ã™</small>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ç¾å ´åŒºåˆ†</label>
    <select name="place_type" id="place_type" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <option value="in_house" {% if reservation.place_type == 'in_house' %}selected{% endif %}>é™¢å†…</option>
      <option value="visit" {% if reservation.place_type == 'visit' %}selected{% endif %}>å¾€è¨º</option>
      <option value="field" {% if reservation.place_type == 'field' %}selected{% endif %}>å¸¯åŒ</option>
    </select>
  </div>
  
  <div style="margin-bottom: 20px; {% if reservation.place_type not in ['visit', 'field'] %}display: none;{% endif %}" id="place_name_wrapper">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ç¾å ´å</label>
    <input type="text" name="place_name" value="{{ reservation.place_name or '' }}" placeholder="ç¾å ´åã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•</label>
    <select name="staff_name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      {% for staff in staff_list %}
        <option value="{{ staff.name }}" {% if staff.name == reservation.staff_name %}selected{% endif %}>{{ staff.name }}</option>
      {% endfor %}
    </select>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
    <select name="status" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      <option value="reserved" {% if reservation.status == 'reserved' %}selected{% endif %}>äºˆç´„ä¸­</option>
      <option value="visited" {% if reservation.status == 'visited' %}selected{% endif %}>æ¥é™¢æ¸ˆ</option>
      <option value="completed" {% if reservation.status == 'completed' %}selected{% endif %}>å®Œäº†</option>
      <option value="canceled" {% if reservation.status == 'canceled' %}selected{% endif %}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
    </select>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ãƒ¡ãƒ¢</label>
    <textarea name="memo" rows="3" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">{{ reservation.memo or '' }}</textarea>
  </div>
  
  <div style="display: flex; gap: 12px; margin-top: 30px;">
    <button type="submit" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer;">ğŸ’¾ æ›´æ–°</button>
    <a href="/admin/reservations" class="admin-karte-detail-btn-back" style="text-decoration: none; display: inline-block; text-align: center;">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
  </div>
</form>

<script>
// ç¾å ´åŒºåˆ†ã«å¿œã˜ã¦ç¾å ´åå…¥åŠ›æ¬„ã‚’è¡¨ç¤º/éè¡¨ç¤º
document.getElementById('place_type').addEventListener('change', function() {
  const placeType = this.value;
  const placeNameWrapper = document.getElementById('place_name_wrapper');
  if (placeType === 'visit' || placeType === 'field') {
    placeNameWrapper.style.display = 'block';
  } else {
    placeNameWrapper.style.display = 'none';
  }
});

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
document.querySelector('form').addEventListener('submit', function(e) {
  // äºˆç´„æ—¥æ™‚ã®ãƒã‚§ãƒƒã‚¯
  const reservedAt = document.querySelector('input[name="reserved_at"]').value;
  if (!reservedAt) {
    e.preventDefault();
    alert('äºˆç´„æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return false;
  }
  
  // ç¾å ´åŒºåˆ†ã®ãƒã‚§ãƒƒã‚¯
  const placeType = document.getElementById('place_type').value;
  if (!placeType) {
    e.preventDefault();
    alert('ç¾å ´åŒºåˆ†ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return false;
  }
  
  // æ‰‹å…¥åŠ›ã®æ–½è¡“æ™‚é–“ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰ã€selectã®å€¤ã‚’ä¸Šæ›¸ã
  const customDuration = document.querySelector('input[name="duration_minutes_custom"]').value;
  if (customDuration) {
    const select = document.querySelector('select[name="duration_minutes"]');
    select.value = customDuration;
  }
});
</script>

{% endblock %}
