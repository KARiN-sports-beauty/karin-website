{% extends "base.html" %}
{% block title %}äºˆç´„ç·¨é›† | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">âœ äºˆç´„ç·¨é›†</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<form method="POST" action="/admin/reservations/{{ reservation.id }}/edit" style="max-width: 800px;">
  <!-- æ‚£è€…æƒ…å ±ï¼ˆç·¨é›†ä¸å¯ï¼‰ -->
  <div style="margin-bottom: 20px; padding: 16px; background: #f5f7fb; border-radius: 8px;">
    <strong style="color: #1E3A5F;">æ‚£è€…ï¼š</strong>
    <a href="/admin/karte/{{ reservation.patient_id }}" style="color: #1E3A5F; text-decoration: none; font-weight: 500;">
      {{ reservation.patient_name or 'æ‚£è€…ä¸æ˜' }}
    </a>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">äºˆç´„æ—¥æ™‚</label>
    <input type="datetime-local" name="reserved_at" value="{{ reservation.reserved_at_display_local }}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ã‚¨ãƒªã‚¢ï¼ˆå¿…é ˆï¼‰</label>
    <select name="area" id="area" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <option value="tokyo" {% if reservation.area == 'tokyo' %}selected{% endif %}>æ±äº¬</option>
      <option value="fukuoka" {% if reservation.area == 'fukuoka' %}selected{% endif %}>ç¦å²¡</option>
    </select>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå¿…é ˆï¼‰</label>
    <select name="menu" id="menu" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      <option value="">ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
    </select>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ç¾å ´åŒºåˆ†</label>
    <select name="place_type" id="place_type" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <option value="in_house" {% if reservation.place_type == 'in_house' %}selected{% endif %}>é™¢å†…</option>
      <option value="visit" {% if reservation.place_type == 'visit' %}selected{% endif %}>å¾€è¨º</option>
      <option value="field" {% if reservation.place_type == 'field' %}selected{% endif %}>å¸¯åŒ</option>
    </select>
  </div>
  
  <div style="margin-bottom: 20px; {% if reservation.place_type not in ['visit', 'field'] %}display: none;{% endif %}" id="place_name_wrapper">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ç¾å ´å</label>
    <input type="text" name="place_name" value="{{ reservation.place_name or '' }}" placeholder="ç¾å ´åã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æŒ‡åã‚¿ã‚¤ãƒ—ï¼ˆå¿…é ˆï¼‰</label>
    <div style="display: flex; flex-direction: column; gap: 8px;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="nomination_type" value="æœ¬æŒ‡å" {% if reservation.nomination_type == 'æœ¬æŒ‡å' or reservation.nomination_type == 'main' or not reservation.nomination_type %}checked{% endif %} onchange="updateNominationUI()">
        <span>æœ¬æŒ‡å</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="nomination_type" value="æ æŒ‡å" {% if reservation.nomination_type == 'æ æŒ‡å' or reservation.nomination_type == 'frame' %}checked{% endif %} onchange="updateNominationUI()">
        <span>æ æŒ‡åï¼ˆå…¨ã‚¹ã‚¿ãƒƒãƒ•é¸æŠå¯èƒ½ï¼‰</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="nomination_type" value="å¸Œæœ›" {% if reservation.nomination_type == 'å¸Œæœ›' or reservation.nomination_type == 'hope' %}checked{% endif %} onchange="updateNominationUI()">
        <span>å¸Œæœ›</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="nomination_type" value="ãƒ•ãƒªãƒ¼" {% if reservation.nomination_type == 'ãƒ•ãƒªãƒ¼' or reservation.nomination_type == 'free' %}checked{% endif %} onchange="updateNominationUI()">
        <span>ãƒ•ãƒªãƒ¼</span>
      </label>
    </div>
  </div>
  
  <!-- æ æŒ‡åç”¨ã®ã‚¹ã‚¿ãƒƒãƒ•é¸æŠï¼ˆå…¨ã‚¹ã‚¿ãƒƒãƒ•é¸æŠå¯èƒ½ï¼‰ -->
  <div id="frame_nomination_section" style="margin-bottom: 20px; {% if reservation.nomination_type != 'æ æŒ‡å' and reservation.nomination_type != 'frame' %}display: none;{% endif %}">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">å¯¾å¿œã‚¹ã‚¿ãƒƒãƒ•ï¼ˆå…¨ã‚¹ã‚¿ãƒƒãƒ•é¸æŠå¯èƒ½ï¼‰</label>
    <div id="frame_staff_list" style="display: flex; flex-direction: column; gap: 8px;">
      <!-- JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
    </div>
    <button type="button" id="add_frame_staff_btn" style="margin-top: 8px; padding: 6px 12px; background: #1E3A5F; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">â• ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ </button>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•</label>
    <select name="staff_name" id="staff_name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      {% for staff in staff_list %}
        <option value="{{ staff.name }}" {% if staff.name == reservation.staff_name %}selected{% endif %}>{{ staff.name }}</option>
      {% endfor %}
    </select>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
    <input type="number" name="base_price" id="base_price" value="{{ reservation.base_price or '' }}" min="0" step="100" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
    <small style="color: #666; font-size: 0.85rem;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠã§è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼ˆç·¨é›†å¯ï¼‰</small>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
    <select name="status" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      <option value="reserved" {% if reservation.status == 'reserved' %}selected{% endif %}>äºˆç´„ä¸­</option>
      <option value="visited" {% if reservation.status == 'visited' %}selected{% endif %}>æ¥é™¢æ¸ˆ</option>
      <option value="completed" {% if reservation.status == 'completed' %}selected{% endif %}>å®Œäº†</option>
      <option value="canceled" {% if reservation.status == 'canceled' %}selected{% endif %}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
    </select>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ãƒ¡ãƒ¢</label>
    <textarea name="memo" rows="3" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">{{ reservation.memo or '' }}</textarea>
  </div>
  
  <div style="display: flex; gap: 12px; margin-top: 30px;">
    <button type="submit" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer;">ğŸ’¾ æ›´æ–°</button>
    <a href="/admin/reservations" class="admin-karte-detail-btn-back" style="text-decoration: none; display: inline-block; text-align: center;">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
  </div>
</form>

<script>
// ãƒ¡ãƒ‹ãƒ¥ãƒ¼å®šç¾©ï¼ˆã‚¨ãƒªã‚¢åˆ¥ãƒ»æ™‚é–“åˆ¥ï¼‰
const menuPrices = {
  tokyo: {
    60: 11000,
    90: 16500,
    120: 22000
  },
  fukuoka: {
    60: 8800,
    90: 13200,
    120: 17600
  }
};

// ã‚¨ãƒªã‚¢å¤‰æ›´æ™‚ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°
document.getElementById('area').addEventListener('change', function() {
  const area = this.value;
  const menuSelect = document.getElementById('menu');
  const placeTypeSelect = document.getElementById('place_type');
  const placeType = placeTypeSelect ? placeTypeSelect.value : '';
  
  menuSelect.innerHTML = '<option value="">ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
  
  // å¸¯åŒã®å ´åˆã¯ã€Œãã®ä»–ã€ã‚’è¿½åŠ 
  if (placeType === 'field') {
    const otherOption = document.createElement('option');
    otherOption.value = 'other';
    otherOption.textContent = 'ãã®ä»–ï¼ˆå¸¯åŒï¼‰';
    otherOption.dataset.price = '';
    menuSelect.appendChild(otherOption);
  }
  
  if (area && menuPrices[area]) {
    const prices = menuPrices[area];
    for (const [minutes, price] of Object.entries(prices)) {
      const option = document.createElement('option');
      option.value = minutes;
      option.textContent = `${minutes}åˆ†ã‚³ãƒ¼ã‚¹ï¼ˆÂ¥${price.toLocaleString()}ï¼‰`;
      option.dataset.price = price;
      if (minutes == {{ reservation.duration_minutes or 90 }}) {
        option.selected = true;
      }
      menuSelect.appendChild(option);
    }
  }
  
  updatePrice();
});

// ç¾å ´åŒºåˆ†å¤‰æ›´æ™‚ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°ï¼ˆå¸¯åŒã®å ´åˆã¯ã€Œãã®ä»–ã€ã‚’è¿½åŠ ï¼‰
document.getElementById('place_type').addEventListener('change', function() {
  const placeType = this.value;
  const area = document.getElementById('area').value;
  const menuSelect = document.getElementById('menu');
  
  // å¸¯åŒã®å ´åˆã¯ã€Œãã®ä»–ã€ã‚’è¿½åŠ 
  if (placeType === 'field') {
    // æ—¢å­˜ã®ã€Œãã®ä»–ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
    const existingOther = Array.from(menuSelect.options).find(opt => opt.value === 'other');
    if (existingOther) {
      existingOther.remove();
    }
    
    // ã€Œãã®ä»–ã€ã‚’å…ˆé ­ã«è¿½åŠ 
    const otherOption = document.createElement('option');
    otherOption.value = 'other';
    otherOption.textContent = 'ãã®ä»–ï¼ˆå¸¯åŒï¼‰';
    otherOption.dataset.price = '';
    menuSelect.insertBefore(otherOption, menuSelect.firstChild.nextSibling);
  } else {
    // å¸¯åŒä»¥å¤–ã®å ´åˆã¯ã€Œãã®ä»–ã€ã‚’å‰Šé™¤
    const existingOther = Array.from(menuSelect.options).find(opt => opt.value === 'other');
    if (existingOther) {
      existingOther.remove();
    }
  }
  
  updatePrice();
});

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠæ™‚ã«ä¾¡æ ¼ã‚’è‡ªå‹•å…¥åŠ›
document.getElementById('menu').addEventListener('change', function() {
  updatePrice();
});

// ä¾¡æ ¼æ›´æ–°é–¢æ•°
function updatePrice() {
  const area = document.getElementById('area').value;
  const menuSelect = document.getElementById('menu');
  const basePriceInput = document.getElementById('base_price');
  
  if (menuSelect.value) {
    const selectedOption = menuSelect.options[menuSelect.selectedIndex];
    if (selectedOption && selectedOption.dataset.price) {
      basePriceInput.value = selectedOption.dataset.price;
    } else if (selectedOption && selectedOption.value === 'other') {
      // ã€Œãã®ä»–ã€ã®å ´åˆã¯ä¾¡æ ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ‰‹å…¥åŠ›ï¼‰
      basePriceInput.value = '';
    } else {
      basePriceInput.value = '';
    }
  } else {
    basePriceInput.value = '';
  }
}

// æŒ‡åã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®UIæ›´æ–°
function updateNominationUI() {
  const nominationType = document.querySelector('input[name="nomination_type"]:checked').value;
  const frameSection = document.getElementById('frame_nomination_section');
  const staffNameSelect = document.getElementById('staff_name');
  
  if (nominationType === 'æ æŒ‡å') {
    frameSection.style.display = 'block';
    staffNameSelect.removeAttribute('required');
  } else {
    frameSection.style.display = 'none';
    staffNameSelect.setAttribute('required', 'required');
    // æ æŒ‡åã®ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
    document.getElementById('frame_staff_list').innerHTML = '';
  }
}

// æ æŒ‡åã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ 
let frameStaffCount = 0;
const staffList = {{ staff_list | tojson if staff_list else '[]' }};

document.getElementById('add_frame_staff_btn').addEventListener('click', function() {
  frameStaffCount++;
  const container = document.getElementById('frame_staff_list');
  const div = document.createElement('div');
  div.style.cssText = 'display: flex; gap: 8px; align-items: center;';
  div.innerHTML = `
    <select name="frame_staff_${frameStaffCount}" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      ${staffList.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
    </select>
    <select name="frame_priority_${frameStaffCount}" required style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
      <option value="1">å„ªå…ˆ1</option>
      <option value="2">å„ªå…ˆ2</option>
      <option value="3">å„ªå…ˆ3</option>
    </select>
    <button type="button" class="remove-frame-staff" style="padding: 6px 12px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">å‰Šé™¤</button>
  `;
  
  container.appendChild(div);
  
  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  div.querySelector('.remove-frame-staff').addEventListener('click', function() {
    div.remove();
    frameStaffCount--;
  });
});

// åˆæœŸåŒ–ï¼šã‚¨ãƒªã‚¢ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°
document.addEventListener('DOMContentLoaded', function() {
  const areaSelect = document.getElementById('area');
  const basePriceInput = document.getElementById('base_price');
  
  // åˆæœŸåŒ–æ™‚ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°
  if (areaSelect.value) {
    areaSelect.dispatchEvent(new Event('change'));
    // æ—¢å­˜ã®æ–½è¡“æ™‚é–“ã«åˆã‚ã›ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠ
    const menuSelect = document.getElementById('menu');
    const existingDuration = {{ reservation.duration_minutes or 90 }};
    if (menuSelect.options.length > 1) {
      for (let i = 0; i < menuSelect.options.length; i++) {
        if (menuSelect.options[i].value == existingDuration) {
          menuSelect.selectedIndex = i;
          updatePrice();
          break;
        }
      }
    }
  }
  
  // åˆæœŸåŒ–æ™‚ã«ç¾å ´åŒºåˆ†ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°
  const placeTypeSelect = document.getElementById('place_type');
  if (placeTypeSelect && placeTypeSelect.value === 'field') {
    const area = document.getElementById('area').value;
    if (area) {
      document.getElementById('area').dispatchEvent(new Event('change'));
    }
  }
  
  // æ—¢å­˜ã®æ æŒ‡åã‚¹ã‚¿ãƒƒãƒ•ã‚’è¡¨ç¤ºï¼ˆç·¨é›†æ™‚ãƒ»å…¨ã‚¹ã‚¿ãƒƒãƒ•é¸æŠå¯èƒ½ï¼‰
  {% if (reservation.nomination_type == 'æ æŒ‡å' or reservation.nomination_type == 'frame') and reservation.nominated_staff_ids %}
  const nominatedStaffIds = {{ reservation.nominated_staff_ids | tojson if reservation.nominated_staff_ids else '[]' }};
  const nominationPriority = {{ reservation.nomination_priority or 1 }};
  if (nominatedStaffIds && nominatedStaffIds.length > 0) {
    nominatedStaffIds.forEach((staffName, index) => {
      frameStaffCount++;
      const container = document.getElementById('frame_staff_list');
      const div = document.createElement('div');
      div.style.cssText = 'display: flex; gap: 8px; align-items: center;';
      const priority = (index === 0 && nominationPriority) ? nominationPriority : (index + 1);
      div.innerHTML = `
        <select name="frame_staff_${frameStaffCount}" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          ${staffList.map(s => `<option value="${s.name}" ${s.name == staffName ? 'selected' : ''}>${s.name}</option>`).join('')}
        </select>
        <select name="frame_priority_${frameStaffCount}" required style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
          <option value="1" ${priority == 1 ? 'selected' : ''}>å„ªå…ˆ1</option>
          <option value="2" ${priority == 2 ? 'selected' : ''}>å„ªå…ˆ2</option>
          <option value="3" ${priority == 3 ? 'selected' : ''}>å„ªå…ˆ3</option>
        </select>
        <button type="button" class="remove-frame-staff" style="padding: 6px 12px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">å‰Šé™¤</button>
      `;
      container.appendChild(div);
      div.querySelector('.remove-frame-staff').addEventListener('click', function() {
        div.remove();
        frameStaffCount--;
      });
    });
  }
  {% endif %}
});

// ç¾å ´åŒºåˆ†ã«å¿œã˜ã¦ç¾å ´åå…¥åŠ›æ¬„ã‚’è¡¨ç¤º/éè¡¨ç¤º
document.getElementById('place_type').addEventListener('change', function() {
  const placeType = this.value;
  const placeNameWrapper = document.getElementById('place_name_wrapper');
  if (placeType === 'visit' || placeType === 'field') {
    placeNameWrapper.style.display = 'block';
  } else {
    placeNameWrapper.style.display = 'none';
  }
});

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
document.querySelector('form').addEventListener('submit', function(e) {
  // äºˆç´„æ—¥æ™‚ã®ãƒã‚§ãƒƒã‚¯
  const reservedAt = document.querySelector('input[name="reserved_at"]').value;
  if (!reservedAt) {
    e.preventDefault();
    alert('äºˆç´„æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return false;
  }
  
  // ç¾å ´åŒºåˆ†ã®ãƒã‚§ãƒƒã‚¯
  const placeType = document.getElementById('place_type').value;
  if (!placeType) {
    e.preventDefault();
    alert('ç¾å ´åŒºåˆ†ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return false;
  }
  
});
</script>

{% endblock %}
