{% extends "base.html" %}
{% block title %}äºˆç´„ç®¡ç† | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">ğŸ“… äºˆç´„ç®¡ç†</h2>

<!-- æœˆç§»å‹•ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="admin-resv-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 16px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
  <a href="/admin/reservations?ym={{ prev_month }}&day={{ selected_day }}" class="admin-resv-nav-btn" style="padding: 8px 16px; background: #1E3A5F; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 500;">â† å‰æœˆ</a>
  <h3 style="margin: 0; font-size: 1.3rem; font-weight: 600; color: #1E3A5F;">{{ current_date.strftime('%Yå¹´%mæœˆ') }}</h3>
  <a href="/admin/reservations?ym={{ next_month }}&day={{ selected_day }}" class="admin-resv-nav-btn" style="padding: 8px 16px; background: #1E3A5F; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 500;">æ¬¡æœˆ â†’</a>
</div>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
<div style="margin-bottom: 20px; padding: 16px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
  <form method="GET" action="/admin/reservations" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
    <input type="hidden" name="ym" value="{{ current_ym }}">
    <input type="hidden" name="day" value="{{ selected_day }}">
    
    <label style="display: flex; align-items: center; gap: 8px;">
      <span style="font-weight: 500; color: #1E3A5F;">ç¾å ´åŒºåˆ†ï¼š</span>
      <select name="place_type" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem;">
        <option value="all" {% if place_type_filter == 'all' %}selected{% endif %}>ã™ã¹ã¦</option>
        <option value="in_house" {% if place_type_filter == 'in_house' %}selected{% endif %}>é™¢å†…</option>
        <option value="visit" {% if place_type_filter == 'visit' %}selected{% endif %}>å¾€è¨º</option>
        <option value="field" {% if place_type_filter == 'field' %}selected{% endif %}>å¸¯åŒ</option>
      </select>
    </label>
    
    <label style="display: flex; align-items: center; gap: 8px;">
      <span style="font-weight: 500; color: #1E3A5F;">ã‚¹ã‚¿ãƒƒãƒ•ï¼š</span>
      <select name="staff" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem;">
        <option value="all" {% if staff_filter == 'all' %}selected{% endif %}>ã™ã¹ã¦</option>
        {% for staff in staff_list %}
        <option value="{{ staff.name }}" {% if staff_filter == staff.name %}selected{% endif %}>{{ staff.name }}</option>
        {% endfor %}
      </select>
    </label>
    
    <button type="submit" style="padding: 8px 16px; background: #1E3A5F; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">é©ç”¨</button>
    <a href="/admin/reservations/new" style="padding: 8px 16px; background: #4CAF50; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 500;">â• æ–°è¦äºˆç´„</a>
  </form>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ + ä¸€è¦§ï¼‰ -->
<div class="admin-resv-grid">
  {% if current_date %}
  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="admin-resv-calendar">
    <div class="admin-resv-calendar-header">
      <div>æ—¥</div>
      <div>æœˆ</div>
      <div>ç«</div>
      <div>æ°´</div>
      <div>æœ¨</div>
      <div>é‡‘</div>
      <div>åœŸ</div>
    </div>
    
    <div class="admin-resv-calendar-days">
      {# å‰æœˆã®ç©ºç™½ã‚»ãƒ« #}
      {% for i in range(first_weekday) %}
      <div style="aspect-ratio: 1; background: #f5f7fb; border-radius: 8px;"></div>
      {% endfor %}
      
      {# å½“æœˆã®æ—¥ä»˜ã‚»ãƒ« #}
      {% for day_num in range(1, days_in_month + 1) %}
        {% set day_key = '%04d-%02d-%02d'|format(current_date.year, current_date.month, day_num) %}
        {% set is_selected = (day_key == selected_day.strftime('%Y-%m-%d')) %}
        {% set count = counts_by_day.get(day_key, 0) %}
        {% set today_str = now_jst.strftime('%Y-%m-%d') %}
        {% set is_today = (day_key == today_str) %}
        
        <a href="/admin/reservations?ym={{ current_ym }}&day={{ day_key }}&place_type={{ place_type_filter }}&staff={{ staff_filter }}" 
           class="admin-resv-day {% if is_selected %}selected{% endif %} {% if is_today %}today{% endif %}">
          <span style="font-size: 1rem; font-weight: 600;">{{ day_num }}</span>
          {% if count > 0 %}
          <span class="admin-resv-badge">{{ count }}</span>
          {% endif %}
        </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  
  <!-- é¸æŠæ—¥ã®äºˆç´„ä¸€è¦§ -->
  <div class="admin-resv-list">
    <h3 style="margin: 0 0 16px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">
      {{ selected_day.strftime('%Yå¹´%mæœˆ%dæ—¥') }}ã®äºˆç´„
    </h3>
    
    {% if reservations_of_day %}
    <div style="display: flex; flex-direction: column; gap: 12px;">
      {% for reservation in reservations_of_day %}
      <div class="admin-resv-card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
          <div>
            <div style="font-size: 1.1rem; font-weight: 600; color: #1E3A5F; margin-bottom: 4px;">{{ reservation.reserved_at_display or 'æ™‚åˆ»ä¸æ˜' }}</div>
            <a href="/admin/karte/{{ reservation.patient_id }}" style="font-size: 1rem; font-weight: 500; color: #1E3A5F; text-decoration: none;">
              {{ reservation.patient_name or 'æ‚£è€…ä¸æ˜' }}
            </a>
          </div>
          <span class="admin-resv-status admin-resv-status-{{ reservation.status }}">
            {% if reservation.status == 'reserved' %}äºˆç´„ä¸­
            {% elif reservation.status == 'visited' %}æ¥é™¢æ¸ˆ
            {% elif reservation.status == 'completed' %}å®Œäº†
            {% elif reservation.status == 'canceled' %}ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            {% else %}{{ reservation.status }}{% endif %}
          </span>
        </div>
        
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 0.9rem; color: #666;">
          {% set place_map = {'in_house':'é™¢å†…','visit':'å¾€è¨º','field':'å¸¯åŒ'} %}
          <span>ç¾å ´ï¼š{{ place_map.get(reservation.place_type, reservation.place_type) }}</span>
          {% if reservation.place_name %}
          <span>ï¼ˆ{{ reservation.place_name }}ï¼‰</span>
          {% endif %}
          {% if reservation.staff_name %}
          <span>ï½œã‚¹ã‚¿ãƒƒãƒ•ï¼š{{ reservation.staff_name }}</span>
          {% endif %}
          <span>ï½œ{{ reservation.duration_minutes or 60 }}åˆ†</span>
        </div>
        
        {% if reservation.memo %}
        <div style="margin-bottom: 12px; padding: 8px; background: #fff; border-radius: 6px; font-size: 0.9rem; color: #666;">
          {{ reservation.memo }}
        </div>
        {% endif %}
        
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <a href="/admin/karte/{{ reservation.patient_id }}/log/new?date={{ selected_day.strftime('%Y-%m-%d') }}" 
             class="admin-resv-btn" 
             style="padding: 6px 12px; background: #4CAF50; color: #fff; text-decoration: none; border-radius: 6px; font-size: 0.85rem; font-weight: 500;">
            ğŸ“ ãƒ­ã‚°ä½œæˆ
          </a>
          
          {% if reservation.status == 'reserved' %}
          <form action="/admin/reservations/{{ reservation.id }}/status" method="POST" style="display: inline;">
            <input type="hidden" name="status" value="visited">
            <button type="submit" style="padding: 6px 12px; background: #2196F3; color: #fff; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer;">âœ“ æ¥é™¢æ¸ˆ</button>
          </form>
          {% endif %}
          
          {% if reservation.status == 'visited' %}
          <form action="/admin/reservations/{{ reservation.id }}/status" method="POST" style="display: inline;">
            <input type="hidden" name="status" value="completed">
            <button type="submit" style="padding: 6px 12px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer;">âœ“ å®Œäº†</button>
          </form>
          {% endif %}
          
          {% if reservation.status != 'canceled' %}
          <form action="/admin/reservations/{{ reservation.id }}/status" method="POST" style="display: inline;">
            <input type="hidden" name="status" value="canceled">
            <button type="submit" style="padding: 6px 12px; background: #f44336; color: #fff; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer;" onclick="return confirm('ã“ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ');">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </form>
          {% endif %}
          
          <form action="/admin/reservations/{{ reservation.id }}/delete" method="POST" style="display: inline;" onsubmit="return confirm('ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
            <button type="submit" style="padding: 6px 12px; background: #999; color: #fff; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer;">ğŸ—‘ å‰Šé™¤</button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p style="color: #999; text-align: center; padding: 40px 0;">ã“ã®æ—¥ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</p>
    {% endif %}
  </div>
</div>


{% endblock %}
