{% extends "base.html" %}
{% block title %}ã‚¹ã‚¿ãƒƒãƒ•çµ¦ä¸ - ç·¨é›† | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">âœï¸ ã‚¹ã‚¿ãƒƒãƒ•çµ¦ä¸ - ç·¨é›†ï¼ˆ{{ year }}å¹´{{ month }}æœˆï¼‰</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<div style="margin-bottom: 20px;">
  <a href="/admin/financial/years/{{ year }}/months/{{ month }}" class="admin-karte-detail-btn-back" style="text-decoration: none;">â† {{ year }}å¹´{{ month }}æœˆã®åæ”¯ç®¡ç†ã«æˆ»ã‚‹</a>
</div>

<form method="POST" action="/admin/financial/years/{{ year }}/months/{{ month }}/salaries/{{ salary.id }}/edit" style="max-width: 800px;">
  <div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-bottom: 20px;">
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">ã‚¹ã‚¿ãƒƒãƒ•<span style="color: #f44336;">*</span></label>
      <select name="staff_id" id="staff_id" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;" onchange="updateStaffName(); loadSalaryCalculation();">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        {% for staff in staff_list %}
        <option value="{{ staff.id }}" data-name="{{ staff.name }}" data-area="{{ staff.area or 'tokyo' }}" {% if salary.staff_id == staff.id %}selected{% endif %}>{{ staff.name }}</option>
        {% endfor %}
      </select>
      <input type="hidden" name="staff_name" id="staff_name" value="{{ salary.staff_name or '' }}">
      {% if salary_calculation %}
      <button type="button" id="auto_calc_btn" onclick="applyAutoCalculation()" style="margin-top: 8px; padding: 8px 16px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">ğŸ’° è‡ªå‹•è¨ˆç®—ã‚’é©ç”¨</button>
      {% endif %}
      <input type="hidden" name="use_auto_calc" id="use_auto_calc" value="false">
    </div>
    
    {% if salary_calculation %}
    <div id="salary_calc_info" style="margin-bottom: 20px; padding: 12px; background: #e8f5e9; border-radius: 8px;">
      <div style="font-size: 0.9rem; color: #2e7d32; margin-bottom: 8px;"><strong>è‡ªå‹•è¨ˆç®—çµæœ</strong></div>
      <div style="font-size: 0.85rem; color: #666;">
        <div>å®Ÿåƒæ™‚é–“: <span id="calc_working_hours">{{ salary_calculation.working_hours|round(1) }}</span>æ™‚é–“</div>
        <div>å£²ä¸Š: Â¥<span id="calc_revenue">{{ salary_calculation.revenue|int|string|replace(',', '')|int|string|replace(',', ',') }}</span></div>
        <div>åŸºæœ¬çµ¦: Â¥<span id="calc_base_salary">{{ salary_calculation.base_salary|int|string|replace(',', '')|int|string|replace(',', ',') }}</span></div>
        <div>è³‡æ ¼çµ¦: Â¥<span id="calc_commission">{{ salary_calculation.commission|int|string|replace(',', '')|int|string|replace(',', ',') }}</span></div>
        <div>æ­©åˆçµ¦: Â¥<span id="calc_nomination_fee">{{ salary_calculation.nomination_fee|int|string|replace(',', '')|int|string|replace(',', ',') }}</span></div>
        <div>äº¤é€šè²»: Â¥<span id="calc_transportation">{{ salary_calculation.transportation|int|string|replace(',', '')|int|string|replace(',', ',') }}</span></div>
        <div>ç‰¹åˆ¥çµ¦ï¼ˆ6æœˆ/12æœˆï¼‰: Â¥<span id="calc_special_bonus">0</span></div>
      </div>
    </div>
    {% endif %}
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">åŸºæœ¬çµ¦</label>
        <input type="number" name="base_salary" id="base_salary" min="0" step="0.01" value="{{ salary.base_salary or 0 }}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">è³‡æ ¼çµ¦</label>
        <input type="number" name="commission" id="commission" min="0" step="0.01" value="{{ salary.commission or 0 }}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">æ­©åˆçµ¦</label>
        <input type="number" name="nomination_fee" id="nomination_fee" min="0" step="0.01" value="{{ salary.nomination_fee or 0 }}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">äº¤é€šè²»</label>
        <input type="number" name="transportation" id="transportation" min="0" step="0.01" value="{{ salary.transportation or 0 }}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">ç¨é‡‘</label>
        <input type="number" name="tax" min="0" step="0.01" value="{{ salary.tax or 0 }}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">ç¤¾ä¼šä¿é™º</label>
        <input type="number" name="social_insurance" min="0" step="0.01" value="{{ salary.social_insurance or 0 }}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">ãã®ä»–æ§é™¤</label>
        <input type="number" name="other_deduction" min="0" step="0.01" value="{{ salary.other_deduction or 0 }}" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">ç‰¹åˆ¥çµ¦ï¼ˆ6æœˆ/12æœˆï¼‰</label>
      <input type="number" name="special_bonus" id="special_bonus" min="0" step="0.01" value="{{ salary.special_bonus or 0 }}" readonly style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: #f5f7fb;">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">ãƒ¡ãƒ¢</label>
      <textarea name="memo" rows="3" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; font-family: inherit;">{{ salary.memo or '' }}</textarea>
    </div>
    
    <div style="margin-top: 24px;">
      <button type="submit" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer; padding: 12px 24px; font-size: 1rem;">æ›´æ–°</button>
      <a href="/admin/financial/years/{{ year }}/months/{{ month }}" class="admin-karte-detail-btn-back" style="text-decoration: none; margin-left: 12px; padding: 12px 24px; display: inline-block;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
    </div>
  </div>
</form>

<script>
const salaryCalculation = {{ salary_calculation | tojson if salary_calculation else 'null' }};
const targetMonth = {{ month|int }};

function updateStaffName() {
  const select = document.getElementById('staff_id');
  const hidden = document.getElementById('staff_name');
  const selectedOption = select.options[select.selectedIndex];
  if (selectedOption.value) {
    hidden.value = selectedOption.getAttribute('data-name');
  } else {
    hidden.value = '';
  }
}

function loadSalaryCalculation() {
  // ç·¨é›†æ™‚ã¯æ—¢ã«è¨ˆç®—çµæœãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã‚¹ã‚¿ãƒƒãƒ•å¤‰æ›´æ™‚ã®ã¿å†è¨ˆç®—ãŒå¿…è¦
  // ç¾æ™‚ç‚¹ã§ã¯å®Ÿè£…ã—ãªã„ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ å¯èƒ½ï¼‰
}

function applyAutoCalculation() {
  if (salaryCalculation) {
    document.getElementById('nomination_fee').value = salaryCalculation.nomination_fee;
    document.getElementById('transportation').value = salaryCalculation.transportation;
    updateSpecialBonus(salaryCalculation);
    document.getElementById('use_auto_calc').value = 'true';
    alert('è‡ªå‹•è¨ˆç®—ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§èª¿æ•´ã—ã¦ãã ã•ã„ã€‚');
  }
}

function updateSpecialBonus(calc) {
  const bonusInput = document.getElementById('special_bonus');
  const bonusLabel = document.getElementById('calc_special_bonus');
  if (!bonusInput || !bonusLabel) return;

  if (targetMonth !== 6 && targetMonth !== 12) {
    bonusInput.value = 0;
    bonusLabel.textContent = 0;
    return;
  }

  const baseSalary = parseFloat(document.getElementById('base_salary').value) || 0;
  const qualificationPay = parseFloat(document.getElementById('commission').value) || 0;
  const performancePay = parseFloat(document.getElementById('nomination_fee').value) || 0;
  const revenue = calc?.half_year_revenue || 0;
  const existingTotal = calc?.half_year_existing_total || 0;
  const bonus = Math.max(0, Math.floor(revenue * 0.35) - (existingTotal + baseSalary + qualificationPay + performancePay));
  bonusInput.value = bonus;
  bonusLabel.textContent = bonus.toLocaleString();
}

document.getElementById('base_salary')?.addEventListener('input', () => {
  if (salaryCalculation) updateSpecialBonus(salaryCalculation);
});
document.getElementById('commission')?.addEventListener('input', () => {
  if (salaryCalculation) updateSpecialBonus(salaryCalculation);
});
document.getElementById('nomination_fee')?.addEventListener('input', () => {
  if (salaryCalculation) updateSpecialBonus(salaryCalculation);
});

if (salaryCalculation) {
  updateSpecialBonus(salaryCalculation);
}
</script>

{% endblock %}

