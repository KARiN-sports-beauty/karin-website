{% extends "base.html" %}
{% block title %}å‚™å“ç®¡ç† - {{ year }}å¹´ | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">ğŸ“¦ å‚™å“ç®¡ç† - {{ year }}å¹´</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
  <a href="/admin/equipment" class="admin-karte-detail-btn-back" style="text-decoration: none;">â† å¹´é¸æŠã«æˆ»ã‚‹</a>
  <a href="/admin/equipment/years/{{ year }}/initial-stock/new" class="admin-karte-detail-btn-primary" style="text-decoration: none;">â• å¹´åˆåœ¨åº«è¿½åŠ </a>
  <a href="/admin/equipment/years/{{ year }}/takeouts/new" class="admin-karte-detail-btn-primary" style="text-decoration: none;">ğŸ“¤ æŒã¡å‡ºã—ç™»éŒ²</a>
  <a href="/admin/equipment/years/{{ year }}/orders/new" class="admin-karte-detail-btn-primary" style="text-decoration: none;">ğŸ“¦ ç™ºæ³¨ç™»éŒ²</a>
  {% set prev_year = year|int - 1 %}
  <form method="POST" action="/admin/equipment/years/{{ year }}/copy-from-previous" style="display: inline;" onsubmit="return confirm('{{ prev_year }}å¹´ã®ç¾åœ¨åº«æ•°ã‚’{{ year }}å¹´ã®å¹´åˆåœ¨åº«æ•°ã¨ã—ã¦å¼•ãç¶™ãã¾ã™ã‹ï¼Ÿ');">
    <button type="submit" class="admin-karte-detail-btn-secondary" style="border: none; cursor: pointer; padding: 10px 20px; font-size: 0.9rem;">ğŸ“‹ å‰å¹´ã‹ã‚‰å¼•ãç¶™ã</button>
  </form>
</div>

<!-- å‚™å“ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
<div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-bottom: 20px;">
  <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">å‚™å“ä¸€è¦§</h3>
  
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f5f7fb;">
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">å‚™å“å</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">å¹´åˆåœ¨åº«æ•°</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">ç¾åœ¨åº«æ•°</th>
        </tr>
      </thead>
      <tbody>
        {% for item in equipment_items %}
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">
            {{ item.name }}{% if item.unit %}ï¼ˆ{{ item.unit }}ï¼‰{% endif %}
          </td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">
            {% set initial = initial_stock_map.get(item.id, 0) %}
            {% if initial > 0 %}
              {{ initial }}{% if item.unit %}{{ item.unit }}{% endif %}
              {% for stock in initial_stocks %}
                {% if stock.equipment_item_id == item.id %}
                  <a href="/admin/equipment/years/{{ year }}/initial-stock/{{ stock.id }}/edit" style="margin-left: 8px; color: #1E3A5F; text-decoration: none;">âœï¸</a>
                {% endif %}
              {% endfor %}
            {% else %}
              <a href="/admin/equipment/years/{{ year }}/initial-stock/new?equipment_item_id={{ item.id }}" style="color: #1E3A5F; text-decoration: none;">æœªç™»éŒ²</a>
            {% endif %}
          </td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee; font-weight: 600; color: {% if current_stock_map.get(item.id, 0) < 0 %}#f44336{% else %}#1E3A5F{% endif %};">
            {{ current_stock_map.get(item.id, 0) }}{% if item.unit %}{{ item.unit }}{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- æŒã¡å‡ºã—å‚™å“ä¸€è¦§ -->
<div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-bottom: 20px;">
  <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">æŒã¡å‡ºã—å‚™å“</h3>
  
  {% if takeouts %}
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f5f7fb;">
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">æ—¥ä»˜</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">å‚™å“å</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">æ•°é‡</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">ãƒ¡ãƒ¢</th>
          <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; color: #1E3A5F;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for takeout in takeouts %}
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ takeout.takeout_date }}</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">
            {% if takeout.equipment_items %}
              {{ takeout.equipment_items.name }}{% if takeout.equipment_items.unit %}ï¼ˆ{{ takeout.equipment_items.unit }}ï¼‰{% endif %}
            {% else %}
              ä¸æ˜
            {% endif %}
          </td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">{{ takeout.quantity }}</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ takeout.memo or '' }}</td>
          <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
            <a href="/admin/equipment/years/{{ year }}/takeouts/{{ takeout.id }}/edit" style="color: #1E3A5F; text-decoration: none; margin-right: 8px;">âœï¸</a>
            <form method="POST" action="/admin/equipment/years/{{ year }}/takeouts/{{ takeout.id }}/delete" style="display: inline;" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
              <button type="submit" style="background: none; border: none; color: #f44336; cursor: pointer; padding: 0;">ğŸ—‘ï¸</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p style="padding: 20px; color: #666;">æŒã¡å‡ºã—å‚™å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}
</div>

<!-- ç™ºæ³¨å‚™å“ä¸€è¦§ -->
<div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-bottom: 20px;">
  <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">ç™ºæ³¨å‚™å“</h3>
  
  {% if orders %}
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f5f7fb;">
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">ç™ºæ³¨æ—¥</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">å‚™å“å</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">æ•°é‡</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">é‡‘é¡</th>
          <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; color: #1E3A5F;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">åˆ°ç€æ—¥</th>
          <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; color: #1E3A5F;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ order.order_date }}</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">
            {% if order.equipment_items %}
              {{ order.equipment_items.name }}{% if order.equipment_items.unit %}ï¼ˆ{{ order.equipment_items.unit }}ï¼‰{% endif %}
            {% else %}
              ä¸æ˜
            {% endif %}
          </td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">{{ order.quantity }}</td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">
            {% if order.amount %}
              Â¥{{ "{:,}".format(order.amount|int) }}
            {% else %}
              -
            {% endif %}
          </td>
          <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
            {% if order.status == 'pending' %}
              <span style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">æœªç™ºæ³¨</span>
            {% elif order.status == 'ordered' %}
              <span style="background: #2196F3; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">ç™ºæ³¨æ¸ˆã¿</span>
            {% elif order.status == 'arrived' %}
              <span style="background: #4CAF50; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">åˆ°ç€æ¸ˆã¿</span>
            {% endif %}
          </td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ order.arrival_date or '-' }}</td>
          <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
            <a href="/admin/equipment/years/{{ year }}/orders/{{ order.id }}/edit" style="color: #1E3A5F; text-decoration: none; margin-right: 8px;">âœï¸</a>
            <form method="POST" action="/admin/equipment/years/{{ year }}/orders/{{ order.id }}/delete" style="display: inline;" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
              <button type="submit" style="background: none; border: none; color: #f44336; cursor: pointer; padding: 0;">ğŸ—‘ï¸</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p style="padding: 20px; color: #666;">ç™ºæ³¨å‚™å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}
</div>

{% endblock %}

