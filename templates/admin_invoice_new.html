{% extends "base.html" %}
{% block title %}æ–°è¦è«‹æ±‚æ›¸ä½œæˆ | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">ğŸ†• æ–°è¦è«‹æ±‚æ›¸ä½œæˆ</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<div style="margin-bottom: 20px;">
  <a href="/admin/invoices/years" class="admin-karte-detail-btn-back" style="text-decoration: none; display: inline-block; text-align: center; margin-right: 12px;">â† è«‹æ±‚æ›¸ä¸€è¦§ã«æˆ»ã‚‹</a>
</div>

<form method="POST" action="/admin/invoices/new" style="max-width: 1000px;">
  <!-- åŸºæœ¬æƒ…å ± -->
  <div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-bottom: 20px;">
    <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">åŸºæœ¬æƒ…å ±</h3>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">è«‹æ±‚å…ˆï¼ˆç¾å ´åï¼‰<span style="color: #f44336;">*</span></label>
      <input type="text" name="place_name" id="place_name" required placeholder="ç¾å ´åã‚’å…¥åŠ›" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      {% if existing_places %}
      <select id="existing_place_select" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-top: 8px;" onchange="fillExistingPlace()">
        <option value="">æ—¢å­˜ã®è«‹æ±‚å…ˆã‹ã‚‰é¸æŠï¼ˆé¸æŠã™ã‚‹ã¨è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼‰</option>
        {% for place in existing_places %}
        <option value="{{ place.place_name }}" data-address="{{ place.address or '' }}" data-phone="{{ place.phone or '' }}" data-contact="{{ place.contact_person or '' }}">{{ place.place_name }}</option>
        {% endfor %}
      </select>
      {% endif %}
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">è«‹æ±‚å…ˆä½æ‰€</label>
      <input type="text" name="place_address" id="place_address" placeholder="è«‹æ±‚å…ˆã®ä½æ‰€ã‚’å…¥åŠ›" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">è«‹æ±‚å…ˆé›»è©±ç•ªå·</label>
      <input type="text" name="place_phone" id="place_phone" placeholder="è«‹æ±‚å…ˆã®é›»è©±ç•ªå·ã‚’å…¥åŠ›" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">æ‹…å½“è€…å</label>
      <input type="text" name="place_contact_person" id="place_contact_person" placeholder="æ‹…å½“è€…åã‚’å…¥åŠ›" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">è«‹æ±‚å¯¾è±¡å¹´<span style="color: #f44336;">*</span></label>
        <input type="number" name="year" required min="2020" max="2100" value="{{ current_year or '' }}" placeholder="ä¾‹ï¼š2025" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">è«‹æ±‚å¯¾è±¡æœˆ<span style="color: #f44336;">*</span></label>
        <select name="month" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="01">1æœˆ</option>
          <option value="02">2æœˆ</option>
          <option value="03">3æœˆ</option>
          <option value="04">4æœˆ</option>
          <option value="05">5æœˆ</option>
          <option value="06">6æœˆ</option>
          <option value="07">7æœˆ</option>
          <option value="08">8æœˆ</option>
          <option value="09">9æœˆ</option>
          <option value="10">10æœˆ</option>
          <option value="11">11æœˆ</option>
          <option value="12">12æœˆ</option>
        </select>
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">ç™ºè¡Œæ—¥<span style="color: #f44336;">*</span></label>
        <input type="date" name="issue_date" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">æ”¯æ‰•æœŸé™<span style="color: #f44336;">*</span></label>
        <input type="date" name="due_date" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E3A5F; font-size: 0.95rem;">å‚™è€ƒ</label>
      <textarea name="notes" rows="3" placeholder="å‚™è€ƒã‚’å…¥åŠ›" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; font-family: inherit;"></textarea>
    </div>
  </div>
  
  <!-- æ˜ç´° -->
  <div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">è«‹æ±‚æ˜ç´°</h3>
      <button type="button" onclick="addItemRow()" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer; padding: 8px 16px; font-size: 0.9rem;">+ æ˜ç´°ã‚’è¿½åŠ </button>
    </div>
    
    <div id="items_container">
      <div class="item-row" style="display: grid; grid-template-columns: 1fr 2fr 1fr auto; gap: 12px; align-items: end; margin-bottom: 12px; padding: 12px; background: #f5f7fb; border-radius: 8px;">
        <div>
          <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #1E3A5F; font-size: 0.9rem;">æ—¥ä»˜<span style="color: #f44336;">*</span></label>
          <input type="date" name="item_date" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #1E3A5F; font-size: 0.9rem;">å†…å®¹</label>
          <input type="text" name="item_description" placeholder="ä¾‹ï¼šãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼å¸¯åŒ" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #1E3A5F; font-size: 0.9rem;">é‡‘é¡<span style="color: #f44336;">*</span></label>
          <input type="number" name="item_amount" required min="0" placeholder="ä¾‹ï¼š11000" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box;">
        </div>
        <div>
          <button type="button" onclick="removeItemRow(this)" style="padding: 8px 16px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">å‰Šé™¤</button>
        </div>
      </div>
    </div>
  </div>
  
  <div style="display: flex; gap: 12px;">
    <button type="submit" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer;">ğŸ’¾ ä½œæˆ</button>
    <a href="/admin/invoices/years" class="admin-karte-detail-btn-back" style="text-decoration: none; display: inline-block; text-align: center;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
  </div>
</form>

<script>
function addItemRow() {
  const container = document.getElementById('items_container');
  const newRow = document.createElement('div');
  newRow.className = 'item-row';
  newRow.style.cssText = 'display: grid; grid-template-columns: 1fr 2fr 1fr auto; gap: 12px; align-items: end; margin-bottom: 12px; padding: 12px; background: #f5f7fb; border-radius: 8px;';
  newRow.innerHTML = `
    <div>
      <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #1E3A5F; font-size: 0.9rem;">æ—¥ä»˜<span style="color: #f44336;">*</span></label>
      <input type="date" name="item_date" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box;">
    </div>
    <div>
      <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #1E3A5F; font-size: 0.9rem;">å†…å®¹</label>
      <input type="text" name="item_description" placeholder="ä¾‹ï¼šãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼å¸¯åŒ" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box;">
    </div>
    <div>
      <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #1E3A5F; font-size: 0.9rem;">é‡‘é¡<span style="color: #f44336;">*</span></label>
      <input type="number" name="item_amount" required min="0" placeholder="ä¾‹ï¼š11000" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box;">
    </div>
    <div>
      <button type="button" onclick="removeItemRow(this)" style="padding: 8px 16px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">å‰Šé™¤</button>
    </div>
  `;
  container.appendChild(newRow);
}

function removeItemRow(button) {
  const container = document.getElementById('items_container');
  if (container.children.length > 1) {
    button.closest('.item-row').remove();
  } else {
    alert('æ˜ç´°ã¯æœ€ä½1ä»¶å¿…è¦ã§ã™');
  }
}

function fillExistingPlace() {
  const select = document.getElementById('existing_place_select');
  const option = select.options[select.selectedIndex];
  if (option.value) {
    document.getElementById('place_name').value = option.value;
    document.getElementById('place_address').value = option.dataset.address || '';
    document.getElementById('place_phone').value = option.dataset.phone || '';
    document.getElementById('place_contact_person').value = option.dataset.contact || '';
  }
}

// ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«è¨­å®š
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  
  // ç™ºè¡Œæ—¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä»Šæ—¥ã«è¨­å®š
  const issueDateInput = document.querySelector('input[name="issue_date"]');
  if (issueDateInput && !issueDateInput.value) {
    issueDateInput.value = `${year}-${month}-${day}`;
  }
  
  // å¹´ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä»Šå¹´ã«è¨­å®š
  const yearInput = document.querySelector('input[name="year"]');
  if (yearInput && !yearInput.value) {
    yearInput.value = year;
  }
});
</script>

{% endblock %}

