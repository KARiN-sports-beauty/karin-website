{% extends "base.html" %}
{% block title %}æœˆæ¬¡å£²ä¸Šä¸€è¦§ - å…¨ä½“ {{ year }}å¹´{{ month_name }} | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">ğŸ’° æœˆæ¬¡å£²ä¸Šä¸€è¦§ - å…¨ä½“ {{ year }}å¹´{{ month_name }}</h2>

<div style="margin-bottom: 20px;">
  <a href="/admin/revenue/years/{{ year }}/months/{{ month }}" class="admin-karte-detail-btn-back" style="text-decoration: none; display: inline-block; text-align: center; margin-bottom: 12px;">â† é¸æŠãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
</div>

<div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
  <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">æœˆæ¬¡å£²ä¸Šã‚µãƒãƒªãƒ¼ï¼ˆå…¨ã‚¹ã‚¿ãƒƒãƒ•åˆè¨ˆï¼‰</h3>
  
  <!-- é™¢å†… -->
  <div style="margin-bottom: 24px; padding: 16px; background: #f5f7fb; border-radius: 8px; border-left: 4px solid #1E3A5F;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <div style="flex: 1;">
        <div style="font-size: 0.9rem; color: #666; margin-bottom: 4px;">é™¢å†…</div>
        <div style="display: flex; gap: 24px; align-items: baseline;">
          <div>
            <span style="font-size: 0.85rem; color: #666;">å£²ä¸Š: </span>
            <span style="font-size: 1.3rem; font-weight: 600; color: #1E3A5F;">Â¥{{ "{:,}".format(in_house_revenue) }}</span>
          </div>
          <div>
            <span style="font-size: 0.85rem; color: #666;">å®Ÿåƒæ™‚é–“: </span>
            <span style="font-size: 1.3rem; font-weight: 600; color: #1E3A5F;">{{ in_house_hours }}h</span>
          </div>
        </div>
      </div>
      <button type="button" class="detail-toggle-btn" data-category="in_house" style="padding: 8px 16px; background: #1E3A5F; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">è©³ç´°</button>
    </div>
    <div id="detail-in_house" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #ddd;">
      {% if in_house_items %}
        <div style="display: flex; flex-direction: column; gap: 12px;">
          {% for item in in_house_items %}
            <div style="padding: 12px; background: #fff; border-radius: 6px;">
              <div style="font-weight: 600; color: #1E3A5F; margin-bottom: 8px;">{{ item.report_date }}</div>
              {% if item.patients %}
                {% for patient in item.patients %}
                <div style="padding: 8px 0; {% if not loop.last %}border-bottom: 1px solid #f0f0f0;{% endif %}">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="color: #333; font-weight: 500;">{{ patient.patient_name or 'æ‚£è€…ä¸æ˜' }}</span>
                    <span style="font-weight: 600; color: #1E3A5F;">Â¥{{ "{:,}".format(patient.amount or 0) }}</span>
                  </div>
                  {% if patient.course_name %}
                  <div style="font-size: 0.85rem; color: #666; margin-bottom: 2px;">ã‚³ãƒ¼ã‚¹ï¼š{{ patient.course_name }}</div>
                  {% endif %}
                </div>
                {% endfor %}
              {% else %}
                <div style="color: #999; font-size: 0.9rem;">æ‚£è€…æƒ…å ±ãªã—</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div style="color: #999; font-size: 0.9rem;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
      {% endif %}
    </div>
  </div>
  
  <!-- å¾€è¨º -->
  <div style="margin-bottom: 24px; padding: 16px; background: #f5f7fb; border-radius: 8px; border-left: 4px solid #4CAF50;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <div style="flex: 1;">
        <div style="font-size: 0.9rem; color: #666; margin-bottom: 4px;">å¾€è¨º</div>
        <div style="display: flex; gap: 24px; align-items: baseline;">
          <div>
            <span style="font-size: 0.85rem; color: #666;">å£²ä¸Š: </span>
            <span style="font-size: 1.3rem; font-weight: 600; color: #4CAF50;">Â¥{{ "{:,}".format(visit_revenue) }}</span>
          </div>
          <div>
            <span style="font-size: 0.85rem; color: #666;">å®Ÿåƒæ™‚é–“: </span>
            <span style="font-size: 1.3rem; font-weight: 600; color: #4CAF50;">{{ visit_hours }}h</span>
          </div>
        </div>
      </div>
      <button type="button" class="detail-toggle-btn" data-category="visit" style="padding: 8px 16px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">è©³ç´°</button>
    </div>
    <div id="detail-visit" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #ddd;">
      {% if visit_items %}
        <div style="display: flex; flex-direction: column; gap: 12px;">
          {% for item in visit_items %}
            <div style="padding: 12px; background: #fff; border-radius: 6px;">
              <div style="font-weight: 600; color: #4CAF50; margin-bottom: 8px;">{{ item.report_date }}</div>
              {% if item.patients %}
                {% for patient in item.patients %}
                <div style="padding: 8px 0; {% if not loop.last %}border-bottom: 1px solid #f0f0f0;{% endif %}">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="color: #333; font-weight: 500;">{{ patient.patient_name or 'æ‚£è€…ä¸æ˜' }}</span>
                    <span style="font-weight: 600; color: #4CAF50;">Â¥{{ "{:,}".format(patient.amount or 0) }}</span>
                  </div>
                  {% if patient.course_name %}
                  <div style="font-size: 0.85rem; color: #666; margin-bottom: 2px;">ã‚³ãƒ¼ã‚¹ï¼š{{ patient.course_name }}</div>
                  {% endif %}
                </div>
                {% endfor %}
              {% else %}
                <div style="color: #999; font-size: 0.9rem;">æ‚£è€…æƒ…å ±ãªã—</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div style="color: #999; font-size: 0.9rem;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
      {% endif %}
    </div>
  </div>
  
  <!-- å¸¯åŒï¼ˆç¾å ´ã”ã¨ã«åˆ†ã‘ã¦è¡¨ç¤ºï¼‰ -->
  <div style="margin-bottom: 24px; padding: 16px; background: #f5f7fb; border-radius: 8px; border-left: 4px solid #FFB6C1;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <div style="flex: 1;">
        <div style="font-size: 0.9rem; color: #666; margin-bottom: 4px;">å¸¯åŒ</div>
        <div style="display: flex; gap: 24px; align-items: baseline;">
          <div>
            <span style="font-size: 0.85rem; color: #666;">å£²ä¸Š: </span>
            <span style="font-size: 1.3rem; font-weight: 600; color: #FFB6C1;">Â¥{{ "{:,}".format(field_revenue) }}</span>
          </div>
          <div>
            <span style="font-size: 0.85rem; color: #666;">å®Ÿåƒæ™‚é–“: </span>
            <span style="font-size: 1.3rem; font-weight: 600; color: #FFB6C1;">{{ field_hours }}h</span>
          </div>
        </div>
      </div>
      <button type="button" class="detail-toggle-btn" data-category="field" style="padding: 8px 16px; background: #FFB6C1; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">è©³ç´°</button>
    </div>
    <div id="detail-field" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #ddd;">
      {% if field_by_place %}
        <div style="display: flex; flex-direction: column; gap: 20px;">
          {% for place_name in field_by_place %}
            {% set items = field_by_place[place_name] %}
            <div style="padding: 16px; background: #fff; border-radius: 8px; border: 1px solid #ddd;">
              <div style="font-weight: 600; color: #FFB6C1; margin-bottom: 12px; font-size: 1.1rem;">{{ place_name }}</div>
              <div style="display: flex; flex-direction: column; gap: 12px;">
                {% for item in items %}
                  <div style="padding: 12px; background: #f9f9f9; border-radius: 6px;">
                    <div style="font-weight: 600; color: #666; margin-bottom: 8px; font-size: 0.95rem;">{{ item.report_date }}</div>
                    {% if item.patients %}
                      {% for patient in item.patients %}
                      <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; {% if not loop.last %}border-bottom: 1px solid #f0f0f0;{% endif %}">
                        <span style="color: #333;">{{ patient.patient_name or 'ç¾å ´åä¸æ˜' }}</span>
                        <span style="font-weight: 600; color: #FFB6C1;">Â¥{{ "{:,}".format(patient.amount or 0) }}</span>
                      </div>
                      {% endfor %}
                    {% else %}
                      <div style="color: #999; font-size: 0.9rem;">ç¾å ´æƒ…å ±ãªã—</div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div style="color: #999; font-size: 0.9rem;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
      {% endif %}
    </div>
  </div>
  
  <!-- åˆè¨ˆ -->
  <div style="padding: 16px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
    <div style="font-size: 0.9rem; color: #666; margin-bottom: 4px;">åˆè¨ˆ</div>
    <div style="display: flex; gap: 24px; align-items: baseline;">
      <div>
        <span style="font-size: 0.85rem; color: #666;">å£²ä¸Š: </span>
        <span style="font-size: 1.3rem; font-weight: 600; color: #856404;">Â¥{{ "{:,}".format(total_revenue) }}</span>
      </div>
      <div>
        <span style="font-size: 0.85rem; color: #666;">å®Ÿåƒæ™‚é–“: </span>
        <span style="font-size: 1.3rem; font-weight: 600; color: #856404;">{{ total_hours }}h</span>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const toggleButtons = document.querySelectorAll('.detail-toggle-btn');
  
  toggleButtons.forEach(function(btn) {
    btn.addEventListener('click', function() {
      const category = btn.dataset.category;
      const detailDiv = document.getElementById('detail-' + category);
      
      if (detailDiv.style.display === 'none') {
        detailDiv.style.display = 'block';
        btn.textContent = 'é–‰ã˜ã‚‹';
      } else {
        detailDiv.style.display = 'none';
        btn.textContent = 'è©³ç´°';
      }
    });
  });
});
</script>

{% endblock %}

