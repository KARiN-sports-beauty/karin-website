{% extends "base.html" %}
{% block title %}æ—¥å ±ä½œæˆ | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">ğŸ“ æ—¥å ±ä½œæˆ</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<div style="max-width: 800px; margin: 0 auto;">
<form method="POST" action="/staff/daily-report/new" id="daily-report-form">
  <!-- æ—¥å ±åŸºæœ¬æƒ…å ± -->
  <div style="margin-bottom: 30px; padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); max-width: 800px; margin-left: auto; margin-right: auto;">
    <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">æ—¥å ±æƒ…å ±</h3>
    
    <div style="margin-bottom: 20px;">
      <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ã‚¹ã‚¿ãƒƒãƒ•å</label>
      <input type="text" value="{{ staff_name }}" disabled style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: #f5f5f5; color: #666; box-sizing: border-box;">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ—¥ä»˜ï¼ˆå¿…é ˆï¼‰</label>
      <input type="date" name="report_date" id="report_date" value="{{ today_date }}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æœ¬æ—¥ã®ã‚·ãƒ•ãƒˆ</label>
      <textarea name="report_memo" rows="3" placeholder="æœ¬æ—¥ã®ã‚·ãƒ•ãƒˆã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">{{ existing_report.memo if existing_report else '' }}</textarea>
    </div>
  </div>
  
  <!-- å‹¤å‹™ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
  <div style="margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">å‹¤å‹™ã‚«ãƒ¼ãƒ‰</h3>
      <button type="button" id="add-work-card-btn" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer; padding: 8px 16px; font-size: 0.9rem;">â• å‹¤å‹™ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </button>
    </div>
    
    <div id="work-cards-container" style="display: flex; flex-direction: column; gap: 16px;">
      <!-- å‹¤å‹™ã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
    </div>
  </div>
  
  <div style="display: flex; gap: 12px; margin-top: 30px;">
    <button type="submit" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer;">ğŸ’¾ ä¿å­˜</button>
    <a href="/admin/dashboard" class="admin-karte-detail-btn-back" style="text-decoration: none; display: inline-block; text-align: center;">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
  </div>
</form>

<!-- å®Ÿåƒæ™‚é–“è¡¨ç¤ºãƒ•ãƒƒã‚¿ãƒ¼ -->
<div style="margin-top: 40px; padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); max-width: 800px; margin-left: auto; margin-right: auto;">
  <h3 style="margin: 0 0 16px 0; font-size: 1.1rem; font-weight: 600; color: #1E3A5F;">å®Ÿåƒæ™‚é–“</h3>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
    <div>
      <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">ä»Šé€±ã®å®Ÿåƒæ™‚é–“</div>
      <div style="font-size: 1.2rem; font-weight: 600; color: #1E3A5F;" id="weekly-hours">è¨ˆç®—ä¸­...</div>
    </div>
    <div>
      <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">ç›®æ¨™40hã¨ã®å·®</div>
      <div style="font-size: 1.2rem; font-weight: 600;" id="target-diff">è¨ˆç®—ä¸­...</div>
    </div>
    <div>
      <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">éä¸è¶³</div>
      <div style="font-size: 1.2rem; font-weight: 600;" id="yearly-diff">è¨ˆç®—ä¸­...</div>
    </div>
  </div>
</div>
</div>

<script>
// å®Ÿåƒæ™‚é–“è¡¨ç¤º
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('weekly-hours').textContent = '{{ weekly_hours }}æ™‚é–“';
  
  const diffHours = {{ diff_hours }};
  const diffElement = document.getElementById('target-diff');
  if (diffHours >= 0) {
    diffElement.textContent = `+${diffHours}æ™‚é–“`;
    diffElement.style.color = '#4CAF50';
  } else {
    diffElement.textContent = `${diffHours}æ™‚é–“`;
    diffElement.style.color = '#f44336';
  }
  
  const weeklyDiff = {{ weekly_hours_diff }};
  const yearlyDiffElement = document.getElementById('yearly-diff');
  if (weeklyDiff >= 0) {
    yearlyDiffElement.textContent = `+${weeklyDiff}æ™‚é–“`;
    yearlyDiffElement.style.color = '#4CAF50';
  } else {
    yearlyDiffElement.textContent = `${weeklyDiff}æ™‚é–“`;
    yearlyDiffElement.style.color = '#f44336';
  }
});
</script>

<script>
let workCardCount = 0;

// å‹¤å‹™ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
function addWorkCard() {
  workCardCount++;
  const container = document.getElementById('work-cards-container');
  const card = document.createElement('div');
  card.className = 'work-card';
  card.dataset.cardIndex = workCardCount;
  card.style.cssText = 'padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); position: relative;';
  
  card.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: #1E3A5F;">å‹¤å‹™ã‚«ãƒ¼ãƒ‰ ${workCardCount}</h4>
      <button type="button" class="remove-card-btn" style="padding: 4px 12px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">å‰Šé™¤</button>
    </div>
    
    <div style="margin-bottom: 16px;">
      <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">åŒºåˆ†ï¼ˆå¿…é ˆï¼‰</label>
      <select name="work_type_${workCardCount}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="in_house">é™¢å†…</option>
        <option value="visit">å¾€è¨º</option>
        <option value="field">å¸¯åŒ</option>
      </select>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">é–‹å§‹æ™‚åˆ»</label>
        <input type="time" name="start_time_${workCardCount}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">çµ‚äº†æ™‚åˆ»</label>
        <input type="time" name="end_time_${workCardCount}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
        <input type="number" name="break_minutes_${workCardCount}" value="0" min="0" max="480" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">æœ¬æ•°</label>
        <input type="number" name="session_count_${workCardCount}" value="0" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
    </div>
    
    <div>
      <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">ãƒ¡ãƒ¢</label>
      <textarea name="memo_${workCardCount}" rows="2" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;"></textarea>
    </div>
  `;
  
  container.appendChild(card);
  
  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  card.querySelector('.remove-card-btn').addEventListener('click', function() {
    card.remove();
    updateCardNumbers();
  });
}

// ã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’æ›´æ–°
function updateCardNumbers() {
  const cards = document.querySelectorAll('.work-card');
  cards.forEach((card, index) => {
    const title = card.querySelector('h4');
    if (title) {
      title.textContent = `å‹¤å‹™ã‚«ãƒ¼ãƒ‰ ${index + 1}`;
    }
  });
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
document.getElementById('daily-report-form').addEventListener('submit', function(e) {
  const cards = document.querySelectorAll('.work-card');
  if (cards.length === 0) {
    e.preventDefault();
    alert('å°‘ãªãã¨ã‚‚1ã¤ã®å‹¤å‹™ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
    return false;
  }
});

// æ—¢å­˜ã®å‹¤å‹™ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
function loadExistingCards(existingItems) {
  if (existingItems && existingItems.length > 0) {
    existingItems.forEach((item, index) => {
      addWorkCard();
      const cards = document.querySelectorAll('.work-card');
      const lastCard = cards[cards.length - 1];
      if (lastCard) {
        const cardIndex = lastCard.dataset.cardIndex;
        if (item.work_type) {
          lastCard.querySelector(`select[name="work_type_${cardIndex}"]`).value = item.work_type;
        }
        if (item.start_time) {
          lastCard.querySelector(`input[name="start_time_${cardIndex}"]`).value = item.start_time;
        }
        if (item.end_time) {
          lastCard.querySelector(`input[name="end_time_${cardIndex}"]`).value = item.end_time;
        }
        if (item.break_minutes !== undefined && item.break_minutes !== null) {
          lastCard.querySelector(`input[name="break_minutes_${cardIndex}"]`).value = item.break_minutes;
        }
        if (item.session_count !== undefined && item.session_count !== null) {
          lastCard.querySelector(`input[name="session_count_${cardIndex}"]`).value = item.session_count;
        }
        if (item.memo) {
          lastCard.querySelector(`textarea[name="memo_${cardIndex}"]`).value = item.memo;
        }
      }
    });
  } else {
    // æ—¢å­˜ã‚«ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯åˆæœŸã‚«ãƒ¼ãƒ‰ã‚’1ã¤è¿½åŠ 
    addWorkCard();
  }
}

// åˆæœŸã‚«ãƒ¼ãƒ‰ã‚’1ã¤è¿½åŠ 
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('add-work-card-btn').addEventListener('click', addWorkCard);
  
  // æ—¢å­˜ã®å‹¤å‹™ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€
  {% if existing_items %}
  loadExistingCards({{ existing_items | tojson }});
  {% else %}
  addWorkCard(); // åˆæœŸã‚«ãƒ¼ãƒ‰ã‚’1ã¤è¿½åŠ 
  {% endif %}
});
</script>
{% endblock %}
