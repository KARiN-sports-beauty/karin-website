{% extends "base.html" %}
{% block title %}æ—¥å ±ä½œæˆ | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">ğŸ“ æ—¥å ±ä½œæˆ</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<div style="max-width: 800px; margin: 0 auto;">
<form method="POST" action="/staff/daily-report/new" id="daily-report-form">
  <!-- æ—¥å ±åŸºæœ¬æƒ…å ± -->
  <div style="margin-bottom: 30px; padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); max-width: 800px; margin-left: auto; margin-right: auto;">
    <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">æ—¥å ±æƒ…å ±</h3>
    
    <div style="margin-bottom: 20px;">
      <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ã‚¹ã‚¿ãƒƒãƒ•å</label>
      <input type="text" value="{{ staff_name }}" disabled style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: #f5f5f5; color: #666; box-sizing: border-box;">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ—¥ä»˜ï¼ˆå¿…é ˆï¼‰</label>
      <input type="date" name="report_date" id="report_date" value="{{ today_date }}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æœ¬æ—¥ã®ã‚·ãƒ•ãƒˆ</label>
      <textarea name="report_memo" rows="1" placeholder="æœ¬æ—¥ã®ã‚·ãƒ•ãƒˆã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">{{ existing_report.memo if existing_report and existing_report.memo else '' }}</textarea>
    </div>
  </div>
  
  <!-- å‹¤å‹™ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
  <div style="margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">å‹¤å‹™ã‚«ãƒ¼ãƒ‰</h3>
      <button type="button" id="add-work-card-btn" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer; padding: 8px 16px; font-size: 0.9rem;">â• å‹¤å‹™ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </button>
    </div>
    
    <div id="work-cards-container" style="display: flex; flex-direction: column; gap: 16px;">
      <!-- å‹¤å‹™ã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
    </div>
  </div>
  
  <div style="display: flex; gap: 12px; margin-top: 30px;">
    <button type="submit" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer;">ğŸ’¾ ä¿å­˜</button>
    {% if is_admin %}
    <a href="/admin/staff-reports" class="admin-karte-detail-btn-back" style="text-decoration: none; display: inline-block; text-align: center;">â† ã‚¹ã‚¿ãƒƒãƒ•å ±å‘Šä¸€è¦§ã«æˆ»ã‚‹</a>
    {% else %}
    <a href="/staff/profile" class="admin-karte-detail-btn-back" style="text-decoration: none; display: inline-block; text-align: center;">â† ã‚¹ã‚¿ãƒƒãƒ•ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
    {% endif %}
  </div>
</form>

{% if not is_admin %}
<!-- å®Ÿåƒæ™‚é–“è¡¨ç¤ºãƒ•ãƒƒã‚¿ãƒ¼ -->
<div style="margin-top: 40px; padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); max-width: 800px; margin-left: auto; margin-right: auto;">
  <h3 style="margin: 0 0 16px 0; font-size: 1.1rem; font-weight: 600; color: #1E3A5F;">å®Ÿåƒæ™‚é–“</h3>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
    <div>
      <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">ä»Šé€±ã®å®Ÿåƒæ™‚é–“</div>
      <div style="font-size: 1.2rem; font-weight: 600; color: #1E3A5F;" id="weekly-hours">è¨ˆç®—ä¸­...</div>
    </div>
    <div>
      <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">é€±ç›®æ¨™æ™‚é–“40h</div>
      <div style="font-size: 1.2rem; font-weight: 600;" id="target-diff">è¨ˆç®—ä¸­...</div>
    </div>
    <div>
      <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">éä¸è¶³</div>
      <div style="font-size: 1.2rem; font-weight: 600;" id="yearly-diff">è¨ˆç®—ä¸­...</div>
    </div>
  </div>
</div>

<script>
// å®Ÿåƒæ™‚é–“è¡¨ç¤º
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('weekly-hours').textContent = '{{ weekly_hours }}æ™‚é–“';
  
  const diffHours = {{ diff_hours }};
  const diffElement = document.getElementById('target-diff');
  if (diffHours >= 0) {
    diffElement.textContent = `+${diffHours}æ™‚é–“`;
    diffElement.style.color = '#4CAF50';
  } else {
    diffElement.textContent = `${diffHours}æ™‚é–“`;
    diffElement.style.color = '#f44336';
  }
  
  const weeklyDiff = {{ weekly_hours_diff }};
  const yearlyDiffElement = document.getElementById('yearly-diff');
  if (weeklyDiff >= 0) {
    yearlyDiffElement.textContent = `+${weeklyDiff}æ™‚é–“`;
    yearlyDiffElement.style.color = '#4CAF50';
  } else {
    yearlyDiffElement.textContent = `${weeklyDiff}æ™‚é–“`;
    yearlyDiffElement.style.color = '#f44336';
  }
});
</script>
{% endif %}
</div>

<script>
let workCardCount = 0;

// å‹¤å‹™ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
function addWorkCard() {
  workCardCount++;
  const container = document.getElementById('work-cards-container');
  const card = document.createElement('div');
  card.className = 'work-card';
  card.dataset.cardIndex = workCardCount;
  card.style.cssText = 'padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); position: relative;';
  
  card.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: #1E3A5F;">å‹¤å‹™ã‚«ãƒ¼ãƒ‰ ${workCardCount}</h4>
      <button type="button" class="remove-card-btn" style="padding: 4px 12px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">å‰Šé™¤</button>
    </div>
    
    <div style="margin-bottom: 16px;">
      <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">åŒºåˆ†ï¼ˆå¿…é ˆï¼‰</label>
      <select name="work_type_${workCardCount}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="in_house">é™¢å†…</option>
        <option value="visit">å¾€è¨º</option>
        <option value="field">å¸¯åŒ</option>
      </select>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">é–‹å§‹æ™‚åˆ»</label>
        <input type="time" name="start_time_${workCardCount}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">çµ‚äº†æ™‚åˆ»</label>
        <input type="time" name="end_time_${workCardCount}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
        <input type="number" name="break_minutes_${workCardCount}" value="0" min="0" max="480" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">æœ¬æ•°</label>
        <input type="number" name="session_count_${workCardCount}" value="0" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
      </div>
    </div>
    
    <div>
      <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">ãƒ¡ãƒ¢</label>
      <textarea name="memo_${workCardCount}" rows="2" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;"></textarea>
    </div>
  `;
  
  container.appendChild(card);
  
  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  card.querySelector('.remove-card-btn').addEventListener('click', function() {
    card.remove();
    updateCardNumbers();
  });
}

// ã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’æ›´æ–°
function updateCardNumbers() {
  const cards = document.querySelectorAll('.work-card');
  cards.forEach((card, index) => {
    const title = card.querySelector('h4');
    if (title) {
      title.textContent = `å‹¤å‹™ã‚«ãƒ¼ãƒ‰ ${index + 1}`;
    }
  });
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
document.getElementById('daily-report-form').addEventListener('submit', function(e) {
  const cards = document.querySelectorAll('.work-card');
  if (cards.length === 0) {
    e.preventDefault();
    alert('å°‘ãªãã¨ã‚‚1ã¤ã®å‹¤å‹™ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
    return false;
  }
});

// æ—¢å­˜ã®å‹¤å‹™ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
function loadExistingCards(existingItems) {
  if (existingItems && existingItems.length > 0) {
    existingItems.forEach((item, index) => {
      addWorkCard();
      const cards = document.querySelectorAll('.work-card');
      const lastCard = cards[cards.length - 1];
      if (lastCard) {
        const cardIndex = lastCard.dataset.cardIndex;
        if (item.work_type) {
          lastCard.querySelector(`select[name="work_type_${cardIndex}"]`).value = item.work_type;
        }
        if (item.start_time) {
          lastCard.querySelector(`input[name="start_time_${cardIndex}"]`).value = item.start_time;
        }
        if (item.end_time) {
          lastCard.querySelector(`input[name="end_time_${cardIndex}"]`).value = item.end_time;
        }
        if (item.break_minutes !== undefined && item.break_minutes !== null) {
          lastCard.querySelector(`input[name="break_minutes_${cardIndex}"]`).value = item.break_minutes;
        }
        if (item.session_count !== undefined && item.session_count !== null) {
          lastCard.querySelector(`input[name="session_count_${cardIndex}"]`).value = item.session_count;
        }
        if (item.memo) {
          lastCard.querySelector(`textarea[name="memo_${cardIndex}"]`).value = item.memo;
        }
        
        // äºˆç´„å®Œäº†æ™‚ã«è¿½åŠ ã•ã‚ŒãŸæ‚£è€…æƒ…å ±ã‚’è¡¨ç¤º
        if (item.patients && item.patients.length > 0) {
          const memoTextarea = lastCard.querySelector('textarea[name="memo_' + cardIndex + '"]');
          const patientsSection = document.createElement('div');
          patientsSection.style.cssText = 'margin-top: 16px; padding: 12px; background: #f5f7fb; border-radius: 8px; border-top: 2px solid #1E3A5F;';
          
          let patientsHtml = '<div style="font-size: 0.9rem; font-weight: 600; color: #1E3A5F; margin-bottom: 12px;">æœ¬æ—¥ã®å£²ä¸Šæ˜ç´°</div>';
          patientsHtml += '<div style="display: flex; flex-direction: column; gap: 12px;">';
          
          for (let i = 0; i < item.patients.length; i++) {
            const patient = item.patients[i];
            const patientName = patient.patient_name || 'æ‚£è€…ä¸æ˜';
            const courseName = patient.course_name_display || patient.course_name || 'ã‚³ãƒ¼ã‚¹åãªã—';
            const patientReportId = patient.id;
            const currentAmount = patient.amount !== null && patient.amount !== undefined ? patient.amount : 0;
            const formattedAmount = currentAmount > 0 ? currentAmount.toLocaleString() : '0';
            
            patientsHtml += '<div style="padding: 12px; background: #fff; border-radius: 8px; font-size: 0.9rem;" data-patient-report-id="' + patientReportId + '">';
            patientsHtml += '<div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">';
            patientsHtml += '<span style="font-weight: 500; color: #1E3A5F; min-width: 100px;">' + patientName + '</span>';
            patientsHtml += '<span class="patient-course-display" style="color: #666; flex: 1; min-width: 150px;">' + courseName + '</span>';
            patientsHtml += '<input type="text" class="patient-course-input" data-patient-report-id="' + patientReportId + '" value="' + courseName.replace(/"/g, '&quot;') + '" style="display: none; flex: 1; min-width: 150px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box;">';
            patientsHtml += '<div style="display: flex; align-items: center; gap: 8px;">';
            patientsHtml += '<span class="patient-amount-display" style="color: #666; font-size: 0.9rem; min-width: 100px; text-align: right;">Â¥' + formattedAmount + '</span>';
            patientsHtml += '<input type="number" class="patient-amount-input" data-patient-report-id="' + patientReportId + '" value="' + currentAmount + '" min="0" step="100" style="display: none; width: 120px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box;">';
            patientsHtml += '<button type="button" class="patient-edit-btn" data-patient-report-id="' + patientReportId + '" style="padding: 4px 12px; background: #1E3A5F; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">ç·¨é›†</button>';
            patientsHtml += '<button type="button" class="patient-update-btn" data-patient-report-id="' + patientReportId + '" style="display: none; padding: 4px 12px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">æ›´æ–°</button>';
            patientsHtml += '</div>';
            patientsHtml += '</div>';
            patientsHtml += '</div>';
          }
          
          patientsHtml += '</div>';
          patientsSection.innerHTML = patientsHtml;
          memoTextarea.parentNode.insertBefore(patientsSection, memoTextarea.nextSibling);
          
          // ç·¨é›†ãƒœã‚¿ãƒ³ã¨æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
          const editButtons = patientsSection.querySelectorAll('.patient-edit-btn');
          editButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
              const patientReportId = btn.dataset.patientReportId;
              const container = btn.closest('[data-patient-report-id="' + patientReportId + '"]');
              const courseDisplaySpan = container.querySelector('.patient-course-display');
              const courseInputField = container.querySelector('.patient-course-input[data-patient-report-id="' + patientReportId + '"]');
              const amountDisplaySpan = container.querySelector('.patient-amount-display');
              const amountInputField = container.querySelector('.patient-amount-input[data-patient-report-id="' + patientReportId + '"]');
              const editBtn = container.querySelector('.patient-edit-btn[data-patient-report-id="' + patientReportId + '"]');
              const updateBtn = container.querySelector('.patient-update-btn[data-patient-report-id="' + patientReportId + '"]');
              
              // è¡¨ç¤ºã‚’éè¡¨ç¤ºã«ã—ã¦ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
              courseDisplaySpan.style.display = 'none';
              courseInputField.style.display = 'block';
              amountDisplaySpan.style.display = 'none';
              amountInputField.style.display = 'block';
              editBtn.style.display = 'none';
              updateBtn.style.display = 'block';
              courseInputField.focus();
            });
          });
          
          const updateButtons = patientsSection.querySelectorAll('.patient-update-btn');
          updateButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
              const patientReportId = btn.dataset.patientReportId;
              const container = btn.closest('[data-patient-report-id="' + patientReportId + '"]');
              const courseDisplaySpan = container.querySelector('.patient-course-display');
              const courseInputField = container.querySelector('.patient-course-input[data-patient-report-id="' + patientReportId + '"]');
              const amountDisplaySpan = container.querySelector('.patient-amount-display');
              const amountInputField = container.querySelector('.patient-amount-input[data-patient-report-id="' + patientReportId + '"]');
              const editBtn = container.querySelector('.patient-edit-btn[data-patient-report-id="' + patientReportId + '"]');
              const updateBtn = container.querySelector('.patient-update-btn[data-patient-report-id="' + patientReportId + '"]');
              
              const courseName = courseInputField.value.trim();
              const amount = parseInt(amountInputField.value) || 0;
              
              // APIã‚’å‘¼ã³å‡ºã—ã¦æ›´æ–°
              fetch('/staff/daily-report/patient/' + patientReportId + '/update', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                  amount: amount,
                  course_name: courseName
                })
              })
              .then(function(response) {
                return response.json();
              })
              .then(function(data) {
                if (data.success) {
                  // æˆåŠŸæ™‚ï¼šè¡¨ç¤ºã‚’æ›´æ–°
                  courseDisplaySpan.textContent = courseName;
                  courseDisplaySpan.style.display = 'inline-block';
                  courseInputField.style.display = 'none';
                  amountDisplaySpan.textContent = 'Â¥' + amount.toLocaleString();
                  amountDisplaySpan.style.display = 'inline-block';
                  amountInputField.style.display = 'none';
                  editBtn.style.display = 'block';
                  updateBtn.style.display = 'none';
                  alert('é‡‘é¡ã¨ã‚³ãƒ¼ã‚¹åã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆé‡‘é¡ã¯äºˆç´„ãƒ‡ãƒ¼ã‚¿ã«ã‚‚åæ˜ æ¸ˆã¿ï¼‰');
                } else {
                  alert('ã‚¨ãƒ©ãƒ¼: ' + (data.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
              })
              .catch(function(error) {
                console.error('Error:', error);
                alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
              });
            });
          });
        }
      }
    });
  } else {
    // æ—¢å­˜ã‚«ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯åˆæœŸã‚«ãƒ¼ãƒ‰ã‚’1ã¤è¿½åŠ 
    addWorkCard();
  }
}

// åˆæœŸã‚«ãƒ¼ãƒ‰ã‚’1ã¤è¿½åŠ 
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('add-work-card-btn').addEventListener('click', addWorkCard);
  
  // æ—¥ä»˜å¤‰æ›´æ™‚ã«è‡ªå‹•çš„ã«ãƒªãƒ­ãƒ¼ãƒ‰
  const dateInput = document.getElementById('report_date');
  let currentDate = dateInput.value;
  
  dateInput.addEventListener('change', function() {
    const selectedDate = dateInput.value;
    if (selectedDate && selectedDate !== currentDate) {
      // æ—¥ä»˜ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰è‡ªå‹•çš„ã«ãƒªãƒ­ãƒ¼ãƒ‰
      window.location.href = '/staff/daily-report/new?date=' + selectedDate;
    }
  });
  
  // æ—¢å­˜ã®å‹¤å‹™ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€
  {% if existing_items %}
  loadExistingCards({{ existing_items | tojson }});
  {% else %}
  addWorkCard(); // åˆæœŸã‚«ãƒ¼ãƒ‰ã‚’1ã¤è¿½åŠ 
  {% endif %}
});
</script>
{% endblock %}
