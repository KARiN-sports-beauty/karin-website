{% extends "base.html" %}
{% block title %}ã‚«ãƒ«ãƒ†ç®¡ç† | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">ğŸ“‹ ã‚«ãƒ«ãƒ†ç®¡ç†</h2>

<div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
  <a href="/admin/karte/new" class="admin-karte-btn-white">â• æ–°è¦ã‚«ãƒ«ãƒ†ä½œæˆï¼ˆå…¥åŠ›ç”¨ï¼‰</a>
  
  {% if introducer_ranking or reservation_ranking %}
  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
    {% if introducer_ranking %}
    <button type="button" id="introducer-ranking-toggle" class="admin-karte-btn-white ranking-tab active" style="border: none; cursor: pointer;" onclick="switchRankingTab('introducer')">
      ğŸ† ç´¹ä»‹è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    </button>
    {% endif %}
    {% if reservation_ranking %}
    <button type="button" id="reservation-ranking-toggle" class="admin-karte-btn-white ranking-tab" style="border: none; cursor: pointer;" onclick="switchRankingTab('reservation')">
      ğŸ“… äºˆç´„æ•°é †ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    </button>
    {% endif %}
  </div>
  {% endif %}
</div>

{% if introducer_ranking %}
<div id="introducer-ranking-content" class="admin-introducer-ranking-card" style="display: block; margin-top: 20px; margin-bottom: 20px; padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
  <h3 style="margin: 0 0 16px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">ğŸ† ç´¹ä»‹è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä¸Šä½10åï¼‰</h3>
  <ul style="list-style: none; padding: 0; margin: 0;">
    {% for item in introducer_ranking %}
    <li style="padding: 10px 0; {% if not loop.last %}border-bottom: 1px solid #f0f0f0;{% endif %}">
      <a href="/admin/karte/{{ item.patient_id }}" style="text-decoration: none; color: #1E3A5F; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
        <span style="font-size: 1.1rem;">{{ loop.index }}.</span>
        <span style="font-weight: 500;">{{ item.name }}</span>
        <span style="color: #999; font-size: 0.9rem;">ï¼ˆç´¹ä»‹ {{ item.count }}äººï¼‰</span>
        {% if item.reservation_count and item.reservation_count > 0 %}
        <span style="color: #4CAF50; font-size: 0.85rem; font-weight: 500;">äºˆç´„ {{ item.reservation_count }}ä»¶</span>
        {% endif %}
      </a>
    </li>
    {% endfor %}
  </ul>
</div>
{% endif %}

{% if reservation_ranking %}
<div id="reservation-ranking-content" class="admin-introducer-ranking-card" style="display: none; margin-top: 20px; margin-bottom: 20px; padding: 20px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08);">
  <h3 style="margin: 0 0 16px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">ğŸ“… äºˆç´„æ•°é †ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä¸Šä½10åï¼‰</h3>
  <ul style="list-style: none; padding: 0; margin: 0;">
    {% for item in reservation_ranking %}
    <li style="padding: 10px 0; {% if not loop.last %}border-bottom: 1px solid #f0f0f0;{% endif %}">
      <a href="/admin/karte/{{ item.patient_id }}" style="text-decoration: none; color: #1E3A5F; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
        <span style="font-size: 1.1rem;">{{ loop.index }}.</span>
        <span style="font-weight: 500;">{{ item.name }}</span>
        <span style="color: #4CAF50; font-size: 0.9rem; font-weight: 500;">äºˆç´„ {{ item.reservation_count }}ä»¶</span>
        {% if item.count and item.count > 0 %}
        <span style="color: #999; font-size: 0.85rem;">ï¼ˆç´¹ä»‹ {{ item.count }}äººï¼‰</span>
        {% endif %}
      </a>
    </li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<div style="margin-top: 20px; margin-bottom: 20px;">
  <input type="text" id="karte-search" placeholder="åå‰ã§æ¤œç´¢..." style="width: 100%; max-width: 400px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
</div>

{% if patients %}
<div class="admin-karte-grid" id="karte-grid">
  {% for patient in patients %}
  <a href="/admin/karte/{{ patient.id }}" class="admin-karte-card {% if patient.category == 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ»ã‚¿ãƒ¬ãƒ³ãƒˆ' or patient.category == 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ' %}category-artist{% elif patient.category == 'ã‚¹ãƒãƒ¼ãƒ„é¸æ‰‹' %}category-sports{% elif patient.gender == 'ç”·æ€§' or patient.gender == 'male' or patient.gender == 'ç”·' %}gender-male{% elif patient.gender == 'å¥³æ€§' or patient.gender == 'female' or patient.gender == 'å¥³' %}gender-female{% else %}gender-other{% endif %}" data-name="{{ patient.name }}" data-kana="{{ patient.kana }}">
    <div class="admin-karte-head">
      <strong class="admin-karte-name">{{ patient.name }}</strong>
    </div>
    
    <div class="admin-karte-info">
      <p class="admin-karte-field">
        <span class="admin-karte-label">ãƒ•ãƒªã‚¬ãƒŠï¼š</span>
        <span>{{ patient.kana }}</span>
      </p>
      
      <p class="admin-karte-field">
        <span class="admin-karte-label">å¹´é½¢ï¼š</span>
        <span>{{ patient.birthday | age_from_birthday if patient.birthday else 'æœªå…¥åŠ›' }}æ­³</span>
      </p>
      
      <p class="admin-karte-field">
        <span class="admin-karte-label">åŒºåˆ†ï¼š</span>
        <span>
          {% if patient.category == 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ' %}
            ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ»ã‚¿ãƒ¬ãƒ³ãƒˆ
          {% else %}
            {{ patient.category or 'æœªè¨­å®š' }}
          {% endif %}
        </span>
      </p>

      <p class="admin-karte-field">
        <span class="admin-karte-label">ç´¹ä»‹è€…ï¼š</span>
        {% if patient.introducer_info %}
          <span class="admin-karte-introducer-text" onclick="event.stopPropagation(); window.location.href='/admin/karte/{{ patient.introducer_info.id }}';">
            {{ patient.introducer_info.last_name or '' }} {{ patient.introducer_info.first_name or '' }}
            ï¼ˆ{{ patient.introducer_info.last_kana or '' }} {{ patient.introducer_info.first_kana or '' }}ï¼‰
          </span>
          {% if patient.introducer_info.introduced_count and patient.introducer_info.introduced_count > 0 %}
            <span class="admin-introducer-badge">{{ patient.introducer_info.introduced_count }}</span>
          {% endif %}
        {% else %}
          <span>ãªã—</span>
        {% endif %}
      </p>
      
      <p class="admin-karte-field">
        <span class="admin-karte-label">æœ€çµ‚æ¥é™¢æ—¥ï¼š</span>
        <span>{{ patient.last_visit_date if patient.last_visit_date else 'æœªè¨˜éŒ²' }}</span>
      </p>
    </div>
  </a>
  {% endfor %}
</div>
{% else %}
<p>æ‚£è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¿ãƒ–ã®åˆ‡æ›¿
  function switchRankingTab(tabType) {
    const introducerTab = document.getElementById('introducer-ranking-toggle');
    const reservationTab = document.getElementById('reservation-ranking-toggle');
    const introducerContent = document.getElementById('introducer-ranking-content');
    const reservationContent = document.getElementById('reservation-ranking-content');
    
    if (tabType === 'introducer') {
      if (introducerContent) introducerContent.style.display = 'block';
      if (reservationContent) reservationContent.style.display = 'none';
      if (introducerTab) introducerTab.classList.add('active');
      if (reservationTab) reservationTab.classList.remove('active');
    } else if (tabType === 'reservation') {
      if (introducerContent) introducerContent.style.display = 'none';
      if (reservationContent) reservationContent.style.display = 'block';
      if (introducerTab) introducerTab.classList.remove('active');
      if (reservationTab) reservationTab.classList.add('active');
    }
  }
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
  window.switchRankingTab = switchRankingTab;
  
  // åå‰æ¤œç´¢
  const searchInput = document.getElementById('karte-search');
  const grid = document.getElementById('karte-grid');
  const cards = grid ? Array.from(grid.querySelectorAll('.admin-karte-card')) : [];
  
  searchInput.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase().trim();
    
    cards.forEach(card => {
      const name = card.getAttribute('data-name') || '';
      const kana = card.getAttribute('data-kana') || '';
      const searchText = (name + ' ' + kana).toLowerCase();
      
      if (searchText.includes(query)) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });
  });
});
</script>

{% endblock %}
