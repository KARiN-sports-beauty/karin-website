{% extends "base.html" %}
{% block title %}æ–°è¦äºˆç´„ä½œæˆ | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">â• æ–°è¦äºˆç´„ä½œæˆ</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<form method="POST" action="/admin/reservations/new" style="max-width: 800px;">
  <!-- æ‚£è€…é¸æŠæ–¹å¼ -->
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 12px; font-weight: 600; color: #1E3A5F;">æ‚£è€…é¸æŠ</label>
    <div style="display: flex; gap: 20px; margin-bottom: 16px;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="patient_mode" value="existing" id="patient_mode_existing" checked onchange="togglePatientMode()">
        <span>æ—¢å­˜æ‚£è€…ã‚’é¸æŠ</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="patient_mode" value="new" id="patient_mode_new" onchange="togglePatientMode()">
        <span>æ–°è¦æ‚£è€…ã‚’ä½œæˆ</span>
      </label>
    </div>
    
    <!-- æ—¢å­˜æ‚£è€…é¸æŠï¼ˆautocompleteæ–¹å¼ï¼‰ -->
    <div id="existing_patient_section">
      <input
        type="text"
        id="patient_search"
        class="admin-form-input"
        placeholder="åå‰ãƒ»ãƒ•ãƒªã‚¬ãƒŠã§æ¤œç´¢"
        autocomplete="off"
        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;"
      >
      <div id="patient_results" class="admin-autocomplete-list"></div>
      <input type="hidden" name="patient_id" id="patient_id">
    </div>
    
    <!-- æ–°è¦æ‚£è€…ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="new_patient_section" style="display: none;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">å§“ï¼ˆå¿…é ˆï¼‰</label>
          <input type="text" name="last_name" id="new_last_name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">åï¼ˆå¿…é ˆï¼‰</label>
          <input type="text" name="first_name" id="new_first_name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">ã‚»ã‚¤ï¼ˆå¿…é ˆï¼‰</label>
          <input type="text" name="last_kana" id="new_last_kana" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">ãƒ¡ã‚¤ï¼ˆå¿…é ˆï¼‰</label>
          <input type="text" name="first_kana" id="new_first_kana" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        </div>
      </div>
      <div style="margin-bottom: 12px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" name="phone" id="new_phone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      </div>
      <div style="margin-bottom: 12px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea name="patient_memo" id="new_patient_memo" rows="2" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;"></textarea>
      </div>
    </div>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">äºˆç´„æ—¥æ™‚</label>
    <input type="datetime-local" name="reserved_at" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ–½è¡“æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
    <select name="duration_minutes" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      <option value="60">60åˆ†</option>
      <option value="90" selected>90åˆ†</option>
      <option value="120">120åˆ†</option>
    </select>
    <input type="number" name="duration_minutes_custom" placeholder="ã¾ãŸã¯æ‰‹å…¥åŠ›ï¼ˆåˆ†ï¼‰" min="15" max="300" step="15" style="width: 100%; margin-top: 8px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
    <small style="color: #666; font-size: 0.85rem;">æ‰‹å…¥åŠ›ã‚’é¸æŠã—ãŸå ´åˆã¯ã€ä¸Šè¨˜ã®é¸æŠã¯ç„¡è¦–ã•ã‚Œã¾ã™</small>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ç¾å ´åŒºåˆ†</label>
    <select name="place_type" id="place_type" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <option value="in_house">é™¢å†…</option>
      <option value="visit">å¾€è¨º</option>
      <option value="field">å¸¯åŒ</option>
    </select>
  </div>
  
  <div style="margin-bottom: 20px; display: none;" id="place_name_wrapper">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ç¾å ´å</label>
    <input type="text" name="place_name" placeholder="ç¾å ´åã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•</label>
    <select name="staff_name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      {% for staff in staff_list %}
        <option value="{{ staff.name }}" {% if staff.name == staff_name %}selected{% endif %}>{{ staff.name }}</option>
      {% endfor %}
    </select>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ãƒ¡ãƒ¢</label>
    <textarea name="memo" rows="3" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;"></textarea>
  </div>
  
  <div style="display: flex; gap: 12px; margin-top: 30px;">
    <button type="submit" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer;">ğŸ’¾ ä¿å­˜</button>
    <a href="/admin/reservations" class="admin-karte-detail-btn-back" style="text-decoration: none; display: inline-block; text-align: center;">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
  </div>
</form>

<script>
// æ‚£è€…é¸æŠæ–¹å¼ã®åˆ‡æ›¿
const allPatients = {{ patients | tojson }};

function togglePatientMode() {
  const existingMode = document.getElementById('patient_mode_existing').checked;
  const existingSection = document.getElementById('existing_patient_section');
  const newSection = document.getElementById('new_patient_section');
  const patientIdInput = document.getElementById('patient_id');
  
  if (existingMode) {
    existingSection.style.display = 'block';
    newSection.style.display = 'none';
    // æ–°è¦æ‚£è€…ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è§£é™¤
    document.getElementById('new_last_name').removeAttribute('required');
    document.getElementById('new_first_name').removeAttribute('required');
    document.getElementById('new_last_kana').removeAttribute('required');
    document.getElementById('new_first_kana').removeAttribute('required');
  } else {
    existingSection.style.display = 'none';
    newSection.style.display = 'block';
    patientIdInput.value = '';
    // æ–°è¦æ‚£è€…ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®š
    document.getElementById('new_last_name').setAttribute('required', 'required');
    document.getElementById('new_first_name').setAttribute('required', 'required');
    document.getElementById('new_last_kana').setAttribute('required', 'required');
    document.getElementById('new_first_kana').setAttribute('required', 'required');
  }
}

// æ—¢å­˜æ‚£è€…æ¤œç´¢ï¼ˆautocompleteæ–¹å¼ï¼‰
const searchInput = document.getElementById('patient_search');
const resultsBox = document.getElementById('patient_results');
const hiddenInput = document.getElementById('patient_id');

if (searchInput && resultsBox && hiddenInput) {
  searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim().toLowerCase();
    resultsBox.innerHTML = '';
    
    if (!q) {
      resultsBox.style.display = 'none';
      hiddenInput.value = '';
      return;
    }
    
    const matched = allPatients.filter(p => {
      const lastName = (p.last_name || '').toLowerCase();
      const firstName = (p.first_name || '').toLowerCase();
      const lastKana = (p.last_kana || '').toLowerCase();
      const firstKana = (p.first_kana || '').toLowerCase();
      const name = (p.name || '').toLowerCase();
      const kana = (p.kana || '').toLowerCase();
      const searchText = `${lastName}${firstName}${lastKana}${firstKana}${name}${kana}`;
      return searchText.includes(q);
    });
    
    matched.forEach(p => {
      const item = document.createElement('div');
      item.className = 'admin-autocomplete-item';
      const text = document.createElement('span');
      const lastName = p.last_name || '';
      const firstName = p.first_name || '';
      const lastKana = p.last_kana || '';
      const firstKana = p.first_kana || '';
      const displayName = `${lastName} ${firstName}`.trim() || p.name || 'ä¸æ˜';
      const displayKana = `${lastKana} ${firstKana}`.trim() || p.kana || '';
      text.textContent = `${displayName}ï¼ˆ${displayKana}ï¼‰`;
      item.appendChild(text);
      
      item.onclick = () => {
        searchInput.value = displayName;
        hiddenInput.value = p.id;
        resultsBox.style.display = 'none';
      };
      
      resultsBox.appendChild(item);
    });
    
    resultsBox.style.display = matched.length ? 'block' : 'none';
  });
  
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
      resultsBox.style.display = 'none';
    }
  });
}

// ç¾å ´åŒºåˆ†ã«å¿œã˜ã¦ç¾å ´åå…¥åŠ›æ¬„ã‚’è¡¨ç¤º/éè¡¨ç¤º
document.getElementById('place_type').addEventListener('change', function() {
  const placeType = this.value;
  const placeNameWrapper = document.getElementById('place_name_wrapper');
  if (placeType === 'visit' || placeType === 'field') {
    placeNameWrapper.style.display = 'block';
  } else {
    placeNameWrapper.style.display = 'none';
  }
});

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
document.querySelector('form').addEventListener('submit', function(e) {
  const existingMode = document.getElementById('patient_mode_existing').checked;
  
  // æ—¢å­˜æ‚£è€…é¸æŠæ™‚ã¯patient_idãŒå¿…è¦
  if (existingMode) {
    const patientId = document.getElementById('patient_id').value;
    if (!patientId) {
      e.preventDefault();
      alert('æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return false;
    }
  }
  
  // æ‰‹å…¥åŠ›ã®æ–½è¡“æ™‚é–“ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰ã€selectã®å€¤ã‚’ä¸Šæ›¸ã
  const customDuration = document.querySelector('input[name="duration_minutes_custom"]').value;
  if (customDuration) {
    const select = document.querySelector('select[name="duration_minutes"]');
    select.value = customDuration;
  }
});
</script>

{% endblock %}
