{% extends "base.html" %}
{% block title %}æ–°è¦äºˆç´„ä½œæˆ | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">â• æ–°è¦äºˆç´„ä½œæˆ</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<form method="POST" action="/admin/reservations/new" id="admin-reservation-form" style="max-width: 800px;">
  <!-- ç¾å ´åŒºåˆ†ï¼ˆæœ€åˆã«é…ç½®ï¼‰ -->
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ç¾å ´åŒºåˆ†ï¼ˆå¿…é ˆï¼‰</label>
    <select name="place_type" id="place_type" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;" onchange="updatePlaceTypeFields()">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <option value="in_house">é™¢å†…</option>
      <option value="visit">å¾€è¨º</option>
      <option value="field">å¸¯åŒ</option>
    </select>
  </div>
  
  <!-- æ‚£è€…é¸æŠæ–¹å¼ -->
  <div id="patient_selection_section" style="margin-bottom: 20px; display: none;">
    <label class="form-field" style="display: block; margin-bottom: 12px; font-weight: 600; color: #1E3A5F;">æ‚£è€…é¸æŠ</label>
    <div style="display: flex; gap: 20px; margin-bottom: 16px;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="patient_mode" value="existing" id="patient_mode_existing" checked onchange="togglePatientMode()">
        <span>æ—¢å­˜æ‚£è€…ã‚’é¸æŠ</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="patient_mode" value="new" id="patient_mode_new" onchange="togglePatientMode()">
        <span>æ–°è¦æ‚£è€…ã‚’ä½œæˆ</span>
      </label>
    </div>
    
    <!-- æ—¢å­˜æ‚£è€…é¸æŠï¼ˆautocompleteæ–¹å¼ï¼‰ -->
    <div id="existing_patient_section">
      <input
        type="text"
        id="patient_search"
        class="admin-form-input"
        placeholder="åå‰ãƒ»ãƒ•ãƒªã‚¬ãƒŠã§æ¤œç´¢ã—ã¦æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„"
        autocomplete="off"
        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;"
      >
      <div id="patient_results" class="admin-autocomplete-list"></div>
      <input type="hidden" name="patient_id" id="patient_id">
      <small id="patient_selected_hint" style="display: none; color: #4CAF50; font-size: 0.85rem; margin-top: 4px;">âœ“ æ‚£è€…ãŒé¸æŠã•ã‚Œã¾ã—ãŸ</small>
    </div>
    
    <!-- æ–°è¦æ‚£è€…ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
    <div id="new_patient_section" style="display: none;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 12px;">
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">å§“ï¼ˆå¿…é ˆï¼‰</label>
          <input type="text" name="last_name" id="new_last_name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">åï¼ˆå¿…é ˆï¼‰</label>
          <input type="text" name="first_name" id="new_first_name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 12px;">
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">ã‚»ã‚¤ï¼ˆå¿…é ˆï¼‰</label>
          <input type="text" name="last_kana" id="new_last_kana" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">ãƒ¡ã‚¤ï¼ˆå¿…é ˆï¼‰</label>
          <input type="text" name="first_kana" id="new_first_kana" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        </div>
      </div>
      <div style="margin-bottom: 12px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" name="phone" id="new_phone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      </div>
      <div style="margin-bottom: 12px;">
        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #1E3A5F;">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea name="patient_memo" id="new_patient_memo" rows="2" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;"></textarea>
      </div>
    </div>
  </div>
  
  <div id="reservation_datetime_section" style="margin-bottom: 20px; display: none;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">äºˆç´„æ—¥æ™‚</label>
    <input type="datetime-local" name="reserved_at" id="reserved_at" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;" {% if initial_date %}value="{{ initial_date }}"{% endif %}>
  </div>
  
  <div id="area_section" style="margin-bottom: 20px; display: none;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ã‚¨ãƒªã‚¢ï¼ˆå¿…é ˆï¼‰</label>
    <select name="area" id="area" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      <option value="tokyo">æ±äº¬</option>
      <option value="fukuoka">ç¦å²¡</option>
    </select>
  </div>
  
  <div id="menu_section" style="margin-bottom: 20px; display: none;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå¿…é ˆãƒ»è¤‡æ•°é¸æŠå¯ï¼‰</label>
    <select name="menu" id="menu" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      <option value="">ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
    </select>
    <small style="color: #666; font-size: 0.85rem; display: block; margin-top: 4px;">åŸºæœ¬ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
  </div>
  
  <!-- è¿½åŠ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆæœ¬æŒ‡åãƒ»æ æŒ‡åãƒ»å‰²å¼•ãƒ»å‡ºå¼µè²»ï¼‰ -->
  <div id="additional_menu_section" style="margin-bottom: 20px; padding: 16px; background: #f5f7fb; border-radius: 8px; display: none;">
    <label class="form-field" style="display: block; margin-bottom: 12px; font-weight: 600; color: #1E3A5F;">è¿½åŠ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
    <div style="display: flex; flex-direction: column; gap: 8px;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" name="selected_menus" value="æœ¬æŒ‡å(Â¥1,000)" id="menu_main_nomination" onchange="updateNominationFee()">
        <span>æœ¬æŒ‡å(Â¥1,000)</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" name="selected_menus" value="æ æŒ‡å(Â¥500)" id="menu_frame_nomination" onchange="updateNominationFee()">
        <span>æ æŒ‡å(Â¥500)</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" name="selected_menus" value="å‰²å¼•(â–³Â¥1,000)" id="menu_discount_1000" onchange="updateDiscount()">
        <span>å‰²å¼•(â–³Â¥1,000)</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" name="selected_menus" value="å‰²å¼•(â–³Â¥500)" id="menu_discount_500" onchange="updateDiscount()">
        <span>å‰²å¼•(â–³Â¥500)</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" name="selected_menus" value="åˆå›ä½“é¨“å‰²å¼•ï¼ˆ60åˆ†ï¼š30%OFFï¼‰" id="menu_first_time_discount" onchange="updateFirstTimeDiscount()">
        <span>åˆå›ä½“é¨“å‰²å¼•ï¼ˆ60åˆ†ï¼š30%OFFï¼‰</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" name="selected_menus" value="æ–½è¡“å‰²å¼•" id="menu_treatment_discount" onchange="updateTreatmentDiscount()">
        <span>æ–½è¡“å‰²å¼•ï¼ˆæ‰‹å…¥åŠ›ï¼‰</span>
      </label>
    </div>
    <div id="treatment_discount_input_wrapper" style="margin-top: 12px; display: none;">
      <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ–½è¡“å‰²å¼•é¡ï¼ˆå††ï¼‰</label>
      <input type="number" id="treatment_discount_amount" name="treatment_discount_amount" min="0" step="100" placeholder="å‰²å¼•é¡ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;" onchange="updateTreatmentDiscount()">
    </div>
    <div style="margin-top: 12px;">
      <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">å‡ºå¼µè²»</label>
      <select name="transportation_fee" id="transportation_fee" onchange="updateTotalPrice()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
        <option value="0">å‡ºå¼µè²»ãªã—</option>
        <option value="1000">Â¥1,000</option>
        <option value="2000">Â¥2,000</option>
        <option value="3000">Â¥3,000</option>
        <option value="other">ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰</option>
      </select>
      <input type="number" id="transportation_fee_other" name="transportation_fee_other" min="0" step="100" placeholder="é‡‘é¡ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; margin-top: 8px; display: none;" onchange="updateTotalPrice()">
    </div>
    <input type="hidden" name="nomination_fee" id="nomination_fee" value="0">
    <input type="hidden" name="discount" id="discount" value="0">
  </div>
  
  <div style="margin-bottom: 20px; display: none;" id="place_name_wrapper">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ç¾å ´å</label>
    <input type="text" name="place_name" placeholder="ç¾å ´åã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æŒ‡åã‚¿ã‚¤ãƒ—ï¼ˆå¿…é ˆï¼‰</label>
    <div style="display: flex; flex-direction: column; gap: 8px;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="nomination_type" value="æœ¬æŒ‡å" checked onchange="updateNominationUI()">
        <span>æœ¬æŒ‡å</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="nomination_type" value="æ æŒ‡å" onchange="updateNominationUI()">
        <span>æ æŒ‡åï¼ˆå…¨ã‚¹ã‚¿ãƒƒãƒ•é¸æŠå¯èƒ½ï¼‰</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="nomination_type" value="å¸Œæœ›" onchange="updateNominationUI()">
        <span>å¸Œæœ›</span>
      </label>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="radio" name="nomination_type" value="ãƒ•ãƒªãƒ¼" onchange="updateNominationUI()">
        <span>ãƒ•ãƒªãƒ¼</span>
      </label>
    </div>
  </div>
  
  <!-- æ æŒ‡åç”¨ã®ã‚¹ã‚¿ãƒƒãƒ•é¸æŠï¼ˆæœ€å¤§3åï¼‰ -->
  <div id="frame_nomination_section" style="margin-bottom: 20px; display: none;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æŒ‡åã‚¹ã‚¿ãƒƒãƒ•ï¼ˆæœ€å¤§3åï¼‰</label>
    <div id="frame_staff_list" style="display: flex; flex-direction: column; gap: 8px;">
      <!-- JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
    </div>
    <button type="button" id="add_frame_staff_btn" style="margin-top: 8px; padding: 6px 12px; background: #1E3A5F; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">â• ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ </button>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•</label>
    <select name="staff_name" id="staff_name" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
      {% for staff in staff_list %}
        <option value="{{ staff.name }}" {% if staff.name == staff_name %}selected{% endif %}>{{ staff.name }}</option>
      {% endfor %}
    </select>
  </div>
  
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ–™é‡‘ï¼ˆç¨æŠœããƒ»å††ï¼‰</label>
    <input type="number" name="base_price" id="base_price" min="0" step="100" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
    <small style="color: #666; font-size: 0.85rem;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠã§è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼ˆç·¨é›†å¯ï¼‰</small>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">æ¶ˆè²»ç¨ï¼ˆå††ï¼‰</label>
    <input type="number" name="tax" id="tax" min="0" step="1" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: #f5f5f5;">
    <small style="color: #666; font-size: 0.85rem;">æ–™é‡‘ã®10%ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</small>
  </div>
  
  <div style="margin-bottom: 20px; padding: 12px; background: #f5f7fb; border-radius: 8px;">
    <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #1E3A5F;">
      <span>åˆè¨ˆé‡‘é¡ï¼ˆç¨è¾¼ï¼‰:</span>
      <span id="total_price_display" style="font-size: 1.2rem;">Â¥0</span>
    </div>
  </div>
  
  <div style="margin-bottom: 20px;">
    <label class="form-field" style="display: block; margin-bottom: 6px; font-weight: 600; color: #1E3A5F;">ãƒ¡ãƒ¢</label>
    <textarea name="memo" rows="3" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;"></textarea>
  </div>
  
  <div style="display: flex; gap: 12px; margin-top: 30px;">
    <button type="submit" class="admin-karte-detail-btn-primary" style="border: none; cursor: pointer;">ğŸ’¾ ä¿å­˜</button>
    <a href="/admin/reservations" class="admin-karte-detail-btn-back" style="text-decoration: none; display: inline-block; text-align: center;">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
  </div>
</form>

<script>
// æ‚£è€…é¸æŠæ–¹å¼ã®åˆ‡æ›¿
const allPatients = {{ patients | tojson }};

function togglePatientMode() {
  const existingMode = document.getElementById('patient_mode_existing').checked;
  const existingSection = document.getElementById('existing_patient_section');
  const newSection = document.getElementById('new_patient_section');
  const patientIdInput = document.getElementById('patient_id');
  
  const newLastName = document.getElementById('new_last_name');
  const newFirstName = document.getElementById('new_first_name');
  const newLastKana = document.getElementById('new_last_kana');
  const newFirstKana = document.getElementById('new_first_kana');
  
  if (existingMode) {
    existingSection.style.display = 'block';
    newSection.style.display = 'none';
    // æ–°è¦æ‚£è€…ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è§£é™¤ã—ã€å€¤ã‚’ã‚¯ãƒªã‚¢
    newLastName.removeAttribute('required');
    newFirstName.removeAttribute('required');
    newLastKana.removeAttribute('required');
    newFirstKana.removeAttribute('required');
    newLastName.value = '';
    newFirstName.value = '';
    newLastKana.value = '';
    newFirstKana.value = '';
  } else {
    existingSection.style.display = 'block'; // ä¸€æ—¦è¡¨ç¤ºã—ã¦ã‹ã‚‰requiredã‚’è¨­å®š
    newSection.style.display = 'block';
    patientIdInput.value = '';
    // æ–°è¦æ‚£è€…ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šï¼ˆè¡¨ç¤ºå¾Œã«è¨­å®šã™ã‚‹ã“ã¨ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ï¼‰
    setTimeout(() => {
      newLastName.setAttribute('required', 'required');
      newFirstName.setAttribute('required', 'required');
      newLastKana.setAttribute('required', 'required');
      newFirstKana.setAttribute('required', 'required');
    }, 0);
  }
}

// æ—¢å­˜æ‚£è€…æ¤œç´¢ï¼ˆautocompleteæ–¹å¼ï¼‰
const searchInput = document.getElementById('patient_search');
const resultsBox = document.getElementById('patient_results');
const hiddenInput = document.getElementById('patient_id');

if (searchInput && resultsBox && hiddenInput) {
  searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim().toLowerCase();
    resultsBox.innerHTML = '';
    
    if (!q) {
      resultsBox.style.display = 'none';
      hiddenInput.value = '';
      return;
    }
    
    const matched = allPatients.filter(p => {
      const lastName = (p.last_name || '').toLowerCase();
      const firstName = (p.first_name || '').toLowerCase();
      const lastKana = (p.last_kana || '').toLowerCase();
      const firstKana = (p.first_kana || '').toLowerCase();
      const name = (p.name || '').toLowerCase();
      const kana = (p.kana || '').toLowerCase();
      const searchText = `${lastName}${firstName}${lastKana}${firstKana}${name}${kana}`;
      return searchText.includes(q);
    });
    
    matched.forEach(p => {
      const item = document.createElement('div');
      item.className = 'admin-autocomplete-item';
      const text = document.createElement('span');
      const lastName = p.last_name || '';
      const firstName = p.first_name || '';
      const lastKana = p.last_kana || '';
      const firstKana = p.first_kana || '';
      const birthday = p.birthday || 'ç”Ÿå¹´æœˆæ—¥ä¸æ˜';
      
      // ç´¹ä»‹è€…è¡¨ç¤ºï¼šintroduced_by_patient_idãŒã‚ã‚Œã°ç´¹ä»‹è€…ã®å§“åã€ãªã‘ã‚Œã°æ‰‹æ›¸ãã®introducer
      let introducerDisplay = 'ç´¹ä»‹è€…ãªã—';
      if (p.introducer_info) {
        const introLastName = p.introducer_info.last_name || '';
        const introFirstName = p.introducer_info.first_name || '';
        introducerDisplay = `${introLastName} ${introFirstName}`.trim() || 'ç´¹ä»‹è€…ä¸æ˜';
      } else if (p.introducer) {
        introducerDisplay = p.introducer; // æ‰‹æ›¸ãã®ç´¹ä»‹è€…
      }
      
      // ã‚«ãƒ«ãƒ†ã®ç´¹ä»‹è€…å…¥åŠ›ã¨åŒã˜å½¢å¼ã§è¡¨ç¤º
      text.textContent = `${lastName} ${firstName}ï¼ˆ${lastKana} ${firstKana}ï¼‰ï½œ${birthday}ï½œ${introducerDisplay}`;
      item.appendChild(text);
      
      item.onclick = () => {
        const displayName = `${lastName} ${firstName}`.trim() || p.name || 'ä¸æ˜';
        searchInput.value = displayName;
        hiddenInput.value = p.id;
        resultsBox.style.display = 'none';
        // é¸æŠã•ã‚ŒãŸã“ã¨ã‚’è¦–è¦šçš„ã«è¡¨ç¤º
        const hint = document.getElementById('patient_selected_hint');
        if (hint) {
          hint.style.display = 'block';
          hint.textContent = `âœ“ æ‚£è€…ãŒé¸æŠã•ã‚Œã¾ã—ãŸ: ${displayName}`;
        }
        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
        console.log('æ‚£è€…ã‚’é¸æŠã—ã¾ã—ãŸ:', p.id, displayName);
      };
      
      resultsBox.appendChild(item);
    });
    
    resultsBox.style.display = matched.length ? 'block' : 'none';
  });
  
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
      resultsBox.style.display = 'none';
    }
  });
}

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼å®šç¾©ï¼ˆã‚¨ãƒªã‚¢åˆ¥ãƒ»æ™‚é–“åˆ¥ãƒ»ç¨æŠœãä¾¡æ ¼ï¼‰
const menuPrices = {
  tokyo: {
    60: 10000,  // ç¨æŠœã
    90: 15000,  // ç¨æŠœã
    120: 20000  // ç¨æŠœã
  },
  fukuoka: {
    60: 8000,   // ç¨æŠœã
    90: 12000,  // ç¨æŠœã
    120: 16000  // ç¨æŠœã
  }
};

// ã‚¨ãƒªã‚¢å¤‰æ›´æ™‚ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°
document.getElementById('area').addEventListener('change', function() {
  const area = this.value;
  const menuSelect = document.getElementById('menu');
  const placeTypeSelect = document.getElementById('place_type');
  const placeType = placeTypeSelect ? placeTypeSelect.value : '';
  
  menuSelect.innerHTML = '<option value="">ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
  
  // å¸¯åŒã®å ´åˆã¯ã€Œãã®ä»–ã€ã‚’è¿½åŠ 
  if (placeType === 'field') {
    const otherOption = document.createElement('option');
    otherOption.value = 'other';
    otherOption.textContent = 'ãã®ä»–ï¼ˆå¸¯åŒï¼‰';
    otherOption.dataset.price = '';
    menuSelect.appendChild(otherOption);
  }
  
  if (area && menuPrices[area]) {
    const prices = menuPrices[area];
    for (const [minutes, price] of Object.entries(prices)) {
      const option = document.createElement('option');
      option.value = minutes;
      // ç¨è¾¼ä¾¡æ ¼ã‚’è¡¨ç¤ºï¼ˆç¨æŠœãä¾¡æ ¼ Ã— 1.1ï¼‰
      const priceWithTax = Math.floor(price * 1.1);
      option.textContent = `${minutes}åˆ†ã‚³ãƒ¼ã‚¹ï¼ˆÂ¥${priceWithTax.toLocaleString()}ç¨è¾¼ï¼‰`;
      option.dataset.price = price; // ç¨æŠœãä¾¡æ ¼ã‚’ä¿å­˜
      menuSelect.appendChild(option);
    }
  }
  
  updatePrice();
});

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠæ™‚ã«ä¾¡æ ¼ã‚’è‡ªå‹•å…¥åŠ›
document.getElementById('menu').addEventListener('change', function() {
  updatePrice();
  // åˆå›ä½“é¨“å‰²å¼•ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å†è¨ˆç®—
  const firstTimeDiscount = document.getElementById('menu_first_time_discount');
  if (firstTimeDiscount && firstTimeDiscount.checked) {
    updateFirstTimeDiscount();
    }
});

// ç¾å ´åŒºåˆ†å¤‰æ›´æ™‚ã®å‡¦ç†ã¯updatePlaceTypeFields()ã«çµ±åˆ

// ä¾¡æ ¼æ›´æ–°é–¢æ•°
function updatePrice() {
  const area = document.getElementById('area').value;
  const menuSelect = document.getElementById('menu');
  const basePriceInput = document.getElementById('base_price');
  const placeType = document.getElementById('place_type').value;
  
  if (menuSelect.value) {
    const selectedOption = menuSelect.options[menuSelect.selectedIndex];
    if (selectedOption && selectedOption.dataset.price) {
      // ç¨æŠœãä¾¡æ ¼ã‚’è¨­å®šï¼ˆdataset.priceã¯æ—¢ã«ç¨æŠœãä¾¡æ ¼ï¼‰
      const priceWithoutTax = parseInt(selectedOption.dataset.price);
      basePriceInput.value = priceWithoutTax;
    } else if (selectedOption && selectedOption.value === 'other') {
      // ã€Œãã®ä»–ï¼ˆå¸¯åŒï¼‰ã€ã®å ´åˆã¯50000å††ï¼ˆç¨æŠœãï¼‰
      if (placeType === 'field') {
        basePriceInput.value = 50000;
      } else {
        basePriceInput.value = '';
      }
    } else {
      basePriceInput.value = '';
    }
  } else {
    basePriceInput.value = '';
  }
  
  // æŒ‡åæ–™ã¨å‰²å¼•ã‚’å†è¨ˆç®—
  updateNominationFee();
  updateDiscount();
  updateTotalPrice();
}

// åˆè¨ˆé‡‘é¡æ›´æ–°é–¢æ•°ï¼ˆæ–™é‡‘ã€å‡ºå¼µè²»ã€æŒ‡åæ–™ã€æ¶ˆè²»ç¨ã€å‰²å¼•ã‚’è€ƒæ…®ï¼‰
function updateTotalPrice() {
  const basePrice = parseInt(document.getElementById('base_price').value) || 0;
  const transportationFeeSelect = document.getElementById('transportation_fee');
  const transportationFeeOther = document.getElementById('transportation_fee_other');
  let transportationFee = 0;
  
  if (transportationFeeSelect.value === 'other') {
    transportationFee = parseInt(transportationFeeOther.value) || 0;
  } else {
    transportationFee = parseInt(transportationFeeSelect.value) || 0;
  }
  
  const nominationFee = parseInt(document.getElementById('nomination_fee').value) || 0;
  const discount = parseInt(document.getElementById('discount').value) || 0;
  
  // æ¶ˆè²»ç¨ = æ–™é‡‘ Ã— 0.1ï¼ˆæŒ‡åæ–™ã¨å‡ºå¼µè²»ã«ã¯ã‹ã‹ã‚‰ãªã„ï¼‰
  const tax = Math.floor(basePrice * 0.1);
  
  // ç¨è¾¼åˆè¨ˆ = æ–™é‡‘ + å‡ºå¼µè²» + æŒ‡åæ–™ - å‰²å¼• + æ¶ˆè²»ç¨
  const totalWithTax = basePrice + transportationFee + nominationFee - discount + tax;
  
  // æ¶ˆè²»ç¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
  document.getElementById('tax').value = tax;
  
  // åˆè¨ˆé‡‘é¡è¡¨ç¤ºã‚’æ›´æ–°
  document.getElementById('total_price_display').textContent = 'Â¥' + totalWithTax.toLocaleString();
}

// æ–™é‡‘ã€å‡ºå¼µè²»ã€æŒ‡åæ–™ã€å‰²å¼•ã®å¤‰æ›´æ™‚ã«åˆè¨ˆã‚’æ›´æ–°
document.getElementById('base_price').addEventListener('input', function() {
  // åˆå›ä½“é¨“å‰²å¼•ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å†è¨ˆç®—
  const firstTimeDiscount = document.getElementById('menu_first_time_discount');
  if (firstTimeDiscount && firstTimeDiscount.checked) {
    updateFirstTimeDiscount();
  } else {
    updateTotalPrice();
  }
});
document.getElementById('transportation_fee').addEventListener('change', function() {
  const transportationFeeOther = document.getElementById('transportation_fee_other');
  if (this.value === 'other') {
    transportationFeeOther.style.display = 'block';
    transportationFeeOther.setAttribute('required', 'required');
  } else {
    transportationFeeOther.style.display = 'none';
    transportationFeeOther.removeAttribute('required');
    transportationFeeOther.value = '';
  }
  updateTotalPrice();
});
document.getElementById('transportation_fee_other').addEventListener('input', updateTotalPrice);

// æŒ‡åæ–™æ›´æ–°é–¢æ•°
function updateNominationFee() {
  const mainNomination = document.getElementById('menu_main_nomination');
  const frameNomination = document.getElementById('menu_frame_nomination');
  const nominationFeeInput = document.getElementById('nomination_fee');
  const placeType = document.getElementById('place_type').value;
  
  let fee = 0;
  if (mainNomination && mainNomination.checked) {
    // å¸¯åŒã®å ´åˆã¯10000å††ã€ãã‚Œä»¥å¤–ã¯1000å††
    fee += (placeType === 'field') ? 10000 : 1000;
  }
  if (frameNomination && frameNomination.checked) {
    // å¸¯åŒã®å ´åˆã¯5000å††ã€ãã‚Œä»¥å¤–ã¯500å††
    fee += (placeType === 'field') ? 5000 : 500;
  }
  
  if (nominationFeeInput) {
    nominationFeeInput.value = fee;
  }
  
  updateTotalPrice();
}

// å‰²å¼•æ›´æ–°é–¢æ•°
function updateDiscount() {
  const discount1000 = document.getElementById('menu_discount_1000');
  const discount500 = document.getElementById('menu_discount_500');
  const firstTimeDiscount = document.getElementById('menu_first_time_discount');
  const treatmentDiscount = document.getElementById('menu_treatment_discount');
  const discountInput = document.getElementById('discount');
  
  // åˆå›ä½“é¨“å‰²å¼•ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ä»–ã®å‰²å¼•ã‚’ç„¡åŠ¹åŒ–
  if (firstTimeDiscount && firstTimeDiscount.checked) {
    if (discount1000) discount1000.checked = false;
    if (discount500) discount500.checked = false;
    if (treatmentDiscount) treatmentDiscount.checked = false;
    const treatmentDiscountInputWrapper = document.getElementById('treatment_discount_input_wrapper');
    if (treatmentDiscountInputWrapper) treatmentDiscountInputWrapper.style.display = 'none';
    updateFirstTimeDiscount();
    return;
  }
  
  // æ–½è¡“å‰²å¼•ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ä»–ã®å‰²å¼•ã‚’ç„¡åŠ¹åŒ–
  if (treatmentDiscount && treatmentDiscount.checked) {
    if (discount1000) discount1000.checked = false;
    if (discount500) discount500.checked = false;
    updateTreatmentDiscount();
    return;
  }
  
  let discount = 0;
  if (discount1000 && discount1000.checked) {
    discount += 1000;
  }
  if (discount500 && discount500.checked) {
    discount += 500;
  }
  
  if (discountInput) {
    discountInput.value = discount;
  }
  
  updateTotalPrice();
}

// åˆå›ä½“é¨“å‰²å¼•æ›´æ–°é–¢æ•°
function updateFirstTimeDiscount() {
  const firstTimeDiscount = document.getElementById('menu_first_time_discount');
  const discountInput = document.getElementById('discount');
  const basePriceInput = document.getElementById('base_price');
  const discount1000 = document.getElementById('menu_discount_1000');
  const discount500 = document.getElementById('menu_discount_500');
  const treatmentDiscount = document.getElementById('menu_treatment_discount');
  
  if (firstTimeDiscount && firstTimeDiscount.checked) {
    // ä»–ã®å‰²å¼•ã‚’ç„¡åŠ¹åŒ–
    if (discount1000) discount1000.checked = false;
    if (discount500) discount500.checked = false;
    if (treatmentDiscount) treatmentDiscount.checked = false;
    const treatmentDiscountInputWrapper = document.getElementById('treatment_discount_input_wrapper');
    if (treatmentDiscountInputWrapper) treatmentDiscountInputWrapper.style.display = 'none';
    
    // base_priceã®30%ã‚’è¨ˆç®—
    const basePrice = parseInt(basePriceInput.value) || 0;
    const discount = Math.floor(basePrice * 0.3);
    
    if (discountInput) {
      discountInput.value = discount;
    }
  } else {
    // åˆå›ä½“é¨“å‰²å¼•ãŒå¤–ã‚ŒãŸå ´åˆã¯ã€ä»–ã®å‰²å¼•ã‚’å†è¨ˆç®—
    updateDiscount();
    return;
  }
  
  updateTotalPrice();
}

// æ–½è¡“å‰²å¼•æ›´æ–°é–¢æ•°
function updateTreatmentDiscount() {
  const treatmentDiscount = document.getElementById('menu_treatment_discount');
  const discountInput = document.getElementById('discount');
  const treatmentDiscountAmount = document.getElementById('treatment_discount_amount');
  const treatmentDiscountInputWrapper = document.getElementById('treatment_discount_input_wrapper');
  const discount1000 = document.getElementById('menu_discount_1000');
  const discount500 = document.getElementById('menu_discount_500');
  const firstTimeDiscount = document.getElementById('menu_first_time_discount');
  
  if (treatmentDiscount && treatmentDiscount.checked) {
    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
    if (treatmentDiscountInputWrapper) {
      treatmentDiscountInputWrapper.style.display = 'block';
    }
    
    // ä»–ã®å‰²å¼•ã‚’ç„¡åŠ¹åŒ–
    if (discount1000) discount1000.checked = false;
    if (discount500) discount500.checked = false;
    if (firstTimeDiscount) firstTimeDiscount.checked = false;
    
    // å…¥åŠ›ã•ã‚ŒãŸé‡‘é¡ã‚’discountã«è¨­å®š
    const discount = parseInt(treatmentDiscountAmount.value) || 0;
    if (discountInput) {
      discountInput.value = discount;
    }
  } else {
    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå¤–ã‚ŒãŸå ´åˆã¯ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤º
    if (treatmentDiscountInputWrapper) {
      treatmentDiscountInputWrapper.style.display = 'none';
    }
    if (treatmentDiscountAmount) {
      treatmentDiscountAmount.value = '';
    }
    
    // ä»–ã®å‰²å¼•ã‚’å†è¨ˆç®—
    updateDiscount();
    return;
  }
  
  updateTotalPrice();
}

// æŒ‡åã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®UIæ›´æ–°
function updateNominationUI() {
  const nominationType = document.querySelector('input[name="nomination_type"]:checked').value;
  const frameSection = document.getElementById('frame_nomination_section');
  const staffNameSelect = document.getElementById('staff_name');
  
  if (nominationType === 'æ æŒ‡å') {
    frameSection.style.display = 'block';
    staffNameSelect.removeAttribute('required');
  } else {
    frameSection.style.display = 'none';
    staffNameSelect.setAttribute('required', 'required');
    // æ æŒ‡åã®ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
    document.getElementById('frame_staff_list').innerHTML = '';
  }
}

// æ æŒ‡åã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ 
let frameStaffCount = 0;
const staffList = {{ staff_list | tojson if staff_list else '[]' }};

document.getElementById('add_frame_staff_btn').addEventListener('click', function() {
  frameStaffCount++;
  const container = document.getElementById('frame_staff_list');
  const div = document.createElement('div');
  div.style.cssText = 'display: flex; gap: 8px; align-items: center;';
  div.innerHTML = `
    <select name="frame_staff_${frameStaffCount}" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      ${staffList.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
    </select>
    <select name="frame_priority_${frameStaffCount}" required style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;">
      <option value="1">å„ªå…ˆ1</option>
      <option value="2">å„ªå…ˆ2</option>
      <option value="3">å„ªå…ˆ3</option>
    </select>
    <button type="button" class="remove-frame-staff" style="padding: 6px 12px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">å‰Šé™¤</button>
  `;
  
  container.appendChild(div);
  
  // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  div.querySelector('.remove-frame-staff').addEventListener('click', function() {
    div.remove();
    frameStaffCount--;
  });
});

// ç¾å ´åŒºåˆ†ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º/éè¡¨ç¤º
function updatePlaceTypeFields() {
  const placeType = document.getElementById('place_type').value;
  const patientSection = document.getElementById('patient_selection_section');
  const datetimeSection = document.getElementById('reservation_datetime_section');
  const areaSection = document.getElementById('area_section');
  const menuSection = document.getElementById('menu_section');
  const additionalMenuSection = document.getElementById('additional_menu_section');
  const placeNameWrapper = document.getElementById('place_name_wrapper');
  
  // é™¢å†…/å¾€è¨ºã®å ´åˆï¼šæ‚£è€…é¸æŠä»¥é™ã‚’è¡¨ç¤º
  if (placeType === 'in_house' || placeType === 'visit') {
    if (patientSection) patientSection.style.display = 'block';
    if (datetimeSection) datetimeSection.style.display = 'block';
    if (areaSection) areaSection.style.display = 'block';
    if (menuSection) menuSection.style.display = 'block';
    if (additionalMenuSection) additionalMenuSection.style.display = 'block';
    
    // æ‚£è€…é¸æŠã€äºˆç´„æ—¥æ™‚ã€ã‚¨ãƒªã‚¢ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å¿…é ˆã«
    const patientIdInput = document.getElementById('patient_id');
    const reservedAtInput = document.getElementById('reserved_at');
    const areaSelect = document.getElementById('area');
    const menuSelect = document.getElementById('menu');
    if (patientIdInput) patientIdInput.setAttribute('required', 'required');
    if (reservedAtInput) reservedAtInput.setAttribute('required', 'required');
    if (areaSelect) areaSelect.setAttribute('required', 'required');
    if (menuSelect) menuSelect.setAttribute('required', 'required');
  }
  // å¸¯åŒã®å ´åˆï¼šæ‚£è€…é¸æŠã€œè¿½åŠ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã€ç¾å ´åä»¥é™ã‚’è¡¨ç¤º
  else if (placeType === 'field') {
    if (patientSection) patientSection.style.display = 'none';
    if (datetimeSection) datetimeSection.style.display = 'block'; // äºˆç´„æ—¥æ™‚ã¯å¿…è¦
    if (areaSection) areaSection.style.display = 'none';
    if (menuSection) menuSection.style.display = 'none';
    if (additionalMenuSection) additionalMenuSection.style.display = 'none';
    
    // æ‚£è€…é¸æŠã€ã‚¨ãƒªã‚¢ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å¿…é ˆã‹ã‚‰è§£é™¤
    const patientIdInput = document.getElementById('patient_id');
    const areaSelect = document.getElementById('area');
    const menuSelect = document.getElementById('menu');
    if (patientIdInput) patientIdInput.removeAttribute('required');
    if (areaSelect) areaSelect.removeAttribute('required');
    if (menuSelect) menuSelect.removeAttribute('required');
    
    // äºˆç´„æ—¥æ™‚ã¯å¿…é ˆã®ã¾ã¾
    const reservedAtInput = document.getElementById('reserved_at');
    if (reservedAtInput) reservedAtInput.setAttribute('required', 'required');
  }
  // æœªé¸æŠã®å ´åˆï¼šã™ã¹ã¦éè¡¨ç¤º
  else {
    if (patientSection) patientSection.style.display = 'none';
    if (datetimeSection) datetimeSection.style.display = 'none';
    if (areaSection) areaSection.style.display = 'none';
    if (menuSection) menuSection.style.display = 'none';
    if (additionalMenuSection) additionalMenuSection.style.display = 'none';
  }
  
  // ç¾å ´åã¯å¾€è¨º/å¸¯åŒã®å ´åˆã®ã¿è¡¨ç¤º
  if (placeType === 'visit' || placeType === 'field') {
    placeNameWrapper.style.display = 'block';
  } else {
    placeNameWrapper.style.display = 'none';
  }
  
  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°å‡¦ç†ï¼ˆå¸¯åŒã®å ´åˆã¯ã€Œãã®ä»–ã€ã‚’è¿½åŠ ï¼‰
  const menuSelect = document.getElementById('menu');
  if (menuSelect) {
    if (placeType === 'field') {
      // æ—¢å­˜ã®ã€Œãã®ä»–ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
      const existingOther = Array.from(menuSelect.options).find(opt => opt.value === 'other');
      if (existingOther) {
        existingOther.remove();
      }
      
      // ã€Œãã®ä»–ã€ã‚’å…ˆé ­ã«è¿½åŠ 
      const otherOption = document.createElement('option');
      otherOption.value = 'other';
      otherOption.textContent = 'ãã®ä»–ï¼ˆå¸¯åŒï¼‰';
      otherOption.dataset.price = '';
      menuSelect.insertBefore(otherOption, menuSelect.firstChild.nextSibling);
  } else {
      // å¸¯åŒä»¥å¤–ã®å ´åˆã¯ã€Œãã®ä»–ã€ã‚’å‰Šé™¤
      const existingOther = Array.from(menuSelect.options).find(opt => opt.value === 'other');
      if (existingOther) {
        existingOther.remove();
  }
    }
  }
  
  updatePrice();
  updateTotalPrice();
}

// ç¾å ´åŒºåˆ†å¤‰æ›´æ™‚ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
document.getElementById('place_type').addEventListener('change', function() {
  updatePlaceTypeFields();
});


// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
document.querySelector('form').addEventListener('submit', function(e) {
  console.log('ğŸ” ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é–‹å§‹');
  const existingMode = document.getElementById('patient_mode_existing').checked;
  console.log('ğŸ” æ‚£è€…é¸æŠãƒ¢ãƒ¼ãƒ‰:', existingMode ? 'æ—¢å­˜' : 'æ–°è¦');
  
  // æ—¢å­˜æ‚£è€…é¸æŠæ™‚ã¯patient_idãŒå¿…è¦
  if (existingMode) {
    const patientId = document.getElementById('patient_id').value;
    console.log('ğŸ” patient_id:', patientId);
    if (!patientId) {
      e.preventDefault();
      alert('æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚æ¤œç´¢ã—ã¦æ‚£è€…ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
      document.getElementById('patient_search').focus();
      return false;
    }
  } else {
    // æ–°è¦æ‚£è€…ã®å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
    const lastName = document.getElementById('new_last_name').value.trim();
    const firstName = document.getElementById('new_first_name').value.trim();
    const lastKana = document.getElementById('new_last_kana').value.trim();
    const firstKana = document.getElementById('new_first_kana').value.trim();
    console.log('ğŸ” æ–°è¦æ‚£è€…ãƒ‡ãƒ¼ã‚¿:', {lastName, firstName, lastKana, firstKana});
    
    if (!lastName || !firstName || !lastKana || !firstKana) {
      e.preventDefault();
      alert('å§“ãƒ»åãƒ»ã‚»ã‚¤ãƒ»ãƒ¡ã‚¤ã¯å¿…é ˆã§ã™');
      // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«requiredå±æ€§ã‚’è¨­å®šã—ã¦ã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      document.getElementById('new_last_name').setAttribute('required', 'required');
      document.getElementById('new_first_name').setAttribute('required', 'required');
      document.getElementById('new_last_kana').setAttribute('required', 'required');
      document.getElementById('new_first_kana').setAttribute('required', 'required');
      if (!lastName) document.getElementById('new_last_name').focus();
      else if (!firstName) document.getElementById('new_first_name').focus();
      else if (!lastKana) document.getElementById('new_last_kana').focus();
      else if (!firstKana) document.getElementById('new_first_kana').focus();
      return false;
    }
  }
  
  // äºˆç´„æ—¥æ™‚ã®ãƒã‚§ãƒƒã‚¯
  const reservedAt = document.querySelector('input[name="reserved_at"]').value;
  console.log('ğŸ” äºˆç´„æ—¥æ™‚:', reservedAt);
  if (!reservedAt) {
    e.preventDefault();
    alert('äºˆç´„æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return false;
  }
  
  // ç¾å ´åŒºåˆ†ã®ãƒã‚§ãƒƒã‚¯
  const placeType = document.getElementById('place_type').value;
  console.log('ğŸ” ç¾å ´åŒºåˆ†:', placeType);
  if (!placeType) {
    e.preventDefault();
    alert('ç¾å ´åŒºåˆ†ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return false;
  }
  
  console.log('ğŸ” ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’è¨±å¯');
});
</script>

{% endblock %}
