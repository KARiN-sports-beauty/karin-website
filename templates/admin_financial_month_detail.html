{% extends "base.html" %}
{% block title %}åæ”¯ç®¡ç† - {{ year }}å¹´{{ month_name }} | KARiN.{% endblock %}

{% block content %}
<h2 class="admin-title">ğŸ’° åæ”¯ç®¡ç† - {{ year }}å¹´{{ month_name }}</h2>

{% if get_flashed_messages() %}
  {% for message in get_flashed_messages(with_categories=true) %}
    <div class="admin-alert admin-alert-{{ message[0] }}" style="margin-bottom: 20px; padding: 12px; border-radius: 8px; background: {% if message[0] == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message[0] == 'success' %}#155724{% else %}#721c24{% endif %};">
      {{ message[1] }}
    </div>
  {% endfor %}
{% endif %}

<div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
  <a href="/admin/financial/years/{{ year }}" class="admin-karte-detail-btn-back" style="text-decoration: none;">â† {{ year }}å¹´ã«æˆ»ã‚‹</a>
  <a href="/admin/financial/years/{{ year }}/expenses/new" class="admin-karte-detail-btn-primary" style="text-decoration: none;">â• çµŒè²»è¿½åŠ </a>
</div>

<!-- æœˆæ¬¡åæ”¯ã‚µãƒãƒªãƒ¼ -->
<div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-bottom: 20px;">
  <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">{{ year }}å¹´{{ month_name }} åæ”¯ã‚µãƒãƒªãƒ¼</h3>
  
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
    <div style="padding: 20px; background: #e8f5e9; border-radius: 12px;">
      <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">å£²ä¸Š</div>
      <div style="font-size: 1.8rem; font-weight: 600; color: #2e7d32;">Â¥{{ "{:,}".format(month_revenue|int) }}</div>
    </div>
    <div style="padding: 20px; background: #ffebee; border-radius: 12px;">
      <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">çµŒè²»</div>
      <div style="font-size: 1.8rem; font-weight: 600; color: #c62828;">Â¥{{ "{:,}".format(month_expenses|int) }}</div>
    </div>
    <div style="padding: 20px; background: {% if month_profit >= 0 %}#e8f5e9{% else %}#ffebee{% endif %}; border-radius: 12px;">
      <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">åæ”¯</div>
      <div style="font-size: 1.8rem; font-weight: 600; color: {% if month_profit >= 0 %}#2e7d32{% else %}#c62828{% endif %};">
        Â¥{{ "{:,}".format(month_profit|int) }}
      </div>
    </div>
  </div>
</div>

<!-- ã‚¹ã‚¿ãƒƒãƒ•åˆ¥å£²ä¸Š -->
{% if staff_revenue %}
<div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-bottom: 20px;">
  <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">ã‚¹ã‚¿ãƒƒãƒ•åˆ¥å£²ä¸Š</h3>
  
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f5f7fb;">
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">ã‚¹ã‚¿ãƒƒãƒ•å</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">å£²ä¸Š</th>
        </tr>
      </thead>
      <tbody>
        {% for staff_name, revenue in staff_revenue.items() %}
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ staff_name }}</td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">Â¥{{ "{:,}".format(revenue|int) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- ã‚¹ã‚¿ãƒƒãƒ•çµ¦ä¸ -->
{% if staff_salaries %}
<div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-bottom: 20px;">
  <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">ã‚¹ã‚¿ãƒƒãƒ•çµ¦ä¸</h3>
  
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f5f7fb;">
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">ã‚¹ã‚¿ãƒƒãƒ•å</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">åŸºæœ¬çµ¦</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">æ­©åˆ</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">æŒ‡åæ–™</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">äº¤é€šè²»</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">ç·æ”¯çµ¦</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">æ§é™¤</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">æ‰‹å–ã‚Š</th>
          <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; color: #1E3A5F;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for salary in staff_salaries %}
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ salary.staff_name }}</td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">Â¥{{ "{:,}".format(salary.base_salary|int) }}</td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">Â¥{{ "{:,}".format(salary.commission|int) }}</td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">Â¥{{ "{:,}".format((salary.nomination_fee or 0)|int) }}</td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">Â¥{{ "{:,}".format(salary.transportation|int) }}</td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee; font-weight: 600;">Â¥{{ "{:,}".format(salary.total_salary|int) }}</td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">
            Â¥{{ "{:,}".format((salary.tax + salary.social_insurance + salary.other_deduction)|int) }}
          </td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee; font-weight: 600; color: #2e7d32;">
            Â¥{{ "{:,}".format(salary.net_salary|int) }}
          </td>
          <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
            <a href="/admin/financial/years/{{ year }}/months/{{ month }}/salaries/{{ salary.id }}/edit" style="color: #1E3A5F; text-decoration: none; margin-right: 8px;">âœï¸</a>
            <form method="POST" action="/admin/financial/years/{{ year }}/months/{{ month }}/salaries/{{ salary.id }}/delete" style="display: inline;" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
              <button type="submit" style="background: none; border: none; color: #f44336; cursor: pointer; padding: 0;">ğŸ—‘ï¸</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- çµŒè²»ä¸€è¦§ -->
<div style="padding: 24px; background: #fff; border-radius: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); margin-bottom: 20px;">
  <h3 style="margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 600; color: #1E3A5F;">çµŒè²»ä¸€è¦§</h3>
  
  {% if expenses or equipment_expenses %}
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background: #f5f7fb;">
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">æ—¥ä»˜</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">ã‚«ãƒ†ã‚´ãƒª</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; color: #1E3A5F;">èª¬æ˜</th>
          <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd; color: #1E3A5F;">é‡‘é¡</th>
          <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; color: #1E3A5F;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for expense in expenses %}
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ expense.expense_date }}</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">
            {% set category_names = {
              'salary': 'çµ¦ä¸',
              'transportation': 'æ—…è²»äº¤é€šè²»',
              'travel': 'æ—…è²»äº¤é€šè²»',
              'social_insurance': 'ç¤¾ä¼šä¿é™ºæ–™',
              'rent': 'åœ°ä»£å®¶è³ƒ',
              'utilities': 'å…‰ç†±è²»',
              'communication': 'é€šä¿¡è²»',
              'insurance': 'ä¿é™ºæ–™',
              'lease': 'ãƒªãƒ¼ã‚¹æ–™',
              'tax': 'ç¨é‡‘',
              'accounting': 'çµŒç†ãƒ»ç¨ç†å£«è²»ç”¨',
              'advertising': 'åºƒå‘Šå®£ä¼è²»',
              'promotion': 'ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è²»ç”¨',
              'supplies': 'æ¶ˆè€—å“',
              'equipment': 'å‚™å“ãƒ»æ©Ÿå™¨',
              'office_supplies': 'äº‹å‹™ç”¨å“è²»',
              'repairs': 'ä¿®ç¹•è²»',
              'maintenance': 'ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è²»',
              'meeting': 'ä¼šè­°è²»',
              'entertainment': 'æ¥å¾…è²»',
              'depreciation': 'æ¸›ä¾¡å„Ÿå´è²»',
              'training': 'ç ”ä¿®è²»',
              'subscription': 'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³',
              'software': 'ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ»ã‚·ã‚¹ãƒ†ãƒ è²»ç”¨',
              'other': 'ãã®ä»–'
            } %}
            {{ category_names.get(expense.category, expense.category) }}
          </td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">
            {{ expense.description or '' }}
            {% if expense.staff_name %}({{ expense.staff_name }}){% endif %}
          </td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">Â¥{{ "{:,}".format(expense.amount|int) }}</td>
          <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
            {% if expense.linked_type == 'manual' %}
            <a href="/admin/financial/years/{{ year }}/expenses/{{ expense.id }}/edit" style="color: #1E3A5F; text-decoration: none; margin-right: 8px;">âœï¸</a>
            <form method="POST" action="/admin/financial/years/{{ year }}/expenses/{{ expense.id }}/delete" style="display: inline;" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
              <button type="submit" style="background: none; border: none; color: #f44336; cursor: pointer; padding: 0;">ğŸ—‘ï¸</button>
            </form>
            {% else %}
            <span style="color: #999; font-size: 0.85rem;">è‡ªå‹•</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% for order in equipment_expenses %}
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ order.order_date }}</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">æ¶ˆè€—å“</td>
          <td style="padding: 12px; border-bottom: 1px solid #eee;">
            {% if order.equipment_items %}
              å‚™å“ç™ºæ³¨: {{ order.equipment_items.name }}
            {% else %}
              å‚™å“ç™ºæ³¨
            {% endif %}
          </td>
          <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">Â¥{{ "{:,}".format(order.amount|int) if order.amount else 0 }}</td>
          <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
            <span style="color: #999; font-size: 0.85rem;">è‡ªå‹•</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p style="padding: 20px; color: #666;">çµŒè²»ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}
</div>

{% endblock %}

